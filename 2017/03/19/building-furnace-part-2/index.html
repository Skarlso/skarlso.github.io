<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Furnace - The building of an AWS CLI Tool for CloudFormation and CodeDeploy - Part 2 | Ramblings of a cloud engineer</title>
<meta name="keywords" content="">
<meta name="description" content="Intro Hi folks.
Previously on this blog: Part 1, Part 3, Part 4
In this part, I&rsquo;m going to talk about the AWS Go SDK and begin do dissect the intricacies of Furnace.
AWS SDK Fortunately, the Go SDK for AWS is quiet verbose and littered with examples of all sorts. But that doesn&rsquo;t make it less complex and less cryptic at times. I&rsquo;m here to lift some of the early confusions, in hopes that I can help someone to avoid wasting time.">
<meta name="author" content="hannibal">
<link rel="canonical" href="https://skarlso.github.io/2017/03/19/building-furnace-part-2/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.3613efbd0b1772781e8f49935e973cae632a7f61471c05b17be155505ccf87b5.css" integrity="sha256-NhPvvQsXcngej0mTXpc8rmMqf2FHHAWxe&#43;FVUFzPh7U=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://skarlso.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://skarlso.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://skarlso.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://skarlso.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://skarlso.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Furnace - The building of an AWS CLI Tool for CloudFormation and CodeDeploy - Part 2" />
<meta property="og:description" content="Intro Hi folks.
Previously on this blog: Part 1, Part 3, Part 4
In this part, I&rsquo;m going to talk about the AWS Go SDK and begin do dissect the intricacies of Furnace.
AWS SDK Fortunately, the Go SDK for AWS is quiet verbose and littered with examples of all sorts. But that doesn&rsquo;t make it less complex and less cryptic at times. I&rsquo;m here to lift some of the early confusions, in hopes that I can help someone to avoid wasting time." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://skarlso.github.io/2017/03/19/building-furnace-part-2/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2017-03-19T12:03:00+01:00" />
<meta property="article:modified_time" content="2017-03-19T12:03:00+01:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Furnace - The building of an AWS CLI Tool for CloudFormation and CodeDeploy - Part 2"/>
<meta name="twitter:description" content="Intro Hi folks.
Previously on this blog: Part 1, Part 3, Part 4
In this part, I&rsquo;m going to talk about the AWS Go SDK and begin do dissect the intricacies of Furnace.
AWS SDK Fortunately, the Go SDK for AWS is quiet verbose and littered with examples of all sorts. But that doesn&rsquo;t make it less complex and less cryptic at times. I&rsquo;m here to lift some of the early confusions, in hopes that I can help someone to avoid wasting time."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Posts",
      "item": "https://skarlso.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "Furnace - The building of an AWS CLI Tool for CloudFormation and CodeDeploy - Part 2",
      "item": "https://skarlso.github.io/2017/03/19/building-furnace-part-2/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Furnace - The building of an AWS CLI Tool for CloudFormation and CodeDeploy - Part 2",
  "name": "Furnace - The building of an AWS CLI Tool for CloudFormation and CodeDeploy - Part 2",
  "description": "Intro Hi folks.\nPreviously on this blog: Part 1, Part 3, Part 4\nIn this part, I\u0026rsquo;m going to talk about the AWS Go SDK and begin do dissect the intricacies of Furnace.\nAWS SDK Fortunately, the Go SDK for AWS is quiet verbose and littered with examples of all sorts. But that doesn\u0026rsquo;t make it less complex and less cryptic at times. I\u0026rsquo;m here to lift some of the early confusions, in hopes that I can help someone to avoid wasting time.",
  "keywords": [
    
  ],
  "articleBody": "Intro Hi folks.\nPreviously on this blog: Part 1, Part 3, Part 4\nIn this part, I’m going to talk about the AWS Go SDK and begin do dissect the intricacies of Furnace.\nAWS SDK Fortunately, the Go SDK for AWS is quiet verbose and littered with examples of all sorts. But that doesn’t make it less complex and less cryptic at times. I’m here to lift some of the early confusions, in hopes that I can help someone to avoid wasting time.\nGetting Started and Developers Guide As always, and common from AWS, the documentation is top notch. There is a 141 pages long developer’s guide on the SDK containing a getting started section and an API reference. Go check it out. I’ll wait. AWS Go SDK DG PDF. I will only talk about some gotchas and things I encountered, not the basics of the SDK.\naws.String and other types Something which is immediately visible once we take a look at the API is that everything is a pointer. Now, there are a tremendous amount of discussions about this, but I’m with Amazon. There are various reasons for it, but to list the most prominent ones: - Type completion and compile time type safety. - Values for AWS API calls have valid zero values, in addition to being optional, i.e. not being provided at all. - Other option, like, empty interfaces with maps, or using zero values, or struct wrappers around every type, made life much harder rather than easier or not possible at all. - The AWS API is volatile. You never know when something gets to be optional, or required. Pointers made that decision easy.\nThere are good number of other discussions around this topic, for example: AWS Go GitHub #363.\nIn order to use primitives, AWS has helper functions like aws.String. Because \u0026“asdf” is not allowed, you would have to create a variable and use its address in situations where a string pointer is needed, for example, name of the stack. These primitive helpers will make in-lining possible. We’ll see later that they are used to a great extent. Pointers, however, make life a bit difficult when constructing Input structs and make for poor aesthetics.\nThis is something I’m returning in a test for stubbing a client call:\nreturn \u0026cloudformation.ListStackResourcesOutput{ StackResourceSummaries: []*cloudformation.StackResourceSummary{ { ResourceType: aws.String(\"NoASG\"), PhysicalResourceId: aws.String(\"arn::whatever\"), }, }, } This doesn’t look so appealing, but one gets used to it quickly.\nError handling Errors also have their own types. An AWS error looks like this:\nif err != nil { if awsErr, ok := err.(awserr.Error); ok { } } First, we check if error is nil, than we type check if the error is an AWS error or something different. In the wild, this will look something like this:\nif err != nil { if awsErr, ok := err.(awserr.Error); ok { if awsErr.Code() != codedeploy.ErrCodeDeploymentGroupAlreadyExistsException { log.Println(awsErr.Code()) return err } log.Println(\"DeploymentGroup already exists. Nothing to do.\") return nil } return err } If it’s an AWS error, we can check further for the error code that it returns in order to identify what to handle, or what to throw on to the caller to a potential fatal. Here, I’m ignoring the AlreadyExistsException because, if it does, we just go on to a next action.\nExamples Luckily the API doc is very mature. In most of the cases, they provide an example to an API call. These examples, however, from time to time provide more confusion than clarity. Take CloudFormation. For me, when I first glanced upon the description of the API it wasn’t immediately clear that the TemplateBody was supposed to be the whole template, and that the rest of the fields were almost all optional settings. Or provided overrides in special cases.\nAnd since the template is not an ordinary JAML or JSON file, I was looking for something that parses it into that the Struct I was going to use. After some time, and digging, I realized that I didn’t need that, and that I just need to read in the template, define some extra parameters, and give the TemplateBody the whole of the template. The parameters defined by the CloudFormation template where extracted for me by ValidateTemplate API call which returned all of them in a convenient []*cloudformation.Parameter slice. These things are not described in the document or visible from the examples. I mainly found them through playing with the API and focused experimentation.\nWaiters From other SDK implementations, we got used to Waiters. These handy methods wait for a service to become available or for certain situations to take in effect, like a Stage being CREATE_COMPLETE. The Go waiters, however, don’t allow for callback to be fired, or for running blocks, like the ruby SDK does. For this, I wrote a handy little waiter for myself, which outputs a spinner to see that we are currently waiting for something and not frozen in time. This waiter looks like this:\n// WaitForFunctionWithStatusOutput waits for a function to complete its action. func WaitForFunctionWithStatusOutput(state string, freq int, f func()) { var wg sync.WaitGroup wg.Add(1) done := make(chan bool) go func() { defer wg.Done() f() done \u003c- true }() go func() { counter := 0 for { counter = (counter + 1) % len(Spinners[config.SPINNER]) fmt.Printf(\"\\r[%s] Waiting for state: %s\", yellow(string(Spinners[config.SPINNER][counter])), red(state)) time.Sleep(time.Duration(freq) * time.Second) select { case \u003c-done: fmt.Println() break default: } } }() wg.Wait() } And I’m calling it with the following method:\nutils.WaitForFunctionWithStatusOutput(\"DELETE_COMPLETE\", config.WAITFREQUENCY, func() { cfClient.Client.WaitUntilStackDeleteComplete(describeStackInput) }) This would output these lines to the console:\n[\\] Waiting for state: DELETE_COMPLETE The spinner can be configured to be one of the following types:\nvar Spinners = []string{`←↖↑↗→↘↓↙`, `▁▃▄▅▆▇█▇▆▅▄▃`, `┤┘┴└├┌┬┐`, `◰◳◲◱`, `◴◷◶◵`, `◐◓◑◒`, `⣾⣽⣻⢿⡿⣟⣯⣷`, `|/-\\`} Handy.\nAnd with that, let’s dive into the basics of Furnace.\nFurnace Directory Structure and Packages Furnace is divided into three main packages.\ncommands Commands package is where the gist of Furnace lies. These commands represent the commands which are used through the CLI. Each file has the implementation for one command. The structure is devised by this library: Yitsushi’s Command Library. As of the writing of this post, the following commands are available:\ncreate - Creates a stack using the CloudFormation template file under ~/.config/go-furnace delete - Deletes the created Stack. Doesn’t do anything if the stack doesn’t exist push - Pushes an application to a stack status - Displays information about the stack delete-application - Deletes the CodeDeploy application and deployment group created by push These commands represent the heart of furnace. I would like to keep these to a minimum, but I do plan on adding more, like update and rollout. Further details and help messages on these commands can be obtained by running: ./furnace help or ./furnace help create.\n❯ ./furnace help push Usage: furnace push appName [-s3] Push a version of the application to a stack Examples: furnace push furnace push appName furnace push appName -s3 furnace push -s3 config Contains the configuration loader and some project wide defaults which are as follows:\nEvents for the plugin system - pre-create, post-create, pre-delete, post-delete. CodeDeploy role name - CodeDeployServiceRole. This is used if none is provided to locate the CodeDeploy IAM role. Wait frequency - Is the setting which controls how long the waiter should sleep in between status updates. Default is 1s. Spinner - Is just the number of the spinner to use. Plugin registry - Is a map of functions to run for the above events. Further more, config loads the CloudFormation template and checks if some necessary settings are present in the environment, exp: the configuration folder under ~/.config/go-furnace.\nutils These are some helper functions which are used throughout the project. To list them:\nerror_handler - Is a simple error handler. I’m thinking of refactoring this one to some saner version. spinner - Sets up which spinner to use in the waiter function. waiter - Contains the verbose waiter introduced above under Waiters. Configuration and Environment variables Furnace is a Go application, thus it doesn’t have the luxury of Ruby or Python where the configuration files are usually bundled with the app. But, it does have a standard for it. Usually, configurations reside in either of these two locations. Environment Properties or|and configuration files under a fixed location ( i.e. HOME/.config/app-name ). Furnace employs both.\nSettings like, region, stack name, enable plugin system, are under environment properties ( though this can change ), while the CloudFormation template lives under ~/.config/go-furnace/. Lastly it assumes some things, like the Deployment IAM role just exists under the used AWS account. All these are loaded and handled by the config package described above.\nUsage A typical scenario for Furnace would be the following:\nSetup your CloudFormation template or use the one provided. The one provided sets up a highly available and self healing setting using Auto-Scaling and Load-Balancing with a single application instance. Edit this template to your liking than copy it to ~/.config/go-furnace. Create the configured stack with ./furnace create. Create will ask for the parameters defined in the template. If defaults are setup, simply hitting enter will use these defaults. Take note, that the provided template sets up SSH access via a provided key. If that key is not present in CF, you won’t be able to SSH into the created instance. Once the stack is completed, the application is ready to be pushed. To do this, run: ./furnace push. This will locate the appropriate version of the app from S3 or GitHub and push that version to the instances in the Auto-Scaling group. To all of them. General Practices Applied to the Project Commands For each command the main entry point is the execute function. These functions are usually calling out the small chunks of distributed methods. Logic was kept to a bare minimum ( probably could be simplified even further ) in the execute functions mostly for testability and the likes. We will see that in a followup post.\nErrors Errors are handled immediately and usually through a fatal. If any error occurs than the application is halted. In followup versions this might become more granular. I.e. don’t immediately stop the world, maybe try to recover, or create a Poller or Re-Tryer, which tries a call again for a configured amount of times.\nOutput colors Not that important, but still… Aesthetics. Displaying data to the console in a nice way gives it some extra flare.\nMakefile This project works with a Makefile for various reasons. Later on, once the project might become more complex, a Makefile makes it really easy to handle different ways of packaging the application. Currently, for example, it provides a linux target which will make Go build the project for Linux architecture on any other Architecture i.e. cross-compiling.\nIt also provides an easy way to run unit tests with make test and installing with make \u0026\u0026 make install.\nClosing Words That is all for Part 2. Join me in Part 3 where I will talk about the experimental Plugin system that Furnace employs.\nThank you for reading! Gergely.\n",
  "wordCount" : "1840",
  "inLanguage": "en",
  "datePublished": "2017-03-19T12:03:00+01:00",
  "dateModified": "2017-03-19T12:03:00+01:00",
  "author":{
    "@type": "Person",
    "name": "hannibal"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://skarlso.github.io/2017/03/19/building-furnace-part-2/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Ramblings of a cloud engineer",
    "logo": {
      "@type": "ImageObject",
      "url": "https://skarlso.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://skarlso.github.io" accesskey="h" title="Ramblings of a cloud engineer (Alt + H)">Ramblings of a cloud engineer</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://skarlso.github.io/archives" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://skarlso.github.io/search/" title="Search">
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://skarlso.github.io/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://skarlso.github.io/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://skarlso.github.io">Home</a>&nbsp;»&nbsp;<a href="https://skarlso.github.io/posts/">Posts</a></div>
    <h1 class="post-title">
      Furnace - The building of an AWS CLI Tool for CloudFormation and CodeDeploy - Part 2
    </h1>
    <div class="post-meta"><span title='2017-03-19 12:03:00 +0100 +0100'>March 19, 2017</span>&nbsp;·&nbsp;9 min&nbsp;·&nbsp;hannibal

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#intro" aria-label="Intro">Intro</a></li>
                <li>
                    <a href="#aws-sdk" aria-label="AWS SDK">AWS SDK</a><ul>
                        
                <li>
                    <a href="#getting-started-and-developers-guide" aria-label="Getting Started and Developers Guide">Getting Started and Developers Guide</a></li>
                <li>
                    <a href="#awsstring-and-other-types" aria-label="aws.String and other types">aws.String and other types</a></li>
                <li>
                    <a href="#error-handling" aria-label="Error handling">Error handling</a></li>
                <li>
                    <a href="#examples" aria-label="Examples">Examples</a></li>
                <li>
                    <a href="#waiters" aria-label="Waiters">Waiters</a></li></ul>
                </li>
                <li>
                    <a href="#furnace" aria-label="Furnace">Furnace</a><ul>
                        
                <li>
                    <a href="#directory-structure-and-packages" aria-label="Directory Structure and Packages">Directory Structure and Packages</a><ul>
                        
                <li>
                    <a href="#commands" aria-label="commands">commands</a></li>
                <li>
                    <a href="#config" aria-label="config">config</a></li>
                <li>
                    <a href="#utils" aria-label="utils">utils</a></li></ul>
                </li>
                <li>
                    <a href="#configuration-and-environment-variables" aria-label="Configuration and Environment variables">Configuration and Environment variables</a></li>
                <li>
                    <a href="#usage" aria-label="Usage">Usage</a></li>
                <li>
                    <a href="#general-practices-applied-to-the-project" aria-label="General Practices Applied to the Project">General Practices Applied to the Project</a><ul>
                        
                <li>
                    <a href="#commands-1" aria-label="Commands">Commands</a></li>
                <li>
                    <a href="#errors" aria-label="Errors">Errors</a></li>
                <li>
                    <a href="#output-colors" aria-label="Output colors">Output colors</a></li>
                <li>
                    <a href="#makefile" aria-label="Makefile">Makefile</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#closing-words" aria-label="Closing Words">Closing Words</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="intro">Intro<a hidden class="anchor" aria-hidden="true" href="#intro">#</a></h1>
<p>Hi folks.</p>
<p>Previously on this blog: <a href="https://skarlso.github.io/2017/03/16/building-furnace-part-1/">Part 1</a>, <a href="https://skarlso.github.io/2017/03/22/building-furnace-part-3/">Part 3</a>, <a href="https://skarlso.github.io/2017/04/16/building-furnace-part-4/">Part 4</a></p>
<p>In this part, I&rsquo;m going to talk about the AWS Go SDK and begin do dissect the intricacies of Furnace.</p>
<h1 id="aws-sdk">AWS SDK<a hidden class="anchor" aria-hidden="true" href="#aws-sdk">#</a></h1>
<p>Fortunately, the Go SDK for AWS is quiet verbose and littered with examples of all sorts. But that doesn&rsquo;t make it less complex
and less cryptic at times. I&rsquo;m here to lift some of the early confusions, in hopes that I can help someone to avoid wasting time.</p>
<h2 id="getting-started-and-developers-guide">Getting Started and Developers Guide<a hidden class="anchor" aria-hidden="true" href="#getting-started-and-developers-guide">#</a></h2>
<p>As always, and common from AWS, the documentation is top notch. There is a 141 pages long developer&rsquo;s guide on the SDK containing
a getting started section and an API reference. Go check it out. I&rsquo;ll wait. <a href="http://docs.aws.amazon.com/sdk-for-go/v1/developer-guide/aws-sdk-go-dg.pdf">AWS Go SDK DG PDF</a>. I will only talk about some gotchas and things I encountered, not the basics of the SDK.</p>
<h2 id="awsstring-and-other-types">aws.String and other types<a hidden class="anchor" aria-hidden="true" href="#awsstring-and-other-types">#</a></h2>
<p>Something which is immediately visible once we take a look at the API is that everything is a pointer. Now, there are a
tremendous amount of discussions about this, but I&rsquo;m with Amazon. There are various reasons for it, but to list the most prominent
ones:
- Type completion and compile time type safety.
- Values for AWS API calls have valid zero values, in addition to being optional, i.e. not being provided at all.
- Other option, like, empty interfaces with maps, or using zero values, or struct wrappers around every type, made life much
harder rather than easier or not possible at all.
- The AWS API is volatile. You never know when something gets to be optional, or required. Pointers made that decision easy.</p>
<p>There are good number of other discussions around this topic, for example: <a href="https://github.com/aws/aws-sdk-go/issues/363">AWS Go GitHub #363</a>.</p>
<p>In order to use primitives, AWS has helper functions like <code>aws.String</code>. Because &amp;&ldquo;asdf&rdquo; is not allowed, you would have to create a
variable and use its address in situations where a string pointer is needed, for example, name of the stack. These primitive helpers will
make in-lining possible. We&rsquo;ll see later that they are used to a great extent. Pointers, however, make life a bit difficult when
constructing Input structs and make for poor aesthetics.</p>
<p>This is something I&rsquo;m returning in a test for stubbing a client call:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">cloudformation</span>.<span style="color:#a6e22e">ListStackResourcesOutput</span>{
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">StackResourceSummaries</span>: []<span style="color:#f92672">*</span><span style="color:#a6e22e">cloudformation</span>.<span style="color:#a6e22e">StackResourceSummary</span>{
</span></span><span style="display:flex;"><span>				{
</span></span><span style="display:flex;"><span>					<span style="color:#a6e22e">ResourceType</span>:       <span style="color:#a6e22e">aws</span>.<span style="color:#a6e22e">String</span>(<span style="color:#e6db74">&#34;NoASG&#34;</span>),
</span></span><span style="display:flex;"><span>					<span style="color:#a6e22e">PhysicalResourceId</span>: <span style="color:#a6e22e">aws</span>.<span style="color:#a6e22e">String</span>(<span style="color:#e6db74">&#34;arn::whatever&#34;</span>),
</span></span><span style="display:flex;"><span>				},
</span></span><span style="display:flex;"><span>			},
</span></span><span style="display:flex;"><span>		}
</span></span></code></pre></div><p>This doesn&rsquo;t look so appealing, but one gets used to it quickly.</p>
<h2 id="error-handling">Error handling<a hidden class="anchor" aria-hidden="true" href="#error-handling">#</a></h2>
<p>Errors also have their own types. An AWS error looks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">awsErr</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">err</span>.(<span style="color:#a6e22e">awserr</span>.<span style="color:#a6e22e">Error</span>); <span style="color:#a6e22e">ok</span> {
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>First, we check if error is nil, than we type check if the error is an AWS error or something different. In the wild, this will
look something like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">awsErr</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">err</span>.(<span style="color:#a6e22e">awserr</span>.<span style="color:#a6e22e">Error</span>); <span style="color:#a6e22e">ok</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">awsErr</span>.<span style="color:#a6e22e">Code</span>() <span style="color:#f92672">!=</span> <span style="color:#a6e22e">codedeploy</span>.<span style="color:#a6e22e">ErrCodeDeploymentGroupAlreadyExistsException</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">awsErr</span>.<span style="color:#a6e22e">Code</span>())
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;DeploymentGroup already exists. Nothing to do.&#34;</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>	}
</span></span></code></pre></div><p>If it&rsquo;s an AWS error, we can check further for the error code that it returns in order to identify what to handle, or what to throw
on to the caller to a potential fatal. Here, I&rsquo;m ignoring the AlreadyExistsException because, if it does, we just go on to a next
action.</p>
<h2 id="examples">Examples<a hidden class="anchor" aria-hidden="true" href="#examples">#</a></h2>
<p>Luckily the API doc is very mature. In most of the cases, they provide an example to an API call. These examples, however, from
time to time provide more confusion than clarity. Take CloudFormation. For me, when I first glanced upon the
description of the API it wasn&rsquo;t immediately clear that the <code>TemplateBody</code> was supposed to be the whole template, and that
the rest of the fields were almost all optional settings. Or provided overrides in special cases.</p>
<p>And since the template is not an ordinary JAML or JSON file, I was looking for something that parses it into that the Struct I
was going to use. After some time, and digging, I realized that I didn&rsquo;t need that, and that I just need to read in the template,
define some extra parameters, and give the TemplateBody the whole of the template. The parameters defined by the CloudFormation
template where extracted for me by <code>ValidateTemplate</code> API call which returned all of them in a convenient
<code>[]*cloudformation.Parameter</code> slice. These things are not described in the document or visible from the examples. I mainly found
them through playing with the API and focused experimentation.</p>
<h2 id="waiters">Waiters<a hidden class="anchor" aria-hidden="true" href="#waiters">#</a></h2>
<p>From other SDK implementations, we got used to Waiters. These handy methods wait for a service to become available or for certain
situations to take in effect, like a Stage being <code>CREATE_COMPLETE</code>. The Go waiters, however, don&rsquo;t allow for callback to be fired,
or for running blocks, like the ruby SDK does. For this, I wrote a handy little waiter for myself, which outputs a spinner to see
that we are currently waiting for something and not frozen in time. This waiter looks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// WaitForFunctionWithStatusOutput waits for a function to complete its action.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WaitForFunctionWithStatusOutput</span>(<span style="color:#a6e22e">state</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">freq</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">f</span> <span style="color:#66d9ef">func</span>()) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">wg</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">WaitGroup</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">done</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">bool</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Done</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">f</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">done</span> <span style="color:#f92672">&lt;-</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>	}()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">counter</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">for</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">counter</span> = (<span style="color:#a6e22e">counter</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">%</span> len(<span style="color:#a6e22e">Spinners</span>[<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">SPINNER</span>])
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;\r[%s] Waiting for state: %s&#34;</span>, <span style="color:#a6e22e">yellow</span>(string(<span style="color:#a6e22e">Spinners</span>[<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">SPINNER</span>][<span style="color:#a6e22e">counter</span>])), <span style="color:#a6e22e">red</span>(<span style="color:#a6e22e">state</span>))
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>(<span style="color:#a6e22e">freq</span>) <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">select</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">done</span>:
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>()
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">default</span>:
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Wait</span>()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>And I&rsquo;m calling it with the following method:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>	<span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">WaitForFunctionWithStatusOutput</span>(<span style="color:#e6db74">&#34;DELETE_COMPLETE&#34;</span>, <span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">WAITFREQUENCY</span>, <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">cfClient</span>.<span style="color:#a6e22e">Client</span>.<span style="color:#a6e22e">WaitUntilStackDeleteComplete</span>(<span style="color:#a6e22e">describeStackInput</span>)
</span></span><span style="display:flex;"><span>	})
</span></span></code></pre></div><p>This would output these lines to the console:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span><span style="color:#ae81ff">\]</span> Waiting <span style="color:#66d9ef">for</span> state: DELETE_COMPLETE
</span></span></code></pre></div><p>The spinner can be configured to be one of the following types:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">Spinners</span> = []<span style="color:#66d9ef">string</span>{<span style="color:#e6db74">`←↖↑↗→↘↓↙`</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">`▁▃▄▅▆▇█▇▆▅▄▃`</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">`┤┘┴└├┌┬┐`</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">`◰◳◲◱`</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">`◴◷◶◵`</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">`◐◓◑◒`</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">`⣾⣽⣻⢿⡿⣟⣯⣷`</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">`|/-\`</span>}
</span></span></code></pre></div><p>Handy.</p>
<p>And with that, let&rsquo;s dive into the basics of Furnace.</p>
<h1 id="furnace">Furnace<a hidden class="anchor" aria-hidden="true" href="#furnace">#</a></h1>
<h2 id="directory-structure-and-packages">Directory Structure and Packages<a hidden class="anchor" aria-hidden="true" href="#directory-structure-and-packages">#</a></h2>
<p>Furnace is divided into three main packages.</p>
<h3 id="commands">commands<a hidden class="anchor" aria-hidden="true" href="#commands">#</a></h3>
<p>Commands package is where the gist of Furnace lies. These commands represent the commands which are used through the CLI. Each
file has the implementation for one command. The structure is devised by this library: <a href="https://github.com/Yitsushi/go-commander">Yitsushi&rsquo;s Command Library</a>.
As of the writing of this post, the following commands are available:</p>
<ul>
<li>create - Creates a stack using the CloudFormation template file under ~/.config/go-furnace</li>
<li>delete - Deletes the created Stack. Doesn&rsquo;t do anything if the stack doesn&rsquo;t exist</li>
<li>push - Pushes an application to a stack</li>
<li>status - Displays information about the stack</li>
<li>delete-application - Deletes the CodeDeploy application and deployment group created by <code>push</code></li>
</ul>
<p>These commands represent the heart of furnace. I would like to keep these to a minimum, but I do plan on adding more, like
<code>update</code> and <code>rollout</code>. Further details and help messages on these commands can be obtained by running: <code>./furnace help</code> or
<code>./furnace help create</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯ ./furnace help push
</span></span><span style="display:flex;"><span>Usage: furnace push appName <span style="color:#f92672">[</span>-s3<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Push a version of the application to a stack
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Examples:
</span></span><span style="display:flex;"><span>  furnace push
</span></span><span style="display:flex;"><span>  furnace push appName
</span></span><span style="display:flex;"><span>  furnace push appName -s3
</span></span><span style="display:flex;"><span>  furnace push -s3
</span></span></code></pre></div><h3 id="config">config<a hidden class="anchor" aria-hidden="true" href="#config">#</a></h3>
<p>Contains the configuration loader and some project wide defaults which are as follows:</p>
<ul>
<li>Events for the plugin system - <code>pre-create</code>, <code>post-create</code>, <code>pre-delete</code>, <code>post-delete</code>.</li>
<li>CodeDeploy role name - <code>CodeDeployServiceRole</code>. This is used if none is provided to locate the CodeDeploy IAM role.</li>
<li>Wait frequency - Is the setting which controls how long the waiter should sleep in between status updates. Default is <code>1s</code>.</li>
<li>Spinner - Is just the number of the spinner to use.</li>
<li>Plugin registry - Is a map of functions to run for the above events.</li>
</ul>
<p>Further more, config loads the CloudFormation template and checks if some necessary settings are present in the environment, exp:
the configuration folder under <code>~/.config/go-furnace</code>.</p>
<h3 id="utils">utils<a hidden class="anchor" aria-hidden="true" href="#utils">#</a></h3>
<p>These are some helper functions which are used throughout the project. To list them:</p>
<ul>
<li>error_handler - Is a simple error handler. I&rsquo;m thinking of refactoring this one to some saner version.</li>
<li>spinner - Sets up which spinner to use in the waiter function.</li>
<li>waiter - Contains the verbose waiter introduced above under <a href="##Waiters">Waiters</a>.</li>
</ul>
<h2 id="configuration-and-environment-variables">Configuration and Environment variables<a hidden class="anchor" aria-hidden="true" href="#configuration-and-environment-variables">#</a></h2>
<p>Furnace is a Go application, thus it doesn&rsquo;t have the luxury of Ruby or Python where the configuration files are usually bundled
with the app. But, it does have a standard for it. Usually, configurations reside in either of these two locations. Environment
Properties or|and configuration files under a fixed location ( i.e. HOME/.config/app-name ). Furnace employs both.</p>
<p>Settings like, region, stack name, enable plugin system, are under environment properties ( though this can change ), while the
CloudFormation template lives under <code>~/.config/go-furnace/</code>. Lastly it assumes some things, like the Deployment IAM role just
exists under the used AWS account. All these are loaded and handled by the config package described above.</p>
<h2 id="usage">Usage<a hidden class="anchor" aria-hidden="true" href="#usage">#</a></h2>
<p>A typical scenario for Furnace would be the following:</p>
<ul>
<li>Setup your CloudFormation template or use the one provided. The one provided sets up a highly available and self healing setting
using Auto-Scaling and Load-Balancing with a single application instance. Edit this template to your liking than copy it to
<code>~/.config/go-furnace</code>.</li>
<li>Create the configured stack with <code>./furnace create</code>.</li>
<li>Create will ask for the parameters defined in the template. If defaults are setup, simply hitting enter will use these defaults.
Take note, that the provided template sets up SSH access via a provided key. If that key is not present in CF, you won&rsquo;t be able
to SSH into the created instance.</li>
<li>Once the stack is completed, the application is ready to be pushed. To do this, run: <code>./furnace push</code>. This will locate the
appropriate version of the app from S3 or GitHub and push that version to the instances in the Auto-Scaling group. To all of
them.</li>
</ul>
<h2 id="general-practices-applied-to-the-project">General Practices Applied to the Project<a hidden class="anchor" aria-hidden="true" href="#general-practices-applied-to-the-project">#</a></h2>
<h3 id="commands-1">Commands<a hidden class="anchor" aria-hidden="true" href="#commands-1">#</a></h3>
<p>For each command the main entry point is the <code>execute</code> function. These functions are usually calling out the small chunks of
distributed methods. Logic was kept to a bare minimum ( probably could be simplified even further ) in the execute functions
mostly for testability and the likes. We will see that in a followup post.</p>
<h3 id="errors">Errors<a hidden class="anchor" aria-hidden="true" href="#errors">#</a></h3>
<p>Errors are handled immediately and usually through a fatal. If any error occurs than the application is halted. In followup
versions this might become more granular. I.e. don&rsquo;t immediately stop the world, maybe try to recover, or create a Poller or
Re-Tryer, which tries a call again for a configured amount of times.</p>
<h3 id="output-colors">Output colors<a hidden class="anchor" aria-hidden="true" href="#output-colors">#</a></h3>
<p>Not that important, but still&hellip; Aesthetics. Displaying data to the console in a nice way gives it some extra flare.</p>
<h3 id="makefile">Makefile<a hidden class="anchor" aria-hidden="true" href="#makefile">#</a></h3>
<p>This project works with a Makefile for various reasons. Later on, once the project might become more complex, a Makefile makes it
really easy to handle different ways of packaging the application. Currently, for example, it provides a <code>linux</code> target which will
make Go build the project for Linux architecture on any other Architecture i.e. cross-compiling.</p>
<p>It also provides an easy way to run unit tests with <code>make test</code> and installing with <code>make &amp;&amp; make install</code>.</p>
<h1 id="closing-words">Closing Words<a hidden class="anchor" aria-hidden="true" href="#closing-words">#</a></h1>
<p>That is all for Part 2. Join me in Part 3 where I will talk about the experimental Plugin system that Furnace employs.</p>
<p>Thank you for reading!
Gergely.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="https://skarlso.github.io/2017/03/22/building-furnace-part-3/">
    <span class="title">« Prev</span>
    <br>
    <span>Furnace - The building of an AWS CLI Tool for CloudFormation and CodeDeploy - Part 3</span>
  </a>
  <a class="next" href="https://skarlso.github.io/2017/03/17/test-new-hugo/">
    <span class="title">Next »</span>
    <br>
    <span>Testing new Hugo if posts are generated properly</span>
  </a>
</nav>

  </footer><div id="disqus_thread"></div>
<script type="application/javascript">
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "hannibalDisqus" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="https://skarlso.github.io">Ramblings of a cloud engineer</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
