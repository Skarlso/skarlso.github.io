<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>How to add a self-signed certificate to the GitHub action runner | Ramblings of a cloud engineer</title>
<meta name="keywords" content="">
<meta name="description" content="Adding a certificate to a GitHub runner
Imagine having a project where you have a server that you would like to run with TLS. Let&rsquo;s say, you want to run a
Docker registry in a cluster using TLS. You need the generated certificate&rsquo;s root certificate in the trust store of the
GitHub action runner.
This is simple with mkcert.
The action is simple:
name: tests

on:
  pull_request:
    paths-ignore:
      - &#39;CODE_OF_CONDUCT.md&#39;
      - &#39;README.md&#39;
      - &#39;Contributing.md&#39;
  workflow_call:

  push:
    branches:
      - main

permissions:
  contents: read # for actions/checkout to fetch code

jobs:
  run-test-suite:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup Go
        uses: actions/setup-go@v3
        with:
          go-version-file: &#39;${{ github.workspace }}/go.mod&#39;
      - name: Restore Go cache
        uses: actions/cache@v3
        with:
          path: /home/runner/work/_temp/_github_home/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles(&#39;**/go.sum&#39;) }}
          restore-keys: |
            ${{ runner.os }}-go-            
      - name: Run e2e
        run: make e2e
This is nothing fancy. The fancy thing is coming from the make e2e part.">
<meta name="author" content="hannibal">
<link rel="canonical" href="https://skarlso.github.io/2023/07/04/how-to-add-self-signed-certificates-to-github-action-runner-using-mkcert/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css" integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://skarlso.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://skarlso.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://skarlso.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://skarlso.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://skarlso.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://skarlso.github.io/2023/07/04/how-to-add-self-signed-certificates-to-github-action-runner-using-mkcert/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="How to add a self-signed certificate to the GitHub action runner">
<meta property="og:description" content="Adding a certificate to a GitHub runner
Imagine having a project where you have a server that you would like to run with TLS. Let&rsquo;s say, you want to run a
Docker registry in a cluster using TLS. You need the generated certificate&rsquo;s root certificate in the trust store of the
GitHub action runner.
This is simple with mkcert.
The action is simple:
name: tests

on:
  pull_request:
    paths-ignore:
      - &#39;CODE_OF_CONDUCT.md&#39;
      - &#39;README.md&#39;
      - &#39;Contributing.md&#39;
  workflow_call:

  push:
    branches:
      - main

permissions:
  contents: read # for actions/checkout to fetch code

jobs:
  run-test-suite:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup Go
        uses: actions/setup-go@v3
        with:
          go-version-file: &#39;${{ github.workspace }}/go.mod&#39;
      - name: Restore Go cache
        uses: actions/cache@v3
        with:
          path: /home/runner/work/_temp/_github_home/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles(&#39;**/go.sum&#39;) }}
          restore-keys: |
            ${{ runner.os }}-go-            
      - name: Run e2e
        run: make e2e
This is nothing fancy. The fancy thing is coming from the make e2e part.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://skarlso.github.io/2023/07/04/how-to-add-self-signed-certificates-to-github-action-runner-using-mkcert/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2023-07-04T01:01:00+01:00">
<meta property="article:modified_time" content="2023-07-04T01:01:00+01:00">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="How to add a self-signed certificate to the GitHub action runner">
<meta name="twitter:description" content="Adding a certificate to a GitHub runner
Imagine having a project where you have a server that you would like to run with TLS. Let&rsquo;s say, you want to run a
Docker registry in a cluster using TLS. You need the generated certificate&rsquo;s root certificate in the trust store of the
GitHub action runner.
This is simple with mkcert.
The action is simple:
name: tests

on:
  pull_request:
    paths-ignore:
      - &#39;CODE_OF_CONDUCT.md&#39;
      - &#39;README.md&#39;
      - &#39;Contributing.md&#39;
  workflow_call:

  push:
    branches:
      - main

permissions:
  contents: read # for actions/checkout to fetch code

jobs:
  run-test-suite:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup Go
        uses: actions/setup-go@v3
        with:
          go-version-file: &#39;${{ github.workspace }}/go.mod&#39;
      - name: Restore Go cache
        uses: actions/cache@v3
        with:
          path: /home/runner/work/_temp/_github_home/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles(&#39;**/go.sum&#39;) }}
          restore-keys: |
            ${{ runner.os }}-go-            
      - name: Run e2e
        run: make e2e
This is nothing fancy. The fancy thing is coming from the make e2e part.">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://skarlso.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "How to add a self-signed certificate to the GitHub action runner",
      "item": "https://skarlso.github.io/2023/07/04/how-to-add-self-signed-certificates-to-github-action-runner-using-mkcert/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "How to add a self-signed certificate to the GitHub action runner",
  "name": "How to add a self-signed certificate to the GitHub action runner",
  "description": "Adding a certificate to a GitHub runner Imagine having a project where you have a server that you would like to run with TLS. Let\u0026rsquo;s say, you want to run a Docker registry in a cluster using TLS. You need the generated certificate\u0026rsquo;s root certificate in the trust store of the GitHub action runner.\nThis is simple with mkcert.\nThe action is simple:\nname: tests on: pull_request: paths-ignore: - \u0026#39;CODE_OF_CONDUCT.md\u0026#39; - \u0026#39;README.md\u0026#39; - \u0026#39;Contributing.md\u0026#39; workflow_call: push: branches: - main permissions: contents: read # for actions/checkout to fetch code jobs: run-test-suite: runs-on: ubuntu-latest steps: - name: Checkout uses: actions/checkout@v3 - name: Setup Go uses: actions/setup-go@v3 with: go-version-file: \u0026#39;${{ github.workspace }}/go.mod\u0026#39; - name: Restore Go cache uses: actions/cache@v3 with: path: /home/runner/work/_temp/_github_home/go/pkg/mod key: ${{ runner.os }}-go-${{ hashFiles(\u0026#39;**/go.sum\u0026#39;) }} restore-keys: | ${{ runner.os }}-go- - name: Run e2e run: make e2e This is nothing fancy. The fancy thing is coming from the make e2e part.\n",
  "keywords": [
    
  ],
  "articleBody": "Adding a certificate to a GitHub runner Imagine having a project where you have a server that you would like to run with TLS. Let’s say, you want to run a Docker registry in a cluster using TLS. You need the generated certificate’s root certificate in the trust store of the GitHub action runner.\nThis is simple with mkcert.\nThe action is simple:\nname: tests on: pull_request: paths-ignore: - 'CODE_OF_CONDUCT.md' - 'README.md' - 'Contributing.md' workflow_call: push: branches: - main permissions: contents: read # for actions/checkout to fetch code jobs: run-test-suite: runs-on: ubuntu-latest steps: - name: Checkout uses: actions/checkout@v3 - name: Setup Go uses: actions/setup-go@v3 with: go-version-file: '${{ github.workspace }}/go.mod' - name: Restore Go cache uses: actions/cache@v3 with: path: /home/runner/work/_temp/_github_home/go/pkg/mod key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }} restore-keys: | ${{ runner.os }}-go- - name: Run e2e run: make e2e This is nothing fancy. The fancy thing is coming from the make e2e part.\nFirst, we make sure we have mkcert:\nMKCERT ?= $(LOCALBIN)/mkcert MKCERT_VERSION ?= v1.4.4 ... .PHONY: mkcert mkcert: $(MKCERT) $(MKCERT): $(LOCALBIN) curl -L \"https://github.com/FiloSottile/mkcert/releases/download/$(MKCERT_VERSION)/mkcert-$(MKCERT_VERSION)-$(UNAME)-amd64\" -o $(LOCALBIN)/mkcert chmod +x $(LOCALBIN)/mkcert Then, let’s add a target which we’ll call before the test is called:\n.PHONY: generate-developer-certs generate-developer-certs: mkcert ./hack/create_developer_certificate_secrets.sh Lastly, put this as a dependency on our test target:\n.PHONY: e2e e2e: generate-developer-certs test-summary-tool ## Runs e2e tests $(GOTESTSUM) --format testname -- -count=1 -tags=e2e ./e2e That’s all the setup we need in the GitHub action workflow part. Now, let’s take a look at the magic:\n#!/usr/bin/env bash # You can ignore this. path=$(pwd) if [[ \"${path}\" == *hack* ]]; then echo \"This script is intended to be executed from the project root.\" exit 1 fi if [ \"$(kubectl get secret -n ocm-system registry-certs)\" ]; then echo \"secret already exist, no need to re-run\" exit 0 fi echo \"generating developer certificates and kubernetes secrets\" # Set up certificate paths CAROOT=./hack/certs ./bin/mkcert -install certPath=\"./hack/certs/cert.pem\" keyPath=\"./hack/certs/key.pem\" rootCAPath=\"./hack/certs/rootCA.pem\" echo \"updating root certificate\" sudo cat \"${rootCAPath}\" | sudo tee -a /etc/ssl/certs/ca-certificates.crt || echo \"failed to append to ca-certificates. Ignoring the failure\" if [ ! -e \"${certPath}\" ] \u0026\u0026 [ ! -e \"${keyPath}\" ]; then echo -n \"certificates not found, generating...\" CAROOT=./hack/certs ./bin/mkcert -cert-file ./hack/certs/cert.pem -key-file ./hack/certs/key.pem registry.ocm-system.svc.cluster.local localhost 127.0.0.1 ::1 echo \"done\" else echo \"certificates found, will not re-generate\" fi # You can ignore this. echo -n \"creating secret...\" kubectl create secret generic \\ -n ocm-system registry-certs \\ --from-file=caFile=\"${rootCAPath}\" \\ --from-file=certFile=\"${certPath}\" \\ --from-file=keyFile=\"${keyPath}\" \\ --dry-run=client -o yaml \u003e ./hack/certs/registry_certs_secret.yaml Let’s break this down line by line:\n1-15: Ignore this part. It’s just checking some things before running. 19: This is calling mkcert but notice the CAROOT setting. This will output the root certificate to that location. 27: Now, this is the important bit. Here, since we are using Ubuntu machine type, we append our certificate to the system’s root certificates. There are other ways to do this but none of them will work properly on GitHub actions or requires way too much fiddling. This is a heck of a lot easier to execute. 29-37: If the certificates do not exist it will create them. This, again, is using the configured ROOT location. This is done so that when this script is running locally, it doesn’t continue re-generating the certificates constantly. 39-45: Here, we create the secret which will contain our certificates.\nSo that’s the script.\nHow to automatically create developer certificates To do this automatically we use a combination of Makefile targets and Tilt. Tilt configures the mount and Makefile target calls mkcert and the script and then runs the e2e tests locally using Kind.\nfor o in objects: if o.get('kind') == 'Deployment' and o.get('metadata').get('name') == 'ocm-controller': print('updating ocm-controller deployment to add generated certificates') o['spec']['template']['spec']['volumes'] = [{'name': 'root-certificate', 'secret': {'secretName': 'registry-certs', 'items': [{'key': 'caFile', 'path': 'ca.pem'}]}}] o['spec']['template']['spec']['containers'][0]['volumeMounts'] = [{'mountPath': '/certs', 'name': 'root-certificate'}] The name can be made configurable with an environment property, but here we just ignore that in the dev environment.\nAdding the root certificate to the container To add the root certificate to the container in which our controller is running, we use an entrypoint.sh script. We get the root certificate that is mounted into the container and then append that rootCA to the system CA. When done we launch our manager.\n#!/usr/bin/env sh rootCA=${REGISTRY_ROOT_CERTIFICATE:-/certs/ca.pem} if [ ! -e \"${rootCA}\" ]; then echo \"warning... root certificate at location ${rootCA} not found.\" exec \"$@\" fi echo \"updating root certificate with provided certificate...\" tee -a /etc/ssl/certs/ca-certificates.crt \u003c \"${rootCA}\" echo \"done.\" exec \"$@\" That’s all we need. With this, our controller will now understand our self-signed certificate or any certificate that is provided to the controller if it exists.\nConclusion This is it. We have all the things we need for a self-signer certificate to seamlessly work in dev and in CI environment. The whole project with all the files can be found here: ocm-controller.\nThank you for reading!\nGergely.\n",
  "wordCount" : "802",
  "inLanguage": "en",
  "datePublished": "2023-07-04T01:01:00+01:00",
  "dateModified": "2023-07-04T01:01:00+01:00",
  "author":{
    "@type": "Person",
    "name": "hannibal"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://skarlso.github.io/2023/07/04/how-to-add-self-signed-certificates-to-github-action-runner-using-mkcert/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Ramblings of a cloud engineer",
    "logo": {
      "@type": "ImageObject",
      "url": "https://skarlso.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://skarlso.github.io/" accesskey="h" title="Ramblings of a cloud engineer (Alt + H)">Ramblings of a cloud engineer</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://skarlso.github.io/archives" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://skarlso.github.io/search/" title="Search">
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://skarlso.github.io/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://skarlso.github.io/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://skarlso.github.io/">Home</a>&nbsp;»&nbsp;<a href="https://skarlso.github.io/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      How to add a self-signed certificate to the GitHub action runner
    </h1>
    <div class="post-meta"><span title='2023-07-04 01:01:00 +0100 +0100'>July 4, 2023</span>&nbsp;·&nbsp;4 min&nbsp;·&nbsp;hannibal

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#adding-a-certificate-to-a-github-runner" aria-label="Adding a certificate to a GitHub runner">Adding a certificate to a GitHub runner</a><ul>
                        
                <li>
                    <a href="#how-to-automatically-create-developer-certificates" aria-label="How to automatically create developer certificates">How to automatically create developer certificates</a><ul>
                        
                <li>
                    <a href="#adding-the-root-certificate-to-the-container" aria-label="Adding the root certificate to the container">Adding the root certificate to the container</a></li></ul>
                </li>
                <li>
                    <a href="#conclusion" aria-label="Conclusion">Conclusion</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="adding-a-certificate-to-a-github-runner">Adding a certificate to a GitHub runner<a hidden class="anchor" aria-hidden="true" href="#adding-a-certificate-to-a-github-runner">#</a></h1>
<p>Imagine having a project where you have a server that you would like to run with TLS. Let&rsquo;s say, you want to run a
Docker registry in a cluster using TLS. You need the generated certificate&rsquo;s root certificate in the trust store of the
GitHub action runner.</p>
<p>This is simple with <a href="https://github.com/FiloSottile/mkcert">mkcert</a>.</p>
<p>The action is simple:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">name</span>: <span style="color:#ae81ff">tests</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">on</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">pull_request</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">paths-ignore</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;CODE_OF_CONDUCT.md&#39;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;README.md&#39;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;Contributing.md&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">workflow_call</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">push</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">branches</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">permissions</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">contents</span>: <span style="color:#ae81ff">read</span> <span style="color:#75715e"># for actions/checkout to fetch code</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">jobs</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">run-test-suite</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">runs-on</span>: <span style="color:#ae81ff">ubuntu-latest</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">steps</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Checkout</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">uses</span>: <span style="color:#ae81ff">actions/checkout@v3</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Setup Go</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">uses</span>: <span style="color:#ae81ff">actions/setup-go@v3</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">with</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">go-version-file</span>: <span style="color:#e6db74">&#39;${{ github.workspace }}/go.mod&#39;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Restore Go cache</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">uses</span>: <span style="color:#ae81ff">actions/cache@v3</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">with</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/home/runner/work/_temp/_github_home/go/pkg/mod</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">key</span>: <span style="color:#ae81ff">${{ runner.os }}-go-${{ hashFiles(&#39;**/go.sum&#39;) }}</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">restore-keys</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            ${{ runner.os }}-go-</span>            
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Run e2e</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">run</span>: <span style="color:#ae81ff">make e2e</span>
</span></span></code></pre></div><p>This is nothing fancy. The fancy thing is coming from the <code>make e2e</code> part.</p>
<p>First, we make sure we have mkcert:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Makefile" data-lang="Makefile"><span style="display:flex;"><span>MKCERT <span style="color:#f92672">?=</span> <span style="color:#66d9ef">$(</span>LOCALBIN<span style="color:#66d9ef">)</span>/mkcert
</span></span><span style="display:flex;"><span>MKCERT_VERSION <span style="color:#f92672">?=</span> v1.4.4
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">...</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">.PHONY</span><span style="color:#f92672">:</span> mkcert
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">mkcert</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">$(</span>MKCERT<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">$(MKCERT)</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">$(</span>LOCALBIN<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>	curl -L <span style="color:#e6db74">&#34;https://github.com/FiloSottile/mkcert/releases/download/</span><span style="color:#66d9ef">$(</span>MKCERT_VERSION<span style="color:#66d9ef">)</span><span style="color:#e6db74">/mkcert-</span><span style="color:#66d9ef">$(</span>MKCERT_VERSION<span style="color:#66d9ef">)</span><span style="color:#e6db74">-</span><span style="color:#66d9ef">$(</span>UNAME<span style="color:#66d9ef">)</span><span style="color:#e6db74">-amd64&#34;</span> -o <span style="color:#66d9ef">$(</span>LOCALBIN<span style="color:#66d9ef">)</span>/mkcert
</span></span><span style="display:flex;"><span>	chmod +x <span style="color:#66d9ef">$(</span>LOCALBIN<span style="color:#66d9ef">)</span>/mkcert
</span></span></code></pre></div><p>Then, let&rsquo;s add a target which we&rsquo;ll call before the test is called:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Makefile" data-lang="Makefile"><span style="display:flex;"><span><span style="color:#a6e22e">.PHONY</span><span style="color:#f92672">:</span> generate-developer-certs
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">generate-developer-certs</span><span style="color:#f92672">:</span> mkcert
</span></span><span style="display:flex;"><span>	./hack/create_developer_certificate_secrets.sh
</span></span></code></pre></div><p>Lastly, put this as a dependency on our test target:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Makefile" data-lang="Makefile"><span style="display:flex;"><span><span style="color:#a6e22e">.PHONY</span><span style="color:#f92672">:</span> e2e
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">e2e</span><span style="color:#f92672">:</span> generate-developer-certs test-summary-tool <span style="color:#75715e">## Runs e2e tests
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">$(</span>GOTESTSUM<span style="color:#66d9ef">)</span> --format testname -- -count<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> -tags<span style="color:#f92672">=</span>e2e ./e2e
</span></span></code></pre></div><p>That&rsquo;s all the setup we need in the GitHub action workflow part. Now, let&rsquo;s take a look at the magic:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># You can ignore this.</span>
</span></span><span style="display:flex;"><span>path<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>pwd<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>path<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">==</span> *hack* <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>  echo <span style="color:#e6db74">&#34;This script is intended to be executed from the project root.&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  exit <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>kubectl get secret -n ocm-system registry-certs<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>  echo <span style="color:#e6db74">&#34;secret already exist, no need to re-run&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  exit <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;generating developer certificates and kubernetes secrets&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Set up certificate paths</span>
</span></span><span style="display:flex;"><span>CAROOT<span style="color:#f92672">=</span>./hack/certs ./bin/mkcert -install
</span></span><span style="display:flex;"><span>certPath<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;./hack/certs/cert.pem&#34;</span>
</span></span><span style="display:flex;"><span>keyPath<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;./hack/certs/key.pem&#34;</span>
</span></span><span style="display:flex;"><span>rootCAPath<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;./hack/certs/rootCA.pem&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;updating root certificate&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sudo cat <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>rootCAPath<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> | sudo tee -a /etc/ssl/certs/ca-certificates.crt <span style="color:#f92672">||</span> echo <span style="color:#e6db74">&#34;failed to append to ca-certificates. Ignoring the failure&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> ! -e <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>certPath<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">[</span> ! -e <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>keyPath<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>  echo -n <span style="color:#e6db74">&#34;certificates not found, generating...&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  CAROOT<span style="color:#f92672">=</span>./hack/certs ./bin/mkcert -cert-file ./hack/certs/cert.pem -key-file ./hack/certs/key.pem registry.ocm-system.svc.cluster.local localhost 127.0.0.1 ::1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  echo <span style="color:#e6db74">&#34;done&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>  echo <span style="color:#e6db74">&#34;certificates found, will not re-generate&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># You can ignore this.</span>
</span></span><span style="display:flex;"><span>echo -n <span style="color:#e6db74">&#34;creating secret...&#34;</span>
</span></span><span style="display:flex;"><span>kubectl create secret generic <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -n ocm-system registry-certs <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --from-file<span style="color:#f92672">=</span>caFile<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>rootCAPath<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --from-file<span style="color:#f92672">=</span>certFile<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>certPath<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --from-file<span style="color:#f92672">=</span>keyFile<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>keyPath<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --dry-run<span style="color:#f92672">=</span>client -o yaml &gt; ./hack/certs/registry_certs_secret.yaml
</span></span></code></pre></div><p>Let&rsquo;s break this down line by line:</p>
<p>1-15: Ignore this part. It&rsquo;s just checking some things before running.
19: This is calling <code>mkcert</code> but notice the <code>CAROOT</code> setting. This will output the root certificate to that location.
27: Now, this is the important bit. Here, since we are using <code>Ubuntu</code> machine type, we append our certificate to the
system&rsquo;s root certificates. There are other ways to do this but none of them will work properly on GitHub actions or
requires way too much fiddling. This is a heck of a lot easier to execute.
29-37: If the certificates do not exist it will create them. This, again, is using the configured ROOT location. This
is done so that when this script is running locally, it doesn&rsquo;t continue re-generating the certificates constantly.
39-45: Here, we create the secret which will contain our certificates.</p>
<p>So that&rsquo;s the script.</p>
<h2 id="how-to-automatically-create-developer-certificates">How to automatically create developer certificates<a hidden class="anchor" aria-hidden="true" href="#how-to-automatically-create-developer-certificates">#</a></h2>
<p>To do this automatically we use a combination of Makefile targets and Tilt. Tilt configures the mount and Makefile target
calls <code>mkcert</code> and the script and then runs the e2e tests locally using <code>Kind</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">for</span> o <span style="color:#f92672">in</span> objects:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> o<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;kind&#39;</span>) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;Deployment&#39;</span> <span style="color:#f92672">and</span> o<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;metadata&#39;</span>)<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;name&#39;</span>) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;ocm-controller&#39;</span>:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#39;updating ocm-controller deployment to add generated certificates&#39;</span>)
</span></span><span style="display:flex;"><span>        o[<span style="color:#e6db74">&#39;spec&#39;</span>][<span style="color:#e6db74">&#39;template&#39;</span>][<span style="color:#e6db74">&#39;spec&#39;</span>][<span style="color:#e6db74">&#39;volumes&#39;</span>] <span style="color:#f92672">=</span> [{<span style="color:#e6db74">&#39;name&#39;</span>: <span style="color:#e6db74">&#39;root-certificate&#39;</span>, <span style="color:#e6db74">&#39;secret&#39;</span>: {<span style="color:#e6db74">&#39;secretName&#39;</span>: <span style="color:#e6db74">&#39;registry-certs&#39;</span>, <span style="color:#e6db74">&#39;items&#39;</span>: [{<span style="color:#e6db74">&#39;key&#39;</span>: <span style="color:#e6db74">&#39;caFile&#39;</span>, <span style="color:#e6db74">&#39;path&#39;</span>: <span style="color:#e6db74">&#39;ca.pem&#39;</span>}]}}]
</span></span><span style="display:flex;"><span>        o[<span style="color:#e6db74">&#39;spec&#39;</span>][<span style="color:#e6db74">&#39;template&#39;</span>][<span style="color:#e6db74">&#39;spec&#39;</span>][<span style="color:#e6db74">&#39;containers&#39;</span>][<span style="color:#ae81ff">0</span>][<span style="color:#e6db74">&#39;volumeMounts&#39;</span>] <span style="color:#f92672">=</span> [{<span style="color:#e6db74">&#39;mountPath&#39;</span>: <span style="color:#e6db74">&#39;/certs&#39;</span>, <span style="color:#e6db74">&#39;name&#39;</span>: <span style="color:#e6db74">&#39;root-certificate&#39;</span>}]
</span></span></code></pre></div><p>The name can be made configurable with an environment property, but here we just ignore that in the dev environment.</p>
<h3 id="adding-the-root-certificate-to-the-container">Adding the root certificate to the container<a hidden class="anchor" aria-hidden="true" href="#adding-the-root-certificate-to-the-container">#</a></h3>
<p>To add the root certificate to the container in which our controller is running, we use an entrypoint.sh script.
We get the root certificate that is mounted into the container and then append that rootCA to the system CA. When done
we launch our manager.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env sh
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>rootCA<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>REGISTRY_ROOT_CERTIFICATE<span style="color:#66d9ef">:-</span>/certs/ca.pem<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> ! -e <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>rootCA<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>  echo <span style="color:#e6db74">&#34;warning... root certificate at location </span><span style="color:#e6db74">${</span>rootCA<span style="color:#e6db74">}</span><span style="color:#e6db74"> not found.&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  exec <span style="color:#e6db74">&#34;</span>$@<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;updating root certificate with provided certificate...&#34;</span>
</span></span><span style="display:flex;"><span>tee -a /etc/ssl/certs/ca-certificates.crt &lt; <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>rootCA<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;done.&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>exec <span style="color:#e6db74">&#34;</span>$@<span style="color:#e6db74">&#34;</span>
</span></span></code></pre></div><p>That&rsquo;s all we need. With this, our controller will now understand our self-signed certificate or any certificate that is
provided to the controller if it exists.</p>
<h2 id="conclusion">Conclusion<a hidden class="anchor" aria-hidden="true" href="#conclusion">#</a></h2>
<p>This is it. We have all the things we need for a self-signer certificate to seamlessly work in dev and in CI environment.
The whole project with all the files can be found here: <a href="https://github.com/open-component-model/ocm-controller">ocm-controller</a>.</p>
<p>Thank you for reading!</p>
<p>Gergely.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="https://skarlso.github.io/2023/07/28/digital-and-analog-notes-together/">
    <span class="title">« Prev</span>
    <br>
    <span>Digital and Analog notes together</span>
  </a>
  <a class="next" href="https://skarlso.github.io/2023/05/11/comments-are-back/">
    <span class="title">Next »</span>
    <br>
    <span>Comments are back</span>
  </a>
</nav>

  </footer><div id="disqus_thread"></div>
<script>
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "hannibalDisqus" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="https://skarlso.github.io/">Ramblings of a cloud engineer</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
