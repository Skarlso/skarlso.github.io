<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Rapid Kubernetes Controller Development with Tilt | Ramblings of a cloud engineer</title>
<meta name="keywords" content="">
<meta name="description" content="Welcome dear reader.
Today, we are going to dive into how to use Tilt to speed up the feedback loop of developing a
Kubernetes controller. We are going to do that using an open-source project called OCM which has
a controller called ocm-controller. I&rsquo;m going to walk through the
following process:

researching tilt
what it could do for me
understanding the Tilt file
trivial mapping of the developer process
understanding Starlark
adding more features
tackling hot swapping
troubleshooting

Let&rsquo;s dive in.">
<meta name="author" content="hannibal">
<link rel="canonical" href="https://skarlso.github.io/2023/02/25/rapid-controller-development-with-tilt/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css" integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://skarlso.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://skarlso.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://skarlso.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://skarlso.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://skarlso.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://skarlso.github.io/2023/02/25/rapid-controller-development-with-tilt/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Rapid Kubernetes Controller Development with Tilt">
<meta property="og:description" content="Welcome dear reader.
Today, we are going to dive into how to use Tilt to speed up the feedback loop of developing a
Kubernetes controller. We are going to do that using an open-source project called OCM which has
a controller called ocm-controller. I&rsquo;m going to walk through the
following process:

researching tilt
what it could do for me
understanding the Tilt file
trivial mapping of the developer process
understanding Starlark
adding more features
tackling hot swapping
troubleshooting

Let&rsquo;s dive in.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://skarlso.github.io/2023/02/25/rapid-controller-development-with-tilt/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2023-02-25T01:01:00+01:00">
<meta property="article:modified_time" content="2023-02-25T01:01:00+01:00">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Rapid Kubernetes Controller Development with Tilt">
<meta name="twitter:description" content="Welcome dear reader.
Today, we are going to dive into how to use Tilt to speed up the feedback loop of developing a
Kubernetes controller. We are going to do that using an open-source project called OCM which has
a controller called ocm-controller. I&rsquo;m going to walk through the
following process:

researching tilt
what it could do for me
understanding the Tilt file
trivial mapping of the developer process
understanding Starlark
adding more features
tackling hot swapping
troubleshooting

Let&rsquo;s dive in.">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://skarlso.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Rapid Kubernetes Controller Development with Tilt",
      "item": "https://skarlso.github.io/2023/02/25/rapid-controller-development-with-tilt/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Rapid Kubernetes Controller Development with Tilt",
  "name": "Rapid Kubernetes Controller Development with Tilt",
  "description": "Welcome dear reader.\nToday, we are going to dive into how to use Tilt to speed up the feedback loop of developing a Kubernetes controller. We are going to do that using an open-source project called OCM which has a controller called ocm-controller. I\u0026rsquo;m going to walk through the following process:\nresearching tilt what it could do for me understanding the Tilt file trivial mapping of the developer process understanding Starlark adding more features tackling hot swapping troubleshooting Let\u0026rsquo;s dive in.\n",
  "keywords": [
    
  ],
  "articleBody": "Welcome dear reader.\nToday, we are going to dive into how to use Tilt to speed up the feedback loop of developing a Kubernetes controller. We are going to do that using an open-source project called OCM which has a controller called ocm-controller. I’m going to walk through the following process:\nresearching tilt what it could do for me understanding the Tilt file trivial mapping of the developer process understanding Starlark adding more features tackling hot swapping troubleshooting Let’s dive in.\nRapid controller development with Tilt Tilt If you know some things about Tilt already, skip ahead to where I’ll be applying its concepts to the controller here.\nWhat is Tilt Tilt is a tool we can use to automate build and deploy processes for microservices. Technically, it can handle so much more than just a simple controller, but we are going to use this example to keep it simple for a first start.\nWhat can it do It is almost like a controller itself. It has an internal control loop that constantly “reconciles” the environment to make sure it’s up-to-date. I’m using quotes because it’s not 100% like that. It doesn’t recreate if something is deleted. But it does update them if the configuration changes. For example, if you create a secret with an incorrect name, and change its name, there won’t be two secrets, one with the correct name, and the other with an incorrect name, but one secret with the correct name.\nReading the documentation - where to start You can start by visiting the docs and then jumping right into First Look At Tilt.\nThis will guide you through setting up Tilt. There is one thing I don’t like here… It’s starting by using a demo application and a special command called tilt demo. I believe that this is not a great way to begin because you will never run this command again. I would have preferred to do a walkthrough like the one I’m going to write now. But, this is my view. Others might find the demo app more useful. Nevertheless, it’s useful to read through it to understand the basic concepts and the application (avatar generator) is pretty sweet!\nConcepts You can read all about the concepts here.\nTL;DR:\nTilt uses building blocks called Resources that it manages. A resource can be anything from a Deployment or a local file or a script or a service. It does that so it can track them separately and display them in a shiny UI.\nControl Loop The control loop is described here.\nTL;DR:\nIt’s a feedback loop around things that happen and things that Tilt watches. Tilt continuously watches resources and reacts to their changes in ways that are described in the Tiltfile. Another interesting effect of this is that if a resource is already running in your cluster it won’t try to rebuild/redeploy that.\nTiltfile We are going to dive deep into the Tiltfile a bit later, for now, it’s the main file that describes the behavior of tilt. It’s using Starlark which is a dialect of Python. Here is an example:\n# Define a number number = 18 # Define a dictionary people = { \"Alice\": 22, \"Bob\": 40, \"Charlie\": 55, \"Dave\": 14, } names = \", \".join(people.keys()) # Alice, Bob, Charlie, Dave # Define a function def greet(name): \"\"\"Return a greeting.\"\"\" return \"Hello {}!\".format(name) greeting = greet(names) above30 = [name for name, age in people.items() if age \u003e= 30] print(\"{} people are above 30.\".format(len(above30))) def fizz_buzz(n): \"\"\"Print Fizz Buzz numbers from 1 to n.\"\"\" for i in range(1, n + 1): s = \"\" if i % 3 == 0: s += \"Fizz\" if i % 5 == 0: s += \"Buzz\" print(s if s else i) fizz_buzz(20) This syntax is used for configuration. As you can see, it supports various Python things which give the user the ability to do virtually anything in Tilt.\ndownload yaml manifests mutate objects changes deployments before applying them ( this will be important later ) run a local script fetch something from a remote location Anything is possible.\nA Tiltfile has a bunch of built-in functions and APIs which are described here.\nHowever, I found that THIS API page will be your best friend together with the extensions list Tilt Extensions. Tilt’s functionality is extended using extensions that are loaded using an expression like this load('ext://restart_process', 'docker_build_with_restart').\nDuring troubleshooting, reading the extension’s code or documentation can often be helpful.\nThe Writing your first Tiltfile guide is pretty good though for demystifying and understanding the dialect. It’s rather basic but that’s all you need to get started. So next, let’s dive into how to gradually build up a complex Tiltfile and development process.\nThe development process of a controller Basic flow When you are building a controller you have a couple of choices:\nrun the controller locally on your machine by calling the compile manager binary Most of the time you’d do this but by doing this, you are skipping testing in cluster communication, RBAC, service discovery, etc. Also, it gets cumbersome to constantly port-forward other services being used by your controller to access them.\nbuild a container and push it to a registry and publish the deployment with the given container image and tag This is good if you want to test the release process of new containers. But takes a lot of time.\nuse a local docker registry with kind (https://kind.sigs.k8s.io/docs/user/local-registry/) and do a cycle of constant build/push/deploy like this\ndocker build -t localhost:5001/open-component-model/ocm-controller:v0.0.1 . ... docker push localhost:5001/open-component-model/ocm-controller:v0.0.1 All of these take time. Building a docker container, even when it’s reusing layers, takes time. For ocm-controller, on my machine, it takes about two minutes or so. Then push and deploy takes another couple of seconds.\nTilt can help a lot in speeding up this process. We’ll see about that later.\nMapping flow to Tiltfile We are going to choose the third option. Tilt has its local registry and uses unique build tags for each container to be able to debug problems for a specific change.\nAs a first step, to keep it simple, we map the process of installing controller resources and deploying them using `docker_build``.\nUsually, a controller uses kustomize. Tilt can leverage that. We can use kustomize to build a single install file that will create the deployment, the RBAX roles, and any other thing, like patches, configuration and the CRDs.\nTo do this, we simply run kustomize build ./config/default \u003e install.yaml. The install.yaml` will contain everything that can be applied to the cluster as is. Tilt can do the same thing using a very simple directive. Take a look at our first draft of a Tiltfile:\n# Apply the install file to the cluster k8s_yaml(kustomize('config/default')) docker_build('ghcr.io/open-component-model/ocm-controller', '.') By defining the docker_build directive we make it possible for Tilt to use a local registry. Internally, it will do its magic and change the deployment’s image to the right registry address.\nIn reality, this is the actual deployment that will be used:\nImage: localhost:5001/ghcr.io_open-component-model_ocm-controller:tilt-772cb281aa593470 Now, we can try and test our Tiltfile. To use tilt, simply run tilt up next to the Tiltfile. Press space and you should see your deployment starting up. Any errors will nicely be displayed on the respective resource.\nIf we make any changes to any of the files now, tilt will rebuild the entire container. This is already nice because this means that you don’t have to bother with building, pushing and updating the kustomize manifest to use the local registry. Tilt will take care of all that for us.\nBut wait… there is more!\nIntroducing settings For now, let’s upgrade our Tilt experience with a couple of settings so any user can customize their deployment for themselves. Starlark is just a Python dialect so we can do something like this:\n# -*- mode: Python -*- kubectl_cmd = \"kubectl\" # verify kubectl command exists if str(local(\"command -v \" + kubectl_cmd + \" || true\", quiet = True)) == \"\": fail(\"Required command '\" + kubectl_cmd + \"' not found in PATH\") # set defaults settings = { \"create_secrets\": { \"enable\": True, \"token\": os.getenv(\"GITHUB_TOKEN\", \"\"), \"email\": os.getenv(\"GITHUB_EMAIL\", \"\"), \"user\": os.getenv(\"GITHUB_USER\", \"\"), }, \"forward_registry\": False, \"verification_keys\": {}, } # global settings tilt_file = \"./tilt-settings.yaml\" if os.path.exists(\"./tilt-settings.yaml\") else \"./tilt-settings.json\" settings.update(read_yaml( tilt_file, default = {}, )) Okay, what is happening here? Let’s break it down.\nkubectl_cmd is just a convenient variable so we don’t have to repeat the command as a string.\nThe next section checks whether the kubectl command exists. We are using a tilt built-in command called local to execute a local command called command.\nNow comes the interesting part. We define a dict. This is something akin to dict, but it’s a Starlark dict. You can check the dialect definition in the Specification. This doc will also be your best friend. The dict can be found here.\nNext, we define the variable tilt_file and assign it either json or a yaml extension with the name tilt-settings. After this comes another built-in directive called read_yaml. This is a versatile directive that will produce a yaml output from the given file. If the file is not found it will use default to set some default values. update will merge the two produced dict results.\nSo, with a local file like this:\ncreate_secrets: enabled: false We’ll get a dict like this:\nsettings = { \"create_secrets\": { \"enable\": False, }, \"forward_registry\": False, \"verification_keys\": {}, } We can override any values in our settings and customize the deployment.\nAdding more features Let’s add some more features. ocm uses flux for deployment and various other tasks. To help the user, add a simple flux bootstrap OR install. Maybe the user doesn’t want to bootstrap a repository but does want flux CRDs and components installed in the cluster. The two commands we would like to replicate are:\nflux bootstrap github --owner=skarlso --repository=ocm-flux-example --path . and simply\nflux install … depending on the user’s choice. First, we’ll extend our settings:\nsettings = { \"flux\": { \"enabled\": False, \"bootstrap\": True, \"repository\": os.getenv(\"FLUX_REPOSITORY\", \"podinfo-flux-example\"), \"owner\": os.getenv(\"FLUX_OWNER\", \"\"), \"path\": os.getenv(\"FLUX_PATH\", \".\"), }, \"create_secrets\": { \"enable\": True, \"token\": os.getenv(\"GITHUB_TOKEN\", \"\"), \"email\": os.getenv(\"GITHUB_EMAIL\", \"\"), \"user\": os.getenv(\"GITHUB_USER\", \"\"), }, \"forward_registry\": False, \"verification_keys\": {}, } Here, we used another built-in directive with os.getenv. These could just be empty, but we give the option of users to define environment properties instead of a file. Whichever is more convenient.\nNow, we’ll add the flux commands:\nflux_cmd = 'flux' opts = settings.get(\"flux\") if opts.get(\"enabled\"): if str(local(\"command -v \" + flux_cmd + \" || true\", quiet = True)) == \"\": fail(\"Required command '\" + flux_cmd + \"' not found in PATH\") if opts.get(\"bootstrap\"): local(\"%s bootstrap github --owner %s --repository %s --path %s\" % (flux_cmd, opts.get('owner'), opts.get('repository'), opts.get('path'))) else: local(flux_cmd + \" install\") Super easy. This feels familiar, doesn’t it? It’s just like when you first began using something like Ansible to code down some deployment or translate some weird script into a higher-order definition or a DSL.\nLet’s go one step further and try to make this nicer to read by using functions.\ndef bootstrap_or_install_flux(): opts = settings.get(\"flux\") if not opts.get(\"enabled\"): return if str(local(\"command -v \" + flux_cmd + \" || true\", quiet = True)) == \"\": fail(\"Required command '\" + flux_cmd + \"' not found in PATH\") # flux bootstrap github --owner=${FLUX_OWNER} --repository=${FLUX_REPOSITORY} --path ${FLUX_PATH} if opts.get(\"bootstrap\"): local(\"%s bootstrap github --owner %s --repository %s --path %s\" % (flux_cmd, opts.get('owner'), opts.get('repository'), opts.get('path'))) else: local(flux_cmd + \" install\") How does our complete Tiltfile now look like, you might wonder. Let’s take a look:\n# -*- mode: Python -*- kubectl_cmd = \"kubectl\" flux_cmd = \"flux\" # verify kubectl command exists if str(local(\"command -v \" + kubectl_cmd + \" || true\", quiet = True)) == \"\": fail(\"Required command '\" + kubectl_cmd + \"' not found in PATH\") # set defaults settings = { \"flux\": { \"enabled\": False, \"bootstrap\": True, \"repository\": os.getenv(\"FLUX_REPOSITORY\", \"podinfo-flux-example\"), \"owner\": os.getenv(\"FLUX_OWNER\", \"\"), \"path\": os.getenv(\"FLUX_PATH\", \".\"), }, \"forward_registry\": False, \"verification_keys\": {}, } # global settings tilt_file = \"./tilt-settings.yaml\" if os.path.exists(\"./tilt-settings.yaml\") else \"./tilt-settings.json\" settings.update(read_yaml( tilt_file, default = {}, )) def bootstrap_or_install_flux(): opts = settings.get(\"flux\") if not opts.get(\"enabled\"): return if str(local(\"command -v \" + flux_cmd + \" || true\", quiet = True)) == \"\": fail(\"Required command '\" + flux_cmd + \"' not found in PATH\") # flux bootstrap github --owner=${FLUX_OWNER} --repository=${FLUX_REPOSITORY} --path ${FLUX_PATH} if opts.get(\"bootstrap\"): local(\"%s bootstrap github --owner %s --repository %s --path %s\" % (flux_cmd, opts.get('owner'), opts.get('repository'), opts.get('path'))) else: local(flux_cmd + \" install\") # set up the development environment # check if flux is needed bootstrap_or_install_flux() # Use kustomize to build the install yaml files k8s_yaml(kustomize('config/default')) docker_build('ghcr.io/open-component-model/ocm-controller', '.') # This is new thing we added here to port-forward more on this a bit later. if settings.get('forward_registry'): k8s_resource('ocm-controller', extra_pod_selectors = [{'app': 'registry'}], port_forwards=5000) This looks pretty nice already. But there is a lot more that we can do.\nAdding secrets Another thing that OCM needs ( or any other deployment really ) is creating secrets for various things and deployments. OCM needs some docker registry credentials and some other credentials to pull things from outside repositories.\nCreating secrets can be done by using an extension. The particular extension we are looking for is secrets.\nWe will use three types. A from-file for creating a secret that contains an SSH key. A plain key/value secret for repository access. And a docker-registry type secret.\n# set defaults settings = { \"flux\": { \"enabled\": False, \"bootstrap\": True, \"repository\": os.getenv(\"FLUX_REPOSITORY\", \"podinfo-flux-example\"), \"owner\": os.getenv(\"FLUX_OWNER\", \"\"), \"path\": os.getenv(\"FLUX_PATH\", \".\"), }, \"install_unpacker\": { \"enabled\": False, \"path\": \"\", }, # Added this one # +++++++++++++++ \"create_secrets\": { \"enable\": True, \"token\": os.getenv(\"GITHUB_TOKEN\", \"\"), \"email\": os.getenv(\"GITHUB_EMAIL\", \"\"), \"user\": os.getenv(\"GITHUB_USER\", \"\"), }, # +++++++++++++++ \"forward_registry\": False, \"verification_keys\": {}, } # ... other stuff ... def create_secrets(): opts = settings.get(\"create_secrets\") if not opts.get(\"enable\"): return k8s_yaml(secret_yaml_registry(\"regcred\", \"ocm-system\", flags_dict = { 'docker-server': 'ghcr.io', 'docker-username': opts.get('user'), 'docker-email': opts.get('email'), 'docker-password': opts.get('token'), })) k8s_yaml(secret_from_dict(\"creds\", \"ocm-system\", inputs = { 'username' : opts.get('user'), 'password' : opts.get('token'), })) def create_verification_keys(): keys = settings.get(\"verification_keys\") if not keys: return for key, value in keys.items(): secret_create_generic(key, 'ocm-system', from_file=value) We added two new functions and an extension to the settings. Let’s break this down.\nk8s_yaml(secret_yaml_registry -\u003e this directive creates a yaml output which we apply to the cluster. Its kubectl equivalent would be\nkubectl create secret docker-registry -n ocm-system regcred \\ --docker-server=ghcr.io \\ --docker-username=$GITHUB_USER \\ --docker-password=$GITHUB_TOKEN \\ --docker-email=$GITHUB_EMAIL k8s_yaml(secret_from_dict -\u003e same here. Equivalent kubectl command: kubectl create secret generic creds --from-literal=username=$GITHUB_USER --from-literal=password=$GITHUB_TOKEN -n ocm-system\nNext, we have create_verification_keys. This is a bit trickier, but nothing too fancy. Verification keys are SSH keys that can be used to verify components. We can have multiple keys. Therefore, the setting is a dict. We loop through the dict and create a secret from each of those. This is what that setting could look like:\nverification_keys: alice: alice=./rsa.pub bob: bob=/Users/user/home/.ssh/bob.pub All valid values. If a key is missing or the path is wrong, tilt does a dry-run first, so before applying to the cluster there would be an error that the key cannot be found.\nPhew, this was quite a lot. But now, we have secrets. Next, is the most important topic of them all…\nHot-Swapping Hot-swapping is the most important ability of tilt of all of them. Instead of rebuilding the whole container it can just rebuild the binary and switch out the running process. This is nothing new but combined with Kubernetes and the controller development cycle will provide us with valuable time saved.\nTo do that though, we first, need to give Tilt some new abilities.\nLetting Tilt build the controller Tilt needs to manage the building of the binary for our project. Lucky for me, ocm is pretty basic in its design. Doesn’t require anything too weird. Not that tilt doesn’t support weird, it does, with custom builds, but for me, this wasn’t needed.\nAnd I suspect for most controllers that is the case. Let’s add something called a local_resource.\nlocal_resource( 'manager', 'CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o bin/manager ./', deps = [ \"main.go\", \"go.mod\", \"go.sum\", \"api\", \"controllers\", \"pkg\", ], ) A local_resource is similar to local. It executes a command on the host computer. However, it also creates a resource. Remember, that a resource is any unit of work that Tilt manages. To learn more read up here. The extra here is that whenever something changes in deps it will re-run the command and rebuild the resource.\nHere is the API definition of local_resource.\nThis means that whenever something changes in deps, like files in API or controllers or pkg, etc, tilt rebuilds our binary. It already monitors the component YAML files, now we also monitor the go files.\nWe can add any script here or anything that produces our binary.\nNow, we’ll modify our docker build. There are some gotcha’s there.\nRoot access The first gotcha is that Tilt requires root access to hot-swap processes. If you are doing it right, you are using a scratch container and something like this in your deployment:\nsecurityContext: runAsNonRoot: true seccompProfile: type: RuntimeDefault If you aren’t you really should be! First, problem is that scratch containers aren’t supported by Tilt because it expects certain commands to be in the container, like touch. So we add a very simple Dockerfile that only tilt will use.\nFROM alpine WORKDIR / COPY ./bin/manager /manager ENTRYPOINT [\"/manager\"] And, we have to get rid of the runAsNonRoot: true. Or rather, set it to false. Remember we are writing code here. So we just take the yaml, change that field, and apply it after we are finished updating the object. There is a little doc about that that you can read: Modifying YAML for Dev.\nLet’s take a look. The basic flow is:\nread in our kustomize files convert it to objects look for our deployment and change this setting compile it back to yaml apply We could also apply the objects separately but it’s nice to do it with the install yaml because it contains the CRDs and Kubernetes applies those first. It’s a server-side apply.\n# Use kustomize to build the install yaml files install = kustomize('config/default') # Update the root security group. Tilt requires root access to update the # running process. objects = decode_yaml_stream(install) for o in objects: if o.get('kind') == 'Deployment' and o.get('metadata').get('name') == 'ocm-controller': o['spec']['template']['spec']['securityContext']['runAsNonRoot'] = False break updated_install = encode_yaml_stream(objects) # Apply the updated yaml to the cluster. k8s_yaml(updated_install) And thus, if our kind is Deployment and the name is the one we are looking for ocm-controller we change that value under spec: template: spec: securityContext:. DONE. Next!\nWith restart Now that we have the right Dockerfile and the right deployment, let’s use another extension called restart_process.\nload('ext://restart_process', 'docker_build_with_restart') Load the extension and then change the docker_build to docker_build_with_restart like this:\ndocker_build_with_restart( 'ghcr.io/open-component-model/ocm-controller', '.', dockerfile = 'tilt.dockerfile', entrypoint = ['/manager'], only=[ './bin', ], live_update = [ sync('./bin/manager', '/manager'), ], ) Let’s break this down. We have two pretty straightforward things. The first is the name of the container. The second is the context. The third is dockerfile our custom alpine container.\nFourth is entrypoint. Now comes the only part and the live_update. The only part here is important. This tells Tilt to only watch that folder for changes. Since the local_resource is already watching for changes to the binary the deployment only needs to care about that!\nlive_update tells Tilt what to change in the container. We copy from the local bin/managerto the container/manager. It can also execute a script in the container, but we don't need that here. For example, a restart.sh. Or, in the case of python a pip install -r requirements.txt` or something like that.\nThe rest is taken care of by a Tilt wrapper; a bash script that can swap out processes. That’s what docker_build_with_restart does. It wraps our container and Dockerfile into its container and runs our entrypoint.\nAttaching a debugger But I’m running the manager locally because I use a debugger.\nI hear you! And it’s possible with Tilt as well! We need to do a couple of things to achieve running delve correctly. Luckily, once set up, it should work for the foreseeable future.\nFirst, let’s alter our settings and include a debug value:\n# set defaults settings = { \"flux\": { \"enabled\": False, \"bootstrap\": True, \"repository\": os.getenv(\"FLUX_REPOSITORY\", \"podinfo-flux-example\"), \"owner\": os.getenv(\"FLUX_OWNER\", \"\"), \"path\": os.getenv(\"FLUX_PATH\", \".\"), }, \"install_unpacker\": { \"enabled\": False, \"path\": \"\", }, \"debug\": { \"enabled\": False, }, \"create_secrets\": { \"enable\": True, \"token\": os.getenv(\"GITHUB_TOKEN\", \"\"), \"email\": os.getenv(\"GITHUB_EMAIL\", \"\"), \"user\": os.getenv(\"GITHUB_USER\", \"\"), }, \"forward_registry\": False, \"verification_keys\": {}, } Once enabled, for simplicity, we will forward delve on port 30000.\nNext, we need a dedicated Dockerfile that installs and runs delve.\nFROM golang:1.20.1 WORKDIR / COPY ./bin/manager /manager RUN go install github.com/go-delve/delve/cmd/dlv@latest RUN chmod +x /go/bin/dlv RUN mv /go/bin/dlv / EXPOSE 30000 ENTRYPOINT [\"/dlv\", \"--listen=:30000\", \"--api-version=2\", \"--headless=true\", \"--continue=true\", \"--accept-multiclient=true\", \"exec\", \"/manager\", \"--\"] The two important settings here are --continue and --accept-multiclient. Without it, delve will stop the process and our readiness and liveliness probes will fail. Another super important part is -- at the end. Without it, our manager will not get the arguments passed in by the deployment. Or rather, it will try to pass them to delve.\nWith delve in place, now we get to the funky part. We need to tell Tilt to use our debug Dockerfile and change the entrypoint if debugging is enabled. Also, let’s not forget that the deployment needs to port-forward 30000 otherwise we can’t access it with our debugger. Another thing we SHOULD do is, alter the Go build process and add some flags. Usually, when debugging Go code you want the flags -N -l. We add that with a variable called gcflags.\n# ... other things ... # Update the root security group. Tilt requires root access to update the # running process. objects = decode_yaml_stream(install) for o in objects: if o.get('kind') == 'Deployment' and o.get('metadata').get('name') == 'ocm-controller': o['spec']['template']['spec']['securityContext']['runAsNonRoot'] = False # This is what we added. OCM has a single container so we don't need to look for a specific one. if settings.get('debug').get('enabled'): o['spec']['template']['spec']['containers'][0]['ports'] = [{'containerPort': 30000}] break # ... other things .... # Update our Go build and add conditional gcflags. gcflags = '' if settings.get('debug').get('enabled'): gcflags = '-N -l' local_resource( 'manager', \"CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -gcflags '{gcflags}' -o bin/manager ./\".format(gcflags=gcflags), deps = [ \"main.go\", \"go.mod\", \"go.sum\", \"api\", \"controllers\", \"pkg\", ], ) # ... other things ... # Finally, our port-forwarding and the addition of the updated entrypoint and dockerfile. # The `[]` syntax on entrypoint is important because we want tilt to be able to append to it. entrypoint = ['/manager'] dockerfile = 'tilt.dockerfile' if settings.get('debug').get('enabled'): k8s_resource('ocm-controller', port_forwards=[ port_forward(30000, 30000, 'debugger'), ]) entrypoint = ['/dlv', '--listen=:30000', '--api-version=2', '--continue=true', '--accept-multiclient=true', '--headless=true', 'exec', '/manager', '--'] dockerfile = 'tilt.debug.dockerfile' docker_build_with_restart( 'ghcr.io/open-component-model/ocm-controller', '.', dockerfile = dockerfile, entrypoint = entrypoint, only=[ './bin', ], live_update = [ sync('./bin/manager', '/manager'), ], ) Now, to attach to the debugger in GoLand follow this guide: Attach To Remote Debugger.\nThe only important piece there is to clear the Shutdown remote debugger on disconnect flag.\nIn VSCode:\n{ \"name\": \"Connect to Container\", \"type\": \"go\", \"request\": \"attach\", \"mode\": \"remote\", \"remotePath\": \"\", \"port\": 30000, \"host\": \"127.0.0.1\", \"showLog\": true, \"trace\": \"log\", \"logOutput\": \"rpc\" } And that’s it! We got delve working.\nLet’s take a look at the full Tiltfile.\n# -*- mode: Python -*- kubectl_cmd = \"kubectl\" flux_cmd = \"flux\" # verify kubectl command exists if str(local(\"command -v \" + kubectl_cmd + \" || true\", quiet = True)) == \"\": fail(\"Required command '\" + kubectl_cmd + \"' not found in PATH\") # set defaults settings = { \"flux\": { \"enabled\": False, \"bootstrap\": True, \"repository\": os.getenv(\"FLUX_REPOSITORY\", \"podinfo-flux-example\"), \"owner\": os.getenv(\"FLUX_OWNER\", \"\"), \"path\": os.getenv(\"FLUX_PATH\", \".\"), }, \"install_unpacker\": { \"enabled\": False, \"path\": \"\", }, \"debug\": { \"enabled\": False, }, \"create_secrets\": { \"enable\": True, \"token\": os.getenv(\"GITHUB_TOKEN\", \"\"), \"email\": os.getenv(\"GITHUB_EMAIL\", \"\"), \"user\": os.getenv(\"GITHUB_USER\", \"\"), }, \"forward_registry\": False, \"verification_keys\": {}, } # global settings tilt_file = \"./tilt-settings.yaml\" if os.path.exists(\"./tilt-settings.yaml\") else \"./tilt-settings.json\" settings.update(read_yaml( tilt_file, default = {}, )) load('ext://secret', 'secret_yaml_registry', 'secret_from_dict', 'secret_create_generic') def bootstrap_or_install_flux(): opts = settings.get(\"flux\") if not opts.get(\"enabled\"): return if str(local(\"command -v \" + flux_cmd + \" || true\", quiet = True)) == \"\": fail(\"Required command '\" + flux_cmd + \"' not found in PATH\") # flux bootstrap github --owner=${FLUX_OWNER} --repository=${FLUX_REPOSITORY} --path ${FLUX_PATH} if opts.get(\"bootstrap\"): local(\"%s bootstrap github --owner %s --repository %s --path %s\" % (flux_cmd, opts.get('owner'), opts.get('repository'), opts.get('path'))) else: local(flux_cmd + \" install\") def install_unpacker(): opts = settings.get(\"install_unpacker\") if not opts.get(\"enabled\"): return def create_secrets(): opts = settings.get(\"create_secrets\") if not opts.get(\"enable\"): return k8s_yaml(secret_yaml_registry(\"regcred\", \"ocm-system\", flags_dict = { 'docker-server': 'ghcr.io', 'docker-username': opts.get('user'), 'docker-email': opts.get('email'), 'docker-password': opts.get('token'), })) k8s_yaml(secret_from_dict(\"creds\", \"ocm-system\", inputs = { 'username' : opts.get('user'), 'password' : opts.get('token'), })) def create_verification_keys(): keys = settings.get(\"verification_keys\") if not keys: return for key, value in keys.items(): secret_create_generic(key, 'ocm-system', from_file=value) # set up the development environment # check if flux is needed bootstrap_or_install_flux() # check if installing unpacker is needed install_unpacker() # Use kustomize to build the install yaml files install = kustomize('config/default') # Update the root security group. Tilt requires root access to update the # running process. objects = decode_yaml_stream(install) for o in objects: if o.get('kind') == 'Deployment' and o.get('metadata').get('name') == 'ocm-controller': o['spec']['template']['spec']['securityContext']['runAsNonRoot'] = False if settings.get('debug').get('enabled'): o['spec']['template']['spec']['containers'][0]['ports'] = [{'containerPort': 30000}] break updated_install = encode_yaml_stream(objects) # Apply the updated yaml to the cluster. k8s_yaml(updated_install) # Create Secrets create_secrets() create_verification_keys() load('ext://restart_process', 'docker_build_with_restart') # enable hot reloading by doing the following: # - locally build the whole project # - create a docker imagine using tilt's hot-swap wrapper # - push that container to the local tilt registry # Once done, rebuilding now should be a lot faster since only the relevant # binary is rebuilt and the hot swat wrapper takes care of the rest. gcflags = '' if settings.get('debug').get('enabled'): gcflags = '-N -l' local_resource( 'manager', \"CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -gcflags '{gcflags}' -o bin/manager ./\".format(gcflags=gcflags), deps = [ \"main.go\", \"go.mod\", \"go.sum\", \"api\", \"controllers\", \"pkg\", ], ) # Build the docker image for our controller. We use a specific Dockerfile # since tilt can't run on a scratch container. # `only` here is important, otherwise, the container will get updated # on _any_ file change. We only want to monitor the binary. # If debugging is enabled, we switch to a different docker file using # the delve port. entrypoint = ['/manager'] dockerfile = 'tilt.dockerfile' if settings.get('debug').get('enabled'): k8s_resource('ocm-controller', port_forwards=[ port_forward(30000, 30000, 'debugger'), ]) entrypoint = ['/dlv', '--listen=:30000', '--api-version=2', '--continue=true', '--accept-multiclient=true', '--headless=true', 'exec', '/manager', '--'] dockerfile = 'tilt.debug.dockerfile' docker_build_with_restart( 'ghcr.io/open-component-model/ocm-controller', '.', dockerfile = dockerfile, entrypoint = entrypoint, only=[ './bin', ], live_update = [ sync('./bin/manager', '/manager'), ], ) if settings.get('forward_registry'): k8s_resource('ocm-controller', extra_pod_selectors = [{'app': 'registry'}], port_forwards=5000) That last line extracts a resource that Tilt doesn’t control. But we can say that it’s the resource ocm-controller by defining a label selector.\nNumbers So what did we improve after ALL of this hassle? Well, let’s see. Before, we needed around 2 minutes to build and deploy then test something. With Tilt, now it’s 10-15 SECONDS tops! That is a huge improvement in the feedback loop.\nWhen it gets annoying Any drawbacks? Well, if you are using GoLand or save changes frequently, it will rebuild. On. Each. Save. That can be pretty annoying. Luckily, Tilt got you covered. If you would like to pause for a second to do some rapid-fire changes, disable the local_resource ( whatever you named it, for me it’s manager ) that is the Go Build. If you do that, no changes will be reconciled, which means, the container will not be hot-swapped either.\nLooks like this:\nOnce re-enabled, you can continue your development cycle.\nConclusion Tilt is not easy to set up at times. Especially when you have to fiddle with a lot of access and custom-built stuff. The syntax and view of a complex Tiltfile can be rather intimidating. Some structure adds easier ways of reading, but sadly, this is seldom the case.\nHowever, it can be helped. A nice Tiltfile with rightly named functions and a good structure can help a lot in readability. Also, comments. And I can’t stress this enough. Add comments! They help a lot for a new person reading the file and understanding what is being altered why and where.\nThe Tiltfile as it looks like at the writing of this post can be found here.\nI hope this helped, and good luck!\nAs always,\nThank you for reading, Gergely.\n",
  "wordCount" : "4706",
  "inLanguage": "en",
  "datePublished": "2023-02-25T01:01:00+01:00",
  "dateModified": "2023-02-25T01:01:00+01:00",
  "author":{
    "@type": "Person",
    "name": "hannibal"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://skarlso.github.io/2023/02/25/rapid-controller-development-with-tilt/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Ramblings of a cloud engineer",
    "logo": {
      "@type": "ImageObject",
      "url": "https://skarlso.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://skarlso.github.io/" accesskey="h" title="Ramblings of a cloud engineer (Alt + H)">Ramblings of a cloud engineer</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://skarlso.github.io/archives" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://skarlso.github.io/search/" title="Search">
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://skarlso.github.io/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://skarlso.github.io/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://skarlso.github.io/">Home</a>&nbsp;»&nbsp;<a href="https://skarlso.github.io/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      Rapid Kubernetes Controller Development with Tilt
    </h1>
    <div class="post-meta"><span title='2023-02-25 01:01:00 +0100 +0100'>February 25, 2023</span>&nbsp;·&nbsp;23 min&nbsp;·&nbsp;hannibal

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#rapid-controller-development-with-tilt" aria-label="Rapid controller development with Tilt">Rapid controller development with Tilt</a><ul>
                        
                <li>
                    <a href="#tilt" aria-label="Tilt">Tilt</a><ul>
                        
                <li>
                    <a href="#what-is-tilt" aria-label="What is Tilt">What is Tilt</a></li>
                <li>
                    <a href="#what-can-it-do" aria-label="What can it do">What can it do</a></li>
                <li>
                    <a href="#reading-the-documentation---where-to-start" aria-label="Reading the documentation - where to start">Reading the documentation - where to start</a><ul>
                        
                <li>
                    <a href="#concepts" aria-label="Concepts">Concepts</a></li>
                <li>
                    <a href="#control-loop" aria-label="Control Loop">Control Loop</a></li>
                <li>
                    <a href="#tiltfile" aria-label="Tiltfile">Tiltfile</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#the-development-process-of-a-controller" aria-label="The development process of a controller">The development process of a controller</a><ul>
                        
                <li>
                    <a href="#basic-flow" aria-label="Basic flow">Basic flow</a></li>
                <li>
                    <a href="#mapping-flow-to-tiltfile" aria-label="Mapping flow to Tiltfile">Mapping flow to Tiltfile</a></li>
                <li>
                    <a href="#introducing-settings" aria-label="Introducing settings">Introducing settings</a></li>
                <li>
                    <a href="#adding-more-features" aria-label="Adding more features">Adding more features</a><ul>
                        
                <li>
                    <a href="#adding-secrets" aria-label="Adding secrets">Adding secrets</a></li>
                <li>
                    <a href="#hot-swapping" aria-label="Hot-Swapping">Hot-Swapping</a><ul>
                        
                <li>
                    <a href="#letting-tilt-build-the-controller" aria-label="Letting Tilt build the controller">Letting Tilt build the controller</a></li>
                <li>
                    <a href="#root-access" aria-label="Root access">Root access</a></li>
                <li>
                    <a href="#with-restart" aria-label="With restart">With restart</a></li></ul>
                </li>
                <li>
                    <a href="#attaching-a-debugger" aria-label="Attaching a debugger">Attaching a debugger</a></li></ul>
                </li>
                <li>
                    <a href="#numbers" aria-label="Numbers">Numbers</a></li>
                <li>
                    <a href="#when-it-gets-annoying" aria-label="When it gets annoying">When it gets annoying</a></li></ul>
                </li>
                <li>
                    <a href="#conclusion" aria-label="Conclusion">Conclusion</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>Welcome dear reader.</p>
<p>Today, we are going to dive into how to use <a href="https://tilt.dev">Tilt</a> to speed up the feedback loop of developing a
Kubernetes controller. We are going to do that using an open-source project called <a href="https://ocm.software">OCM</a> which has
a controller called <a href="github.com/open-component-model/ocm-controller">ocm-controller</a>. I&rsquo;m going to walk through the
following process:</p>
<ul>
<li>researching tilt</li>
<li>what it could do for me</li>
<li>understanding the Tilt file</li>
<li>trivial mapping of the developer process</li>
<li>understanding Starlark</li>
<li>adding more features</li>
<li>tackling hot swapping</li>
<li>troubleshooting</li>
</ul>
<p>Let&rsquo;s dive in.</p>
<h1 id="rapid-controller-development-with-tilt">Rapid controller development with Tilt<a hidden class="anchor" aria-hidden="true" href="#rapid-controller-development-with-tilt">#</a></h1>
<h2 id="tilt">Tilt<a hidden class="anchor" aria-hidden="true" href="#tilt">#</a></h2>
<p><img alt="tilt" loading="lazy" src="/img/2023/02/25/tilt.png"></p>
<p>If you know some things about Tilt already, skip ahead to where I&rsquo;ll be applying its concepts to the controller <a href="/2023/02/25/rapid-controller-development-with-tilt/#development-process-of-an-controller">here</a>.</p>
<h3 id="what-is-tilt">What is Tilt<a hidden class="anchor" aria-hidden="true" href="#what-is-tilt">#</a></h3>
<p>Tilt is a tool we can use to automate build and deploy processes for microservices. Technically, it can handle so much
more than just a simple controller, but we are going to use this example to keep it simple for a first start.</p>
<h3 id="what-can-it-do">What can it do<a hidden class="anchor" aria-hidden="true" href="#what-can-it-do">#</a></h3>
<p>It is <em>almost</em> like a controller itself. It has an internal control loop that constantly &ldquo;reconciles&rdquo; the environment to
make sure it&rsquo;s up-to-date. I&rsquo;m using quotes because it&rsquo;s not 100% like that. It doesn&rsquo;t recreate if something is
deleted. But it <em>does</em> update them if the configuration changes. For example, if you create a secret with an incorrect
name, and change its name, there won&rsquo;t be two secrets, one with the correct name, and the other with an incorrect name,
but one secret with the correct name.</p>
<h3 id="reading-the-documentation---where-to-start">Reading the documentation - where to start<a hidden class="anchor" aria-hidden="true" href="#reading-the-documentation---where-to-start">#</a></h3>
<p><img alt="document-hell" loading="lazy" src="/img/2023/02/25/documentation-hell.png"></p>
<p>You can start by visiting the <a href="https://docs.tilt.dev">docs</a> and then jumping right into <a href="https://docs.tilt.dev/tutorial/index.html">First Look At Tilt</a>.</p>
<p>This will guide you through setting up Tilt. There is one thing I don&rsquo;t like here&hellip; It&rsquo;s starting by using a demo
application and a special command called <code>tilt demo</code>. I believe that this is not a great way to begin because you will
<em>never</em> run this command again. I would have preferred to do a walkthrough like the one I&rsquo;m going to write now. But,
this is <em>my</em> view. Others might find the demo app more useful. Nevertheless, it&rsquo;s useful to read through it to understand
the basic concepts and the application (avatar generator) is pretty sweet!</p>
<h4 id="concepts">Concepts<a hidden class="anchor" aria-hidden="true" href="#concepts">#</a></h4>
<p>You can read all about the concepts <a href="https://docs.tilt.dev/tiltfile_concepts.html">here</a>.</p>
<p>TL;DR:</p>
<p>Tilt uses building blocks called <a href="https://docs.tilt.dev/tiltfile_concepts.html#resources">Resources</a> that it manages.
A resource can be anything from a Deployment or a local file or a script or a service. It does that so it can track
them separately and display them in a shiny UI.</p>
<h4 id="control-loop">Control Loop<a hidden class="anchor" aria-hidden="true" href="#control-loop">#</a></h4>
<p>The control loop is described <a href="https://docs.tilt.dev/tutorial/2-tilt-up.html#the-control-loop">here</a>.</p>
<p>TL;DR:</p>
<p>It&rsquo;s a feedback loop around things that happen and things that Tilt watches. Tilt continuously watches resources and
reacts to their changes in ways that are described in the Tiltfile. Another interesting effect of this is that if a
resource is already running in your cluster it won&rsquo;t try to rebuild/redeploy that.</p>
<h4 id="tiltfile">Tiltfile<a hidden class="anchor" aria-hidden="true" href="#tiltfile">#</a></h4>
<p>We are going to dive deep into the Tiltfile a bit later, for now, it&rsquo;s the main file that describes the behavior of tilt.
It&rsquo;s using <a href="https://github.com/bazelbuild/starlark">Starlark</a> which is a dialect of Python. Here is an example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Define a number</span>
</span></span><span style="display:flex;"><span>number <span style="color:#f92672">=</span> <span style="color:#ae81ff">18</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Define a dictionary</span>
</span></span><span style="display:flex;"><span>people <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;Alice&#34;</span>: <span style="color:#ae81ff">22</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;Bob&#34;</span>: <span style="color:#ae81ff">40</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;Charlie&#34;</span>: <span style="color:#ae81ff">55</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;Dave&#34;</span>: <span style="color:#ae81ff">14</span>,
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>names <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;, &#34;</span><span style="color:#f92672">.</span>join(people<span style="color:#f92672">.</span>keys())  <span style="color:#75715e"># Alice, Bob, Charlie, Dave</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Define a function</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">greet</span>(name):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Return a greeting.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;Hello </span><span style="color:#e6db74">{}</span><span style="color:#e6db74">!&#34;</span><span style="color:#f92672">.</span>format(name)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>greeting <span style="color:#f92672">=</span> greet(names)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>above30 <span style="color:#f92672">=</span> [name <span style="color:#66d9ef">for</span> name, age <span style="color:#f92672">in</span> people<span style="color:#f92672">.</span>items() <span style="color:#66d9ef">if</span> age <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">30</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{}</span><span style="color:#e6db74"> people are above 30.&#34;</span><span style="color:#f92672">.</span>format(len(above30)))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">fizz_buzz</span>(n):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Print Fizz Buzz numbers from 1 to n.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>, n <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>):
</span></span><span style="display:flex;"><span>        s <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> i <span style="color:#f92672">%</span> <span style="color:#ae81ff">3</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>            s <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#34;Fizz&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> i <span style="color:#f92672">%</span> <span style="color:#ae81ff">5</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>            s <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#34;Buzz&#34;</span>
</span></span><span style="display:flex;"><span>        print(s <span style="color:#66d9ef">if</span> s <span style="color:#66d9ef">else</span> i)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>fizz_buzz(<span style="color:#ae81ff">20</span>)
</span></span></code></pre></div><p>This syntax is used for configuration. As you can see, it supports various Python things which give the user the ability
to do virtually anything in Tilt.</p>
<ul>
<li>download yaml manifests</li>
<li>mutate objects</li>
<li>changes deployments before applying them ( this will be important later )</li>
<li>run a local script</li>
<li>fetch something from a remote location</li>
</ul>
<p>Anything is possible.</p>
<p>A Tiltfile has a bunch of built-in functions and APIs which are described <a href="https://api.tilt.dev/">here</a>.</p>
<p>However, I found that <a href="https://docs.tilt.dev/api.html">THIS API</a> page will be your best friend together with the
extensions list <a href="https://github.com/tilt-dev/tilt-extensions">Tilt Extensions</a>. Tilt&rsquo;s functionality is extended using
extensions that are loaded using an expression like this <code>load('ext://restart_process', 'docker_build_with_restart')</code>.</p>
<p>During troubleshooting, reading the extension&rsquo;s code or documentation can often be helpful.</p>
<p>The <a href="https://docs.tilt.dev/tiltfile_authoring.html">Writing your first Tiltfile</a> guide is pretty good though for
demystifying and understanding the dialect. It&rsquo;s rather basic but that&rsquo;s all you need to get started. So next, let&rsquo;s
dive into how to gradually build up a complex Tiltfile and development process.</p>
<h2 id="the-development-process-of-a-controller">The development process of a controller<a hidden class="anchor" aria-hidden="true" href="#the-development-process-of-a-controller">#</a></h2>
<p><img alt="yaml-hell" loading="lazy" src="/img/2023/02/25/yaml-hell.png"></p>
<h3 id="basic-flow">Basic flow<a hidden class="anchor" aria-hidden="true" href="#basic-flow">#</a></h3>
<p>When you are building a controller you have a couple of choices:</p>
<ul>
<li>
<p>run the controller locally on your machine by calling the compile manager binary
Most of the time you&rsquo;d do this but by doing this, you are skipping testing in cluster communication, RBAC, service
discovery, etc. Also, it gets cumbersome to constantly port-forward other services being used by your controller to
access them.</p>
</li>
<li>
<p>build a container and push it to a registry and publish the deployment with the given container image and tag
This is good if you want to test the release process of new containers. But takes a lot of time.</p>
</li>
<li>
<p>use a local docker registry with kind (<a href="https://kind.sigs.k8s.io/docs/user/local-registry/">https://kind.sigs.k8s.io/docs/user/local-registry/</a>) and do a cycle of constant
build/push/deploy like this</p>
</li>
</ul>
<pre tabindex="0"><code>docker build -t localhost:5001/open-component-model/ocm-controller:v0.0.1 .
...
docker push localhost:5001/open-component-model/ocm-controller:v0.0.1
</code></pre><p>All of these take time. Building a docker container, even when it&rsquo;s reusing layers, takes time. For <code>ocm-controller</code>, on
my machine, it takes about two minutes or so. Then push and deploy takes another couple of seconds.</p>
<p>Tilt can help a lot in speeding up this process. We&rsquo;ll see about that later.</p>
<h3 id="mapping-flow-to-tiltfile">Mapping flow to Tiltfile<a hidden class="anchor" aria-hidden="true" href="#mapping-flow-to-tiltfile">#</a></h3>
<p><img alt="tilt-with-the-flow" loading="lazy" src="/img/2023/02/25/tilt-go-with-the-flow.png"></p>
<p>We are going to choose the third option. Tilt has its local registry and uses unique build tags for each container to be
able to debug problems for a specific change.</p>
<p>As a first step, to keep it simple, we map the process of installing controller resources and deploying them using
`docker_build``.</p>
<p>Usually, a controller uses <code>kustomize</code>. Tilt can leverage that. We can use <code>kustomize</code> to build a single install file
that will create the deployment, the RBAX roles, and any other thing, like patches, configuration and the CRDs.</p>
<p>To do this, we simply run <code>kustomize</code> build ./config/default &gt; install.yaml<code>. The </code>install.yaml` will contain everything
that can be applied to the cluster as is. Tilt can do the same thing using a very simple directive. Take a look at our
first draft of a Tiltfile:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Apply the install file to the cluster</span>
</span></span><span style="display:flex;"><span>k8s_yaml(kustomize(<span style="color:#e6db74">&#39;config/default&#39;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>docker_build(<span style="color:#e6db74">&#39;ghcr.io/open-component-model/ocm-controller&#39;</span>, <span style="color:#e6db74">&#39;.&#39;</span>)
</span></span></code></pre></div><p>By defining the <code>docker_build</code> directive we make it possible for Tilt to use a local registry. Internally, it will do its
magic and change the deployment&rsquo;s image to the right registry address.</p>
<p>In reality, this is the actual deployment that will be used:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">Image</span>:      <span style="color:#ae81ff">localhost:5001/ghcr.io_open-component-model_ocm-controller:tilt-772cb281aa593470</span>
</span></span></code></pre></div><p>Now, we can try and test our Tiltfile. To use tilt, simply run <code>tilt up</code> next to the Tiltfile.
Press <code>space</code> and you should see your deployment starting up. Any errors will nicely be displayed on the respective
resource.</p>
<p>If we make any changes to any of the files now, tilt will rebuild the entire container. This is already nice because
this means that you don&rsquo;t have to bother with building, pushing and updating the kustomize manifest to use the local
registry. Tilt will take care of all that for us.</p>
<p>But wait&hellip; there is more!</p>
<h3 id="introducing-settings">Introducing settings<a hidden class="anchor" aria-hidden="true" href="#introducing-settings">#</a></h3>
<p>For now, let&rsquo;s upgrade our Tilt experience with a couple of settings so any user can customize their deployment for
themselves. Starlark is just a Python dialect so we can do something like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># -*- mode: Python -*-</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl_cmd <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;kubectl&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># verify kubectl command exists</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> str(local(<span style="color:#e6db74">&#34;command -v &#34;</span> <span style="color:#f92672">+</span> kubectl_cmd <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; || true&#34;</span>, quiet <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>)) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span>:
</span></span><span style="display:flex;"><span>    fail(<span style="color:#e6db74">&#34;Required command &#39;&#34;</span> <span style="color:#f92672">+</span> kubectl_cmd <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;&#39; not found in PATH&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># set defaults</span>
</span></span><span style="display:flex;"><span>settings <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;create_secrets&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;enable&#34;</span>: <span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;token&#34;</span>: os<span style="color:#f92672">.</span>getenv(<span style="color:#e6db74">&#34;GITHUB_TOKEN&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;email&#34;</span>: os<span style="color:#f92672">.</span>getenv(<span style="color:#e6db74">&#34;GITHUB_EMAIL&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;user&#34;</span>: os<span style="color:#f92672">.</span>getenv(<span style="color:#e6db74">&#34;GITHUB_USER&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>),
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;forward_registry&#34;</span>: <span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;verification_keys&#34;</span>: {},
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># global settings</span>
</span></span><span style="display:flex;"><span>tilt_file <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;./tilt-settings.yaml&#34;</span> <span style="color:#66d9ef">if</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>exists(<span style="color:#e6db74">&#34;./tilt-settings.yaml&#34;</span>) <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&#34;./tilt-settings.json&#34;</span>
</span></span><span style="display:flex;"><span>settings<span style="color:#f92672">.</span>update(read_yaml(
</span></span><span style="display:flex;"><span>    tilt_file,
</span></span><span style="display:flex;"><span>    default <span style="color:#f92672">=</span> {},
</span></span><span style="display:flex;"><span>))
</span></span></code></pre></div><p>Okay, <em>what</em> is happening here? Let&rsquo;s break it down.</p>
<p><code>kubectl_cmd</code> is just a convenient variable so we don&rsquo;t have to repeat the command as a string.</p>
<p>The next section checks whether the <code>kubectl</code> command exists. We are using a tilt built-in command called <code>local</code> to
execute a local command called <code>command</code>.</p>
<p>Now comes the interesting part. We define a dict. This is something akin to dict, but it&rsquo;s a Starlark dict. You can
check the dialect definition in the <a href="https://github.com/bazelbuild/starlark/blob/master/spec.md">Specification</a>.
This doc will also be your best friend. The <a href="https://github.com/bazelbuild/starlark/blob/master/spec.md#dict">dict</a> can be found here.</p>
<p>Next, we define the variable <code>tilt_file</code> and assign it either <code>json</code> or a <code>yaml</code> extension with the name <code>tilt-settings</code>.
After this comes another built-in directive called <code>read_yaml</code>. This is a versatile directive that will produce a yaml
output from the given file. If the file is not found it will use <code>default</code> to set some default values. <code>update</code> will
merge the two produced dict results.</p>
<p>So, with a local file like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">create_secrets</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enabled</span>: <span style="color:#66d9ef">false</span>
</span></span></code></pre></div><p>We&rsquo;ll get a dict like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>settings <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;create_secrets&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;enable&#34;</span>: <span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;forward_registry&#34;</span>: <span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;verification_keys&#34;</span>: {},
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>We can override any values in our settings and customize the deployment.</p>
<h3 id="adding-more-features">Adding more features<a hidden class="anchor" aria-hidden="true" href="#adding-more-features">#</a></h3>
<p><img alt="feature-hell" loading="lazy" src="/img/2023/02/25/feature-hell.png"></p>
<p>Let&rsquo;s add some more features. ocm uses <a href="https://github.com/fluxcd/flux2">flux</a> for deployment and various other tasks.
To help the user, add a simple flux bootstrap OR install. Maybe the user doesn&rsquo;t want to bootstrap a repository but
does want flux CRDs and components installed in the cluster. The two commands we would like to replicate are:</p>
<pre tabindex="0"><code>flux bootstrap github --owner=skarlso --repository=ocm-flux-example --path .
</code></pre><p>and simply</p>
<pre tabindex="0"><code>flux install
</code></pre><p>&hellip; depending on the user&rsquo;s choice. First, we&rsquo;ll extend our settings:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>settings <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;flux&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;enabled&#34;</span>: <span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;bootstrap&#34;</span>: <span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;repository&#34;</span>: os<span style="color:#f92672">.</span>getenv(<span style="color:#e6db74">&#34;FLUX_REPOSITORY&#34;</span>, <span style="color:#e6db74">&#34;podinfo-flux-example&#34;</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;owner&#34;</span>: os<span style="color:#f92672">.</span>getenv(<span style="color:#e6db74">&#34;FLUX_OWNER&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;path&#34;</span>: os<span style="color:#f92672">.</span>getenv(<span style="color:#e6db74">&#34;FLUX_PATH&#34;</span>, <span style="color:#e6db74">&#34;.&#34;</span>),
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;create_secrets&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;enable&#34;</span>: <span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;token&#34;</span>: os<span style="color:#f92672">.</span>getenv(<span style="color:#e6db74">&#34;GITHUB_TOKEN&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;email&#34;</span>: os<span style="color:#f92672">.</span>getenv(<span style="color:#e6db74">&#34;GITHUB_EMAIL&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;user&#34;</span>: os<span style="color:#f92672">.</span>getenv(<span style="color:#e6db74">&#34;GITHUB_USER&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>),
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;forward_registry&#34;</span>: <span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;verification_keys&#34;</span>: {},
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Here, we used another built-in directive with <code>os.getenv</code>. These could just be empty, but we give the option of users
to define environment properties instead of a file. Whichever is more convenient.</p>
<p>Now, we&rsquo;ll add the flux commands:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>flux_cmd <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;flux&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>opts <span style="color:#f92672">=</span> settings<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;flux&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> opts<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;enabled&#34;</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> str(local(<span style="color:#e6db74">&#34;command -v &#34;</span> <span style="color:#f92672">+</span> flux_cmd <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; || true&#34;</span>, quiet <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>)) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span>:
</span></span><span style="display:flex;"><span>        fail(<span style="color:#e6db74">&#34;Required command &#39;&#34;</span> <span style="color:#f92672">+</span> flux_cmd <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;&#39; not found in PATH&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> opts<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;bootstrap&#34;</span>):
</span></span><span style="display:flex;"><span>        local(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> bootstrap github --owner </span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> --repository </span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> --path </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> (flux_cmd, opts<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;owner&#39;</span>), opts<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;repository&#39;</span>), opts<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;path&#39;</span>)))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        local(flux_cmd <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; install&#34;</span>)
</span></span></code></pre></div><p>Super easy. This feels familiar, doesn&rsquo;t it? It&rsquo;s just like when you first began using something like Ansible to code down
some deployment or translate some weird script into a higher-order definition or a DSL.</p>
<p>Let&rsquo;s go one step further and try to make this nicer to read by using functions.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">bootstrap_or_install_flux</span>():
</span></span><span style="display:flex;"><span>    opts <span style="color:#f92672">=</span> settings<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;flux&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> opts<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;enabled&#34;</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> str(local(<span style="color:#e6db74">&#34;command -v &#34;</span> <span style="color:#f92672">+</span> flux_cmd <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; || true&#34;</span>, quiet <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>)) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span>:
</span></span><span style="display:flex;"><span>        fail(<span style="color:#e6db74">&#34;Required command &#39;&#34;</span> <span style="color:#f92672">+</span> flux_cmd <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;&#39; not found in PATH&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># flux bootstrap github --owner=${FLUX_OWNER} --repository=${FLUX_REPOSITORY} --path ${FLUX_PATH}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> opts<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;bootstrap&#34;</span>):
</span></span><span style="display:flex;"><span>        local(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> bootstrap github --owner </span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> --repository </span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> --path </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> (flux_cmd, opts<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;owner&#39;</span>), opts<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;repository&#39;</span>), opts<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;path&#39;</span>)))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        local(flux_cmd <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; install&#34;</span>)
</span></span></code></pre></div><p>How does our complete Tiltfile now look like, you might wonder. Let&rsquo;s take a look:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># -*- mode: Python -*-</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl_cmd <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;kubectl&#34;</span>
</span></span><span style="display:flex;"><span>flux_cmd <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;flux&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># verify kubectl command exists</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> str(local(<span style="color:#e6db74">&#34;command -v &#34;</span> <span style="color:#f92672">+</span> kubectl_cmd <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; || true&#34;</span>, quiet <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>)) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span>:
</span></span><span style="display:flex;"><span>    fail(<span style="color:#e6db74">&#34;Required command &#39;&#34;</span> <span style="color:#f92672">+</span> kubectl_cmd <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;&#39; not found in PATH&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># set defaults</span>
</span></span><span style="display:flex;"><span>settings <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;flux&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;enabled&#34;</span>: <span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;bootstrap&#34;</span>: <span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;repository&#34;</span>: os<span style="color:#f92672">.</span>getenv(<span style="color:#e6db74">&#34;FLUX_REPOSITORY&#34;</span>, <span style="color:#e6db74">&#34;podinfo-flux-example&#34;</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;owner&#34;</span>: os<span style="color:#f92672">.</span>getenv(<span style="color:#e6db74">&#34;FLUX_OWNER&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;path&#34;</span>: os<span style="color:#f92672">.</span>getenv(<span style="color:#e6db74">&#34;FLUX_PATH&#34;</span>, <span style="color:#e6db74">&#34;.&#34;</span>),
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;forward_registry&#34;</span>: <span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;verification_keys&#34;</span>: {},
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># global settings</span>
</span></span><span style="display:flex;"><span>tilt_file <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;./tilt-settings.yaml&#34;</span> <span style="color:#66d9ef">if</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>exists(<span style="color:#e6db74">&#34;./tilt-settings.yaml&#34;</span>) <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&#34;./tilt-settings.json&#34;</span>
</span></span><span style="display:flex;"><span>settings<span style="color:#f92672">.</span>update(read_yaml(
</span></span><span style="display:flex;"><span>    tilt_file,
</span></span><span style="display:flex;"><span>    default <span style="color:#f92672">=</span> {},
</span></span><span style="display:flex;"><span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">bootstrap_or_install_flux</span>():
</span></span><span style="display:flex;"><span>    opts <span style="color:#f92672">=</span> settings<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;flux&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> opts<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;enabled&#34;</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> str(local(<span style="color:#e6db74">&#34;command -v &#34;</span> <span style="color:#f92672">+</span> flux_cmd <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; || true&#34;</span>, quiet <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>)) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span>:
</span></span><span style="display:flex;"><span>        fail(<span style="color:#e6db74">&#34;Required command &#39;&#34;</span> <span style="color:#f92672">+</span> flux_cmd <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;&#39; not found in PATH&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># flux bootstrap github --owner=${FLUX_OWNER} --repository=${FLUX_REPOSITORY} --path ${FLUX_PATH}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> opts<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;bootstrap&#34;</span>):
</span></span><span style="display:flex;"><span>        local(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> bootstrap github --owner </span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> --repository </span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> --path </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> (flux_cmd, opts<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;owner&#39;</span>), opts<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;repository&#39;</span>), opts<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;path&#39;</span>)))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        local(flux_cmd <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; install&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># set up the development environment</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># check if flux is needed</span>
</span></span><span style="display:flex;"><span>bootstrap_or_install_flux()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Use kustomize to build the install yaml files</span>
</span></span><span style="display:flex;"><span>k8s_yaml(kustomize(<span style="color:#e6db74">&#39;config/default&#39;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>docker_build(<span style="color:#e6db74">&#39;ghcr.io/open-component-model/ocm-controller&#39;</span>, <span style="color:#e6db74">&#39;.&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># This is new thing we added here to port-forward more on this a bit later.</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> settings<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;forward_registry&#39;</span>):
</span></span><span style="display:flex;"><span>    k8s_resource(<span style="color:#e6db74">&#39;ocm-controller&#39;</span>, extra_pod_selectors <span style="color:#f92672">=</span> [{<span style="color:#e6db74">&#39;app&#39;</span>: <span style="color:#e6db74">&#39;registry&#39;</span>}], port_forwards<span style="color:#f92672">=</span><span style="color:#ae81ff">5000</span>)
</span></span></code></pre></div><p>This looks pretty nice already. But there is a lot more that we can do.</p>
<h4 id="adding-secrets">Adding secrets<a hidden class="anchor" aria-hidden="true" href="#adding-secrets">#</a></h4>
<p><img alt="secrets" loading="lazy" src="/img/2023/02/25/secrets.jpg"></p>
<p>Another thing that OCM needs ( or any other deployment really ) is creating secrets for various things and deployments.
OCM needs some docker registry credentials and some other credentials to pull things from outside repositories.</p>
<p>Creating secrets can be done by using an extension. The particular extension we are looking for is <a href="https://github.com/tilt-dev/tilt-extensions/tree/master/secret">secrets</a>.</p>
<p>We will use three types. A <code>from-file</code> for creating a secret that contains an SSH key. A plain key/value secret for
repository access. And a docker-registry type secret.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># set defaults</span>
</span></span><span style="display:flex;"><span>settings <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;flux&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;enabled&#34;</span>: <span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;bootstrap&#34;</span>: <span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;repository&#34;</span>: os<span style="color:#f92672">.</span>getenv(<span style="color:#e6db74">&#34;FLUX_REPOSITORY&#34;</span>, <span style="color:#e6db74">&#34;podinfo-flux-example&#34;</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;owner&#34;</span>: os<span style="color:#f92672">.</span>getenv(<span style="color:#e6db74">&#34;FLUX_OWNER&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;path&#34;</span>: os<span style="color:#f92672">.</span>getenv(<span style="color:#e6db74">&#34;FLUX_PATH&#34;</span>, <span style="color:#e6db74">&#34;.&#34;</span>),
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;install_unpacker&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;enabled&#34;</span>: <span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;path&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Added this one</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># +++++++++++++++</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;create_secrets&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;enable&#34;</span>: <span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;token&#34;</span>: os<span style="color:#f92672">.</span>getenv(<span style="color:#e6db74">&#34;GITHUB_TOKEN&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;email&#34;</span>: os<span style="color:#f92672">.</span>getenv(<span style="color:#e6db74">&#34;GITHUB_EMAIL&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;user&#34;</span>: os<span style="color:#f92672">.</span>getenv(<span style="color:#e6db74">&#34;GITHUB_USER&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>),
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># +++++++++++++++</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;forward_registry&#34;</span>: <span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;verification_keys&#34;</span>: {},
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ... other stuff ...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_secrets</span>():
</span></span><span style="display:flex;"><span>    opts <span style="color:#f92672">=</span> settings<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;create_secrets&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> opts<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;enable&#34;</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    k8s_yaml(secret_yaml_registry(<span style="color:#e6db74">&#34;regcred&#34;</span>, <span style="color:#e6db74">&#34;ocm-system&#34;</span>, flags_dict <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;docker-server&#39;</span>: <span style="color:#e6db74">&#39;ghcr.io&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;docker-username&#39;</span>: opts<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;user&#39;</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;docker-email&#39;</span>: opts<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;email&#39;</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;docker-password&#39;</span>: opts<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;token&#39;</span>),
</span></span><span style="display:flex;"><span>    }))
</span></span><span style="display:flex;"><span>    k8s_yaml(secret_from_dict(<span style="color:#e6db74">&#34;creds&#34;</span>, <span style="color:#e6db74">&#34;ocm-system&#34;</span>, inputs <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;username&#39;</span> : opts<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;user&#39;</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;password&#39;</span> : opts<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;token&#39;</span>),
</span></span><span style="display:flex;"><span>    }))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_verification_keys</span>():
</span></span><span style="display:flex;"><span>    keys <span style="color:#f92672">=</span> settings<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;verification_keys&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> keys:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> key, value <span style="color:#f92672">in</span> keys<span style="color:#f92672">.</span>items():
</span></span><span style="display:flex;"><span>        secret_create_generic(key, <span style="color:#e6db74">&#39;ocm-system&#39;</span>, from_file<span style="color:#f92672">=</span>value)
</span></span></code></pre></div><p>We added two new functions and an extension to the settings. Let&rsquo;s break this down.</p>
<p><code>k8s_yaml(secret_yaml_registry</code> -&gt; this directive creates a yaml output which we apply to the cluster. Its kubectl
equivalent would be</p>
<pre tabindex="0"><code>kubectl create secret docker-registry -n ocm-system regcred \
    --docker-server=ghcr.io \
    --docker-username=$GITHUB_USER \
    --docker-password=$GITHUB_TOKEN \
    --docker-email=$GITHUB_EMAIL
</code></pre><p><code>k8s_yaml(secret_from_dict</code> -&gt; same here. Equivalent kubectl command: <code>kubectl create secret generic creds --from-literal=username=$GITHUB_USER --from-literal=password=$GITHUB_TOKEN -n ocm-system</code></p>
<p>Next, we have <code>create_verification_keys</code>. This is a bit trickier, but nothing too fancy. Verification keys are SSH keys
that can be used to verify components. We can have multiple keys. Therefore, the setting is a dict. We loop through the
dict and create a secret from each of those. This is what that setting could look like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">verification_keys</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">alice</span>: <span style="color:#ae81ff">alice=./rsa.pub</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">bob</span>: <span style="color:#ae81ff">bob=/Users/user/home/.ssh/bob.pub</span>
</span></span></code></pre></div><p>All valid values. If a key is missing or the path is wrong, tilt does a dry-run first, so before applying to the cluster
there would be an error that the key cannot be found.</p>
<p>Phew, this was quite a lot. But now, we have secrets. Next, is the most important topic of them all&hellip;</p>
<h4 id="hot-swapping">Hot-Swapping<a hidden class="anchor" aria-hidden="true" href="#hot-swapping">#</a></h4>
<p>Hot-swapping is the most important ability of tilt of all of them. Instead of rebuilding the whole container it can
just rebuild the binary and switch out the running process. This is nothing new but combined with Kubernetes and
the controller development cycle will provide us with valuable time saved.</p>
<p>To do that though, we first, need to give Tilt some new abilities.</p>
<h5 id="letting-tilt-build-the-controller">Letting Tilt build the controller<a hidden class="anchor" aria-hidden="true" href="#letting-tilt-build-the-controller">#</a></h5>
<p>Tilt needs to manage the building of the binary for our project. Lucky for me, ocm is pretty basic in its design.
Doesn&rsquo;t require anything too weird. Not that tilt doesn&rsquo;t support <em>weird</em>, it does, with custom builds, but for me, this wasn&rsquo;t needed.</p>
<p>And I suspect for most controllers that is the case. Let&rsquo;s add something called a <code>local_resource</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>local_resource(
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;manager&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o bin/manager ./&#39;</span>,
</span></span><span style="display:flex;"><span>    deps <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;main.go&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;go.mod&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;go.sum&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;api&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;controllers&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;pkg&#34;</span>,
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p>A <code>local_resource</code> is similar to <code>local</code>. It executes a command on the host computer. However, it also creates a resource.
Remember, that a resource is any unit of work that Tilt manages. To learn more read up <a href="https://docs.tilt.dev/local_resource.html">here</a>. The extra here is that whenever something changes in <code>deps</code> it will re-run the command and rebuild the resource.</p>
<p>Here is the API definition of <a href="https://docs.tilt.dev/api.html#api.local_resource">local_resource</a>.</p>
<p>This means that whenever something changes in <code>deps</code>, like files in API or controllers or pkg, etc, tilt rebuilds our
binary. It already monitors the component YAML files, now we also monitor the go files.</p>
<p>We can add any script here or anything that produces our binary.</p>
<p>Now, we&rsquo;ll modify our docker build. There are some gotcha&rsquo;s there.</p>
<h5 id="root-access">Root access<a hidden class="anchor" aria-hidden="true" href="#root-access">#</a></h5>
<p>The first gotcha is that Tilt requires root access to hot-swap processes. If you are doing it right, you are using a
scratch container and something like this in your deployment:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>  <span style="color:#f92672">securityContext</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">runAsNonRoot</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">seccompProfile</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">type</span>: <span style="color:#ae81ff">RuntimeDefault</span>
</span></span></code></pre></div><p>If you aren&rsquo;t you really should be! First, problem is that scratch containers aren&rsquo;t supported by Tilt because it expects
certain commands to be in the container, like <code>touch</code>. So we add a very simple Dockerfile that only tilt will use.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Dockerfile" data-lang="Dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> alpine</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> ./bin/manager /manager<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENTRYPOINT</span> [<span style="color:#e6db74">&#34;/manager&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>And, we have to get rid of the <code>runAsNonRoot: true</code>. Or rather, set it to false. Remember we are writing code here.
So we just take the yaml, change that field, and apply it after we are finished updating the object. There is a little
doc about that that you can read: <a href="https://docs.tilt.dev/templating.html">Modifying YAML for Dev</a>.</p>
<p>Let&rsquo;s take a look. The basic flow is:</p>
<ul>
<li>read in our kustomize files</li>
<li>convert it to objects</li>
<li>look for our deployment and change this setting</li>
<li>compile it back to yaml</li>
<li>apply</li>
</ul>
<p>We could also apply the objects separately but it&rsquo;s nice to do it with the install yaml because it contains the CRDs and
Kubernetes applies those first. It&rsquo;s a server-side apply.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Use kustomize to build the install yaml files</span>
</span></span><span style="display:flex;"><span>install <span style="color:#f92672">=</span> kustomize(<span style="color:#e6db74">&#39;config/default&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Update the root security group. Tilt requires root access to update the</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># running process.</span>
</span></span><span style="display:flex;"><span>objects <span style="color:#f92672">=</span> decode_yaml_stream(install)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> o <span style="color:#f92672">in</span> objects:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> o<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;kind&#39;</span>) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;Deployment&#39;</span> <span style="color:#f92672">and</span> o<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;metadata&#39;</span>)<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;name&#39;</span>) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;ocm-controller&#39;</span>:
</span></span><span style="display:flex;"><span>        o[<span style="color:#e6db74">&#39;spec&#39;</span>][<span style="color:#e6db74">&#39;template&#39;</span>][<span style="color:#e6db74">&#39;spec&#39;</span>][<span style="color:#e6db74">&#39;securityContext&#39;</span>][<span style="color:#e6db74">&#39;runAsNonRoot&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>updated_install <span style="color:#f92672">=</span> encode_yaml_stream(objects)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Apply the updated yaml to the cluster.</span>
</span></span><span style="display:flex;"><span>k8s_yaml(updated_install)
</span></span></code></pre></div><p>And thus, if our kind is <code>Deployment</code> and the name is the one we are looking for <code>ocm-controller</code> we change that value
under <code>spec: template: spec: securityContext:</code>. DONE. Next!</p>
<h5 id="with-restart">With restart<a hidden class="anchor" aria-hidden="true" href="#with-restart">#</a></h5>
<p>Now that we have the right Dockerfile and the right deployment, let&rsquo;s use another extension called <code>restart_process</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>load(<span style="color:#e6db74">&#39;ext://restart_process&#39;</span>, <span style="color:#e6db74">&#39;docker_build_with_restart&#39;</span>)
</span></span></code></pre></div><p>Load the extension and then change the <code>docker_build</code> to <code>docker_build_with_restart</code> like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>docker_build_with_restart(
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;ghcr.io/open-component-model/ocm-controller&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;.&#39;</span>,
</span></span><span style="display:flex;"><span>    dockerfile <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;tilt.dockerfile&#39;</span>,
</span></span><span style="display:flex;"><span>    entrypoint <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;/manager&#39;</span>],
</span></span><span style="display:flex;"><span>    only<span style="color:#f92672">=</span>[
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#39;./bin&#39;</span>,
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>    live_update <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>        sync(<span style="color:#e6db74">&#39;./bin/manager&#39;</span>, <span style="color:#e6db74">&#39;/manager&#39;</span>),
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p>Let&rsquo;s break this down. We have two pretty straightforward things. The first is the name of the container.
The second is the context. The third is <code>dockerfile</code> our custom <code>alpine</code> container.</p>
<p>Fourth is <code>entrypoint</code>. Now comes the <code>only</code> part and the <code>live_update</code>. The <code>only</code> part here is <strong>important</strong>. This
tells Tilt to only watch that folder for changes. Since the <code>local_resource</code> is already watching for changes to the
binary the deployment only needs to care about that!</p>
<p><code>live_update</code> tells Tilt what to change in the container. We copy from the local <code>bin/</code>manager<code>to the container</code>/manager<code>. It can also execute a script in the container, but we don't need that here. For example, a </code>restart.sh<code>. Or, in the case of python a </code>pip install -r requirements.txt` or something like that.</p>
<p>The rest is taken care of by a Tilt wrapper; a bash script that can swap out processes. That&rsquo;s what
<code>docker_build_with_restart</code> does. It wraps our container and Dockerfile into its container and runs our <code>entrypoint</code>.</p>
<h4 id="attaching-a-debugger">Attaching a debugger<a hidden class="anchor" aria-hidden="true" href="#attaching-a-debugger">#</a></h4>
<p><img alt="debugger" loading="lazy" src="/img/2023/02/25/tilt-debug.png"></p>
<blockquote>
<p>But I&rsquo;m running the manager locally because I use a debugger.</p>
</blockquote>
<p>I hear you! And it&rsquo;s possible with Tilt as well! We need to do a couple of things to achieve running delve correctly.
Luckily, once set up, it should work for the foreseeable future.</p>
<p>First, let&rsquo;s alter our settings and include a debug value:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># set defaults</span>
</span></span><span style="display:flex;"><span>settings <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;flux&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;enabled&#34;</span>: <span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;bootstrap&#34;</span>: <span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;repository&#34;</span>: os<span style="color:#f92672">.</span>getenv(<span style="color:#e6db74">&#34;FLUX_REPOSITORY&#34;</span>, <span style="color:#e6db74">&#34;podinfo-flux-example&#34;</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;owner&#34;</span>: os<span style="color:#f92672">.</span>getenv(<span style="color:#e6db74">&#34;FLUX_OWNER&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;path&#34;</span>: os<span style="color:#f92672">.</span>getenv(<span style="color:#e6db74">&#34;FLUX_PATH&#34;</span>, <span style="color:#e6db74">&#34;.&#34;</span>),
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;install_unpacker&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;enabled&#34;</span>: <span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;path&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;debug&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;enabled&#34;</span>: <span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;create_secrets&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;enable&#34;</span>: <span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;token&#34;</span>: os<span style="color:#f92672">.</span>getenv(<span style="color:#e6db74">&#34;GITHUB_TOKEN&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;email&#34;</span>: os<span style="color:#f92672">.</span>getenv(<span style="color:#e6db74">&#34;GITHUB_EMAIL&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;user&#34;</span>: os<span style="color:#f92672">.</span>getenv(<span style="color:#e6db74">&#34;GITHUB_USER&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>),
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;forward_registry&#34;</span>: <span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;verification_keys&#34;</span>: {},
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Once enabled, for simplicity, we will forward delve on port <code>30000</code>.</p>
<p>Next, we need a dedicated Dockerfile that installs and runs <code>delve</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Dockerfile" data-lang="Dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> golang:1.20.1</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> ./bin/manager /manager<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> go install github.com/go-delve/delve/cmd/dlv@latest<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> chmod +x /go/bin/dlv<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> mv /go/bin/dlv /<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">EXPOSE</span><span style="color:#e6db74"> 30000</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENTRYPOINT</span> [<span style="color:#e6db74">&#34;/dlv&#34;</span>, <span style="color:#e6db74">&#34;--listen=:30000&#34;</span>, <span style="color:#e6db74">&#34;--api-version=2&#34;</span>, <span style="color:#e6db74">&#34;--headless=true&#34;</span>, <span style="color:#e6db74">&#34;--continue=true&#34;</span>, <span style="color:#e6db74">&#34;--accept-multiclient=true&#34;</span>, <span style="color:#e6db74">&#34;exec&#34;</span>, <span style="color:#e6db74">&#34;/manager&#34;</span>, <span style="color:#e6db74">&#34;--&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>The two important settings here are <code>--continue</code> and <code>--accept-multiclient</code>. Without it, delve will stop the process and
our readiness and liveliness probes will fail. Another <strong>super</strong> important part is <code>--</code> at the end. Without it, our
<code>manager</code> will not get the arguments passed in by the deployment. Or rather, it will try to pass them to <code>delve</code>.</p>
<p>With delve in place, now we get to the funky part. We need to tell Tilt to use our debug Dockerfile and change the
<code>entrypoint</code> if debugging is enabled. Also, let&rsquo;s not forget that the deployment needs to port-forward <code>30000</code> otherwise
we can&rsquo;t access it with our debugger. Another thing we SHOULD do is, alter the Go build process and add some flags.
Usually, when debugging Go code you want the flags <code>-N -l</code>. We add that with a variable called <code>gcflags</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># ... other things ...</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Update the root security group. Tilt requires root access to update the</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># running process.</span>
</span></span><span style="display:flex;"><span>objects <span style="color:#f92672">=</span> decode_yaml_stream(install)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> o <span style="color:#f92672">in</span> objects:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> o<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;kind&#39;</span>) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;Deployment&#39;</span> <span style="color:#f92672">and</span> o<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;metadata&#39;</span>)<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;name&#39;</span>) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;ocm-controller&#39;</span>:
</span></span><span style="display:flex;"><span>        o[<span style="color:#e6db74">&#39;spec&#39;</span>][<span style="color:#e6db74">&#39;template&#39;</span>][<span style="color:#e6db74">&#39;spec&#39;</span>][<span style="color:#e6db74">&#39;securityContext&#39;</span>][<span style="color:#e6db74">&#39;runAsNonRoot&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># This is what we added. OCM has a single container so we don&#39;t need to look for a specific one.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> settings<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;debug&#39;</span>)<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;enabled&#39;</span>):
</span></span><span style="display:flex;"><span>            o[<span style="color:#e6db74">&#39;spec&#39;</span>][<span style="color:#e6db74">&#39;template&#39;</span>][<span style="color:#e6db74">&#39;spec&#39;</span>][<span style="color:#e6db74">&#39;containers&#39;</span>][<span style="color:#ae81ff">0</span>][<span style="color:#e6db74">&#39;ports&#39;</span>] <span style="color:#f92672">=</span> [{<span style="color:#e6db74">&#39;containerPort&#39;</span>: <span style="color:#ae81ff">30000</span>}]
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ... other things ....</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Update our Go build and add conditional gcflags.</span>
</span></span><span style="display:flex;"><span>gcflags <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> settings<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;debug&#39;</span>)<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;enabled&#39;</span>):
</span></span><span style="display:flex;"><span>    gcflags <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;-N -l&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>local_resource(
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;manager&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -gcflags &#39;</span><span style="color:#e6db74">{gcflags}</span><span style="color:#e6db74">&#39; -o bin/manager ./&#34;</span><span style="color:#f92672">.</span>format(gcflags<span style="color:#f92672">=</span>gcflags),
</span></span><span style="display:flex;"><span>    deps <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;main.go&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;go.mod&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;go.sum&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;api&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;controllers&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;pkg&#34;</span>,
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ... other things ...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Finally, our port-forwarding and the addition of the updated entrypoint and dockerfile.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># The `[]` syntax on entrypoint is important because we want tilt to be able to append to it.</span>
</span></span><span style="display:flex;"><span>entrypoint <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;/manager&#39;</span>]
</span></span><span style="display:flex;"><span>dockerfile <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;tilt.dockerfile&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> settings<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;debug&#39;</span>)<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;enabled&#39;</span>):
</span></span><span style="display:flex;"><span>    k8s_resource(<span style="color:#e6db74">&#39;ocm-controller&#39;</span>, port_forwards<span style="color:#f92672">=</span>[
</span></span><span style="display:flex;"><span>        port_forward(<span style="color:#ae81ff">30000</span>, <span style="color:#ae81ff">30000</span>, <span style="color:#e6db74">&#39;debugger&#39;</span>),
</span></span><span style="display:flex;"><span>    ])
</span></span><span style="display:flex;"><span>    entrypoint <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;/dlv&#39;</span>, <span style="color:#e6db74">&#39;--listen=:30000&#39;</span>, <span style="color:#e6db74">&#39;--api-version=2&#39;</span>, <span style="color:#e6db74">&#39;--continue=true&#39;</span>, <span style="color:#e6db74">&#39;--accept-multiclient=true&#39;</span>, <span style="color:#e6db74">&#39;--headless=true&#39;</span>, <span style="color:#e6db74">&#39;exec&#39;</span>, <span style="color:#e6db74">&#39;/manager&#39;</span>, <span style="color:#e6db74">&#39;--&#39;</span>]
</span></span><span style="display:flex;"><span>    dockerfile <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;tilt.debug.dockerfile&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>docker_build_with_restart(
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;ghcr.io/open-component-model/ocm-controller&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;.&#39;</span>,
</span></span><span style="display:flex;"><span>    dockerfile <span style="color:#f92672">=</span> dockerfile,
</span></span><span style="display:flex;"><span>    entrypoint <span style="color:#f92672">=</span> entrypoint,
</span></span><span style="display:flex;"><span>    only<span style="color:#f92672">=</span>[
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#39;./bin&#39;</span>,
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>    live_update <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>        sync(<span style="color:#e6db74">&#39;./bin/manager&#39;</span>, <span style="color:#e6db74">&#39;/manager&#39;</span>),
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p>Now, to attach to the debugger in GoLand follow this guide: <a href="https://www.jetbrains.com/help/go/attach-to-running-go-processes-with-debugger.html#step-3-create-the-remote-run-debug-configuration-on-the-client-computer">Attach To Remote Debugger</a>.</p>
<p>The only important piece there is to clear the <strong>Shutdown remote debugger on disconnect</strong> flag.</p>
<p>In VSCode:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;Connect to Container&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;go&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;request&#34;</span>: <span style="color:#e6db74">&#34;attach&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;mode&#34;</span>: <span style="color:#e6db74">&#34;remote&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;remotePath&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;port&#34;</span>: <span style="color:#ae81ff">30000</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;host&#34;</span>: <span style="color:#e6db74">&#34;127.0.0.1&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;showLog&#34;</span>: <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;trace&#34;</span>: <span style="color:#e6db74">&#34;log&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;logOutput&#34;</span>: <span style="color:#e6db74">&#34;rpc&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>And that&rsquo;s it! We got delve working.</p>
<p>Let&rsquo;s take a look at the full Tiltfile.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># -*- mode: Python -*-</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl_cmd <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;kubectl&#34;</span>
</span></span><span style="display:flex;"><span>flux_cmd <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;flux&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># verify kubectl command exists</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> str(local(<span style="color:#e6db74">&#34;command -v &#34;</span> <span style="color:#f92672">+</span> kubectl_cmd <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; || true&#34;</span>, quiet <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>)) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span>:
</span></span><span style="display:flex;"><span>    fail(<span style="color:#e6db74">&#34;Required command &#39;&#34;</span> <span style="color:#f92672">+</span> kubectl_cmd <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;&#39; not found in PATH&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># set defaults</span>
</span></span><span style="display:flex;"><span>settings <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;flux&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;enabled&#34;</span>: <span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;bootstrap&#34;</span>: <span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;repository&#34;</span>: os<span style="color:#f92672">.</span>getenv(<span style="color:#e6db74">&#34;FLUX_REPOSITORY&#34;</span>, <span style="color:#e6db74">&#34;podinfo-flux-example&#34;</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;owner&#34;</span>: os<span style="color:#f92672">.</span>getenv(<span style="color:#e6db74">&#34;FLUX_OWNER&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;path&#34;</span>: os<span style="color:#f92672">.</span>getenv(<span style="color:#e6db74">&#34;FLUX_PATH&#34;</span>, <span style="color:#e6db74">&#34;.&#34;</span>),
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;install_unpacker&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;enabled&#34;</span>: <span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;path&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;debug&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;enabled&#34;</span>: <span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;create_secrets&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;enable&#34;</span>: <span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;token&#34;</span>: os<span style="color:#f92672">.</span>getenv(<span style="color:#e6db74">&#34;GITHUB_TOKEN&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;email&#34;</span>: os<span style="color:#f92672">.</span>getenv(<span style="color:#e6db74">&#34;GITHUB_EMAIL&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;user&#34;</span>: os<span style="color:#f92672">.</span>getenv(<span style="color:#e6db74">&#34;GITHUB_USER&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>),
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;forward_registry&#34;</span>: <span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;verification_keys&#34;</span>: {},
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># global settings</span>
</span></span><span style="display:flex;"><span>tilt_file <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;./tilt-settings.yaml&#34;</span> <span style="color:#66d9ef">if</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>exists(<span style="color:#e6db74">&#34;./tilt-settings.yaml&#34;</span>) <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&#34;./tilt-settings.json&#34;</span>
</span></span><span style="display:flex;"><span>settings<span style="color:#f92672">.</span>update(read_yaml(
</span></span><span style="display:flex;"><span>    tilt_file,
</span></span><span style="display:flex;"><span>    default <span style="color:#f92672">=</span> {},
</span></span><span style="display:flex;"><span>))
</span></span><span style="display:flex;"><span>load(<span style="color:#e6db74">&#39;ext://secret&#39;</span>, <span style="color:#e6db74">&#39;secret_yaml_registry&#39;</span>, <span style="color:#e6db74">&#39;secret_from_dict&#39;</span>, <span style="color:#e6db74">&#39;secret_create_generic&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">bootstrap_or_install_flux</span>():
</span></span><span style="display:flex;"><span>    opts <span style="color:#f92672">=</span> settings<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;flux&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> opts<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;enabled&#34;</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> str(local(<span style="color:#e6db74">&#34;command -v &#34;</span> <span style="color:#f92672">+</span> flux_cmd <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; || true&#34;</span>, quiet <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>)) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span>:
</span></span><span style="display:flex;"><span>        fail(<span style="color:#e6db74">&#34;Required command &#39;&#34;</span> <span style="color:#f92672">+</span> flux_cmd <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;&#39; not found in PATH&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># flux bootstrap github --owner=${FLUX_OWNER} --repository=${FLUX_REPOSITORY} --path ${FLUX_PATH}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> opts<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;bootstrap&#34;</span>):
</span></span><span style="display:flex;"><span>        local(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> bootstrap github --owner </span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> --repository </span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> --path </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> (flux_cmd, opts<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;owner&#39;</span>), opts<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;repository&#39;</span>), opts<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;path&#39;</span>)))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        local(flux_cmd <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; install&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">install_unpacker</span>():
</span></span><span style="display:flex;"><span>    opts <span style="color:#f92672">=</span> settings<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;install_unpacker&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> opts<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;enabled&#34;</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_secrets</span>():
</span></span><span style="display:flex;"><span>    opts <span style="color:#f92672">=</span> settings<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;create_secrets&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> opts<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;enable&#34;</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    k8s_yaml(secret_yaml_registry(<span style="color:#e6db74">&#34;regcred&#34;</span>, <span style="color:#e6db74">&#34;ocm-system&#34;</span>, flags_dict <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;docker-server&#39;</span>: <span style="color:#e6db74">&#39;ghcr.io&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;docker-username&#39;</span>: opts<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;user&#39;</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;docker-email&#39;</span>: opts<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;email&#39;</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;docker-password&#39;</span>: opts<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;token&#39;</span>),
</span></span><span style="display:flex;"><span>    }))
</span></span><span style="display:flex;"><span>    k8s_yaml(secret_from_dict(<span style="color:#e6db74">&#34;creds&#34;</span>, <span style="color:#e6db74">&#34;ocm-system&#34;</span>, inputs <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;username&#39;</span> : opts<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;user&#39;</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;password&#39;</span> : opts<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;token&#39;</span>),
</span></span><span style="display:flex;"><span>    }))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_verification_keys</span>():
</span></span><span style="display:flex;"><span>    keys <span style="color:#f92672">=</span> settings<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;verification_keys&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> keys:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> key, value <span style="color:#f92672">in</span> keys<span style="color:#f92672">.</span>items():
</span></span><span style="display:flex;"><span>        secret_create_generic(key, <span style="color:#e6db74">&#39;ocm-system&#39;</span>, from_file<span style="color:#f92672">=</span>value)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># set up the development environment</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># check if flux is needed</span>
</span></span><span style="display:flex;"><span>bootstrap_or_install_flux()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># check if installing unpacker is needed</span>
</span></span><span style="display:flex;"><span>install_unpacker()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Use kustomize to build the install yaml files</span>
</span></span><span style="display:flex;"><span>install <span style="color:#f92672">=</span> kustomize(<span style="color:#e6db74">&#39;config/default&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Update the root security group. Tilt requires root access to update the</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># running process.</span>
</span></span><span style="display:flex;"><span>objects <span style="color:#f92672">=</span> decode_yaml_stream(install)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> o <span style="color:#f92672">in</span> objects:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> o<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;kind&#39;</span>) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;Deployment&#39;</span> <span style="color:#f92672">and</span> o<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;metadata&#39;</span>)<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;name&#39;</span>) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;ocm-controller&#39;</span>:
</span></span><span style="display:flex;"><span>        o[<span style="color:#e6db74">&#39;spec&#39;</span>][<span style="color:#e6db74">&#39;template&#39;</span>][<span style="color:#e6db74">&#39;spec&#39;</span>][<span style="color:#e6db74">&#39;securityContext&#39;</span>][<span style="color:#e6db74">&#39;runAsNonRoot&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> settings<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;debug&#39;</span>)<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;enabled&#39;</span>):
</span></span><span style="display:flex;"><span>            o[<span style="color:#e6db74">&#39;spec&#39;</span>][<span style="color:#e6db74">&#39;template&#39;</span>][<span style="color:#e6db74">&#39;spec&#39;</span>][<span style="color:#e6db74">&#39;containers&#39;</span>][<span style="color:#ae81ff">0</span>][<span style="color:#e6db74">&#39;ports&#39;</span>] <span style="color:#f92672">=</span> [{<span style="color:#e6db74">&#39;containerPort&#39;</span>: <span style="color:#ae81ff">30000</span>}]
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>updated_install <span style="color:#f92672">=</span> encode_yaml_stream(objects)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Apply the updated yaml to the cluster.</span>
</span></span><span style="display:flex;"><span>k8s_yaml(updated_install)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create Secrets</span>
</span></span><span style="display:flex;"><span>create_secrets()
</span></span><span style="display:flex;"><span>create_verification_keys()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>load(<span style="color:#e6db74">&#39;ext://restart_process&#39;</span>, <span style="color:#e6db74">&#39;docker_build_with_restart&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># enable hot reloading by doing the following:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - locally build the whole project</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - create a docker imagine using tilt&#39;s hot-swap wrapper</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - push that container to the local tilt registry</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Once done, rebuilding now should be a lot faster since only the relevant</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># binary is rebuilt and the hot swat wrapper takes care of the rest.</span>
</span></span><span style="display:flex;"><span>gcflags <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> settings<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;debug&#39;</span>)<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;enabled&#39;</span>):
</span></span><span style="display:flex;"><span>    gcflags <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;-N -l&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>local_resource(
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;manager&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -gcflags &#39;</span><span style="color:#e6db74">{gcflags}</span><span style="color:#e6db74">&#39; -o bin/manager ./&#34;</span><span style="color:#f92672">.</span>format(gcflags<span style="color:#f92672">=</span>gcflags),
</span></span><span style="display:flex;"><span>    deps <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;main.go&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;go.mod&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;go.sum&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;api&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;controllers&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;pkg&#34;</span>,
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Build the docker image for our controller. We use a specific Dockerfile</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># since tilt can&#39;t run on a scratch container.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># `only` here is important, otherwise, the container will get updated</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># on _any_ file change. We only want to monitor the binary.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># If debugging is enabled, we switch to a different docker file using</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># the delve port.</span>
</span></span><span style="display:flex;"><span>entrypoint <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;/manager&#39;</span>]
</span></span><span style="display:flex;"><span>dockerfile <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;tilt.dockerfile&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> settings<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;debug&#39;</span>)<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;enabled&#39;</span>):
</span></span><span style="display:flex;"><span>    k8s_resource(<span style="color:#e6db74">&#39;ocm-controller&#39;</span>, port_forwards<span style="color:#f92672">=</span>[
</span></span><span style="display:flex;"><span>        port_forward(<span style="color:#ae81ff">30000</span>, <span style="color:#ae81ff">30000</span>, <span style="color:#e6db74">&#39;debugger&#39;</span>),
</span></span><span style="display:flex;"><span>    ])
</span></span><span style="display:flex;"><span>    entrypoint <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;/dlv&#39;</span>, <span style="color:#e6db74">&#39;--listen=:30000&#39;</span>, <span style="color:#e6db74">&#39;--api-version=2&#39;</span>, <span style="color:#e6db74">&#39;--continue=true&#39;</span>, <span style="color:#e6db74">&#39;--accept-multiclient=true&#39;</span>, <span style="color:#e6db74">&#39;--headless=true&#39;</span>, <span style="color:#e6db74">&#39;exec&#39;</span>, <span style="color:#e6db74">&#39;/manager&#39;</span>, <span style="color:#e6db74">&#39;--&#39;</span>]
</span></span><span style="display:flex;"><span>    dockerfile <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;tilt.debug.dockerfile&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>docker_build_with_restart(
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;ghcr.io/open-component-model/ocm-controller&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;.&#39;</span>,
</span></span><span style="display:flex;"><span>    dockerfile <span style="color:#f92672">=</span> dockerfile,
</span></span><span style="display:flex;"><span>    entrypoint <span style="color:#f92672">=</span> entrypoint,
</span></span><span style="display:flex;"><span>    only<span style="color:#f92672">=</span>[
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#39;./bin&#39;</span>,
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>    live_update <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>        sync(<span style="color:#e6db74">&#39;./bin/manager&#39;</span>, <span style="color:#e6db74">&#39;/manager&#39;</span>),
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> settings<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;forward_registry&#39;</span>):
</span></span><span style="display:flex;"><span>    k8s_resource(<span style="color:#e6db74">&#39;ocm-controller&#39;</span>, extra_pod_selectors <span style="color:#f92672">=</span> [{<span style="color:#e6db74">&#39;app&#39;</span>: <span style="color:#e6db74">&#39;registry&#39;</span>}], port_forwards<span style="color:#f92672">=</span><span style="color:#ae81ff">5000</span>)
</span></span></code></pre></div><p>That last line extracts a resource that Tilt doesn&rsquo;t control. But we can say that it&rsquo;s the resource <code>ocm-controller</code> by
defining a label selector.</p>
<h3 id="numbers">Numbers<a hidden class="anchor" aria-hidden="true" href="#numbers">#</a></h3>
<p>So what did we improve after ALL of this hassle? Well, let&rsquo;s see. Before, we needed around 2 minutes to build and deploy
then test something. With Tilt, now it&rsquo;s 10-15 SECONDS tops! That is a huge improvement in the feedback loop.</p>
<h3 id="when-it-gets-annoying">When it gets annoying<a hidden class="anchor" aria-hidden="true" href="#when-it-gets-annoying">#</a></h3>
<p>Any drawbacks? Well, if you are using GoLand or save changes frequently, it will rebuild. On. Each. Save. That can be
pretty annoying. Luckily, Tilt got you covered. If you would like to pause for a second to do some rapid-fire changes,
disable the <code>local_resource</code> ( whatever you named it, for me it&rsquo;s <code>manager</code> ) that is the Go Build. If you do that, no
changes will be reconciled, which means, the container will not be hot-swapped either.</p>
<p>Looks like this:</p>
<p><img alt="tilt-disabled" loading="lazy" src="/img/2023/02/25/tilt-disabled.png"></p>
<p>Once re-enabled, you can continue your development cycle.</p>
<h2 id="conclusion">Conclusion<a hidden class="anchor" aria-hidden="true" href="#conclusion">#</a></h2>
<p>Tilt is not easy to set up at times. Especially when you have to fiddle with a lot of access and custom-built stuff.
The syntax and view of a complex Tiltfile can be rather intimidating. Some structure adds easier ways of reading, but
sadly, this is seldom the case.</p>
<p>However, it can be helped. A nice Tiltfile with rightly named functions and a good structure can help a lot in readability.
Also, comments. And I can&rsquo;t stress this enough. Add comments! They help a lot for a new person reading the file and
understanding what is being altered why and where.</p>
<p>The Tiltfile as it looks like at the writing of this post can be found <a href="https://github.com/open-component-model/ocm-controller/blob/95b0d839d86f643f0f10304da97bcd042e8c0dfc/Tiltfile">here</a>.</p>
<p>I hope this helped, and good luck!</p>
<p>As always,</p>
<p>Thank you for reading,
Gergely.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="https://skarlso.github.io/2023/03/12/painless-controller-testing-with-e2e-framework-tilt/">
    <span class="title">« Prev</span>
    <br>
    <span>Painless controller testing with e2e-framework and tilt</span>
  </a>
  <a class="next" href="https://skarlso.github.io/2023/01/04/forming-the-habit-of-journaling/">
    <span class="title">Next »</span>
    <br>
    <span>Forming the habit of analog journaling - Why the digital format did not work for me</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="https://skarlso.github.io/">Ramblings of a cloud engineer</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
