<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Painless controller testing with e2e-framework and tilt | Ramblings of a cloud engineer</title>
<meta name="keywords" content="">
<meta name="description" content="Welcome dear reader.
When last we met, we talked a lot about setting up Tilt
for rapid controller development.
Now, let&rsquo;s see how powerful Tilt can be once we bring it together with Kubernetes&rsquo; e2e-framework.
Controller E2E Framework
I&rsquo;d like to present my controller-e2e-framework which brings Tilt and e2e-framework together to easily write and run
tests for controllers that work together.
This framework can be used to integration test or e2e test controllers that work together. They set up some kind of
ref connection between certain objects and perform some operation on said object.">
<meta name="author" content="hannibal">
<link rel="canonical" href="https://skarlso.github.io/2023/03/12/painless-controller-testing-with-e2e-framework-tilt/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css" integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://skarlso.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://skarlso.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://skarlso.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://skarlso.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://skarlso.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://skarlso.github.io/2023/03/12/painless-controller-testing-with-e2e-framework-tilt/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Painless controller testing with e2e-framework and tilt">
<meta property="og:description" content="Welcome dear reader.
When last we met, we talked a lot about setting up Tilt
for rapid controller development.
Now, let&rsquo;s see how powerful Tilt can be once we bring it together with Kubernetes&rsquo; e2e-framework.
Controller E2E Framework
I&rsquo;d like to present my controller-e2e-framework which brings Tilt and e2e-framework together to easily write and run
tests for controllers that work together.
This framework can be used to integration test or e2e test controllers that work together. They set up some kind of
ref connection between certain objects and perform some operation on said object.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://skarlso.github.io/2023/03/12/painless-controller-testing-with-e2e-framework-tilt/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2023-03-12T01:01:00+01:00">
<meta property="article:modified_time" content="2023-03-12T01:01:00+01:00">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Painless controller testing with e2e-framework and tilt">
<meta name="twitter:description" content="Welcome dear reader.
When last we met, we talked a lot about setting up Tilt
for rapid controller development.
Now, let&rsquo;s see how powerful Tilt can be once we bring it together with Kubernetes&rsquo; e2e-framework.
Controller E2E Framework
I&rsquo;d like to present my controller-e2e-framework which brings Tilt and e2e-framework together to easily write and run
tests for controllers that work together.
This framework can be used to integration test or e2e test controllers that work together. They set up some kind of
ref connection between certain objects and perform some operation on said object.">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://skarlso.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Painless controller testing with e2e-framework and tilt",
      "item": "https://skarlso.github.io/2023/03/12/painless-controller-testing-with-e2e-framework-tilt/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Painless controller testing with e2e-framework and tilt",
  "name": "Painless controller testing with e2e-framework and tilt",
  "description": "Welcome dear reader.\nWhen last we met, we talked a lot about setting up Tilt for rapid controller development.\nNow, let\u0026rsquo;s see how powerful Tilt can be once we bring it together with Kubernetes\u0026rsquo; e2e-framework.\nController E2E Framework I\u0026rsquo;d like to present my controller-e2e-framework which brings Tilt and e2e-framework together to easily write and run tests for controllers that work together.\nThis framework can be used to integration test or e2e test controllers that work together. They set up some kind of ref connection between certain objects and perform some operation on said object.\n",
  "keywords": [
    
  ],
  "articleBody": "Welcome dear reader.\nWhen last we met, we talked a lot about setting up Tilt for rapid controller development.\nNow, let’s see how powerful Tilt can be once we bring it together with Kubernetes’ e2e-framework.\nController E2E Framework I’d like to present my controller-e2e-framework which brings Tilt and e2e-framework together to easily write and run tests for controllers that work together.\nThis framework can be used to integration test or e2e test controllers that work together. They set up some kind of ref connection between certain objects and perform some operation on said object.\nThe result should contain the operation of both (or many) controllers.\nThe linked organization contains three main repositories. Let’s walk through them.\nTest 1 Controller Test 1 controller is a simple controller that accepts a basic object like this:\napiVersion: delivery.controller-e2e-framework/v1alpha1 kind: Controller metadata: name: controller-sample spec: ref: kind: Responder apiVersion: delivery.controller-e2e-framework/v1alpha1 name: test-responder The ref is the interface between test-2-controller and test-1-controller. Its simple operation involves fetching this reference, whatever the kind is, adding a label to it, and patching that object back to Kubernetes.\nThe label that it adds is controller-e2e-framework.controlled = true.\nThis repository contains another main ingredient. A simple Tilt file that does the following. It builds the project and sets up all necessary yaml objects like the CRD definition, RBAC, any patches that might exist and the deployment.\nThis is important to note for various reasons. First, if we would build a testing image instead of using Tilt, we would flood the package manager with a bunch of test imagines. Or, always set the latest image, in which case, we would lose the ability to debug any problems. Further, we would have to have some kind of way to download the manifest files that correspond to that version. If doing local development, that would be a hassle or we would have to have a checked-out source of the manifest files anyways.\nThus, we bring together all of this with Tilt which uses a local registry and the files from the checked-out source.\nThis simple Tiltfile looks like this:\n# -*- mode: Python -*- kubectl_cmd = \"kubectl\" # verify kubectl command exists if str(local(\"command -v \" + kubectl_cmd + \" || true\", quiet = True)) == \"\": fail(\"Required command '\" + kubectl_cmd + \"' not found in PATH\") # Use kustomize to build the install yaml files install = kustomize('config/default') # Update the root security group. Tilt requires root access to update the # running process. objects = decode_yaml_stream(install) for o in objects: if o.get('kind') == 'Deployment' and o.get('metadata').get('name') == 'test-1-controller': o['spec']['template']['spec']['securityContext']['runAsNonRoot'] = False break updated_install = encode_yaml_stream(objects) # Apply the updated yaml to the cluster. # Allow duplicates so the e2e test can include this tilt file with other tilt files # setting up the same namespace. k8s_yaml(updated_install, allow_duplicates = True) load('ext://restart_process', 'docker_build_with_restart') # enable hot reloading by doing the following: # - locally build the whole project # - create a docker imagine using tilt's hot-swap wrapper # - push that container to the local tilt registry # Once done, rebuilding now should be a lot faster since only the relevant # binary is rebuilt and the hot swat wrapper takes care of the rest. local_resource( 'test-1-controller-binary', 'CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o bin/manager ./', deps = [ \"main.go\", \"go.mod\", \"go.sum\", \"api\", \"controllers\", \"pkg\", ], ) # Build the docker image for our controller. We use a specific Dockerfile # since tilt can't run on a scratch container. # `only` here is important, otherwise, the container will get updated # on _any_ file change. We only want to monitor the binary. # If debugging is enabled, we switch to a different docker file using # the delve port. entrypoint = ['/manager'] dockerfile = 'tilt.dockerfile' docker_build_with_restart( 'ghcr.io/controller-e2e-framework/test-1-controller', '.', dockerfile = dockerfile, entrypoint = entrypoint, only=[ './bin', ], live_update = [ sync('./bin/manager', '/manager'), ], ) Basic things, plus the modification of the root securityContext so Tilt can hot-swap the binary.\nTest 2 Controller Test 2 controller looks at a responder object and once it detects the above label on the object, it will set a status flag called Acquired to true. Also, a simple operation just to demo how these two controllers work together.\nThis repository has the same Tiltfile as test-1-controller.\nE2E Framework Now comes the main menu. The heart of the thing.\nFirst, we can determine the flow. We would like to apply two files. controller-sample.yaml and responder-sample.yaml. This will kick-start the whole process of reconciliation of the responder object.\nOnce these two exists and we verified that they exist, we will wait for the label to be applied and the Acquired flag to be set to true.\nLet’s look at the architecture of this whole thing.\nWhat happens here is as follows… e2e-framework has a TestMain function defined.\nfunc TestMain(m *testing.M) { cfg, _ := envconf.NewFromFlags() testEnv = env.NewWithConfig(cfg) kindClusterName = envconf.RandomName(\"test-controller-e2e\", 32) namespace = envconf.RandomName(\"namespace\", 16) testEnv.Setup( envfuncs.CreateKindCluster(kindClusterName), envfuncs.CreateNamespace(namespace), shared.RunTiltForControllers(\"test-1-controller\", \"test-2-controller\"), ) testEnv.Finish( envfuncs.DeleteNamespace(namespace), envfuncs.DestroyKindCluster(kindClusterName), ) os.Exit(testEnv.Run(m)) } This function has a Setup and a Teardown phase. During this phase, a kind cluster is created and tilt ci is executed to bring up a cluster and run tilt. But what Tiltfile does it run? Well… it imports all the Tiltfiles of the defined controllers.\nThis part:\nshared.RunTiltForControllers(\"test-1-controller\", \"test-2-controller\"), But where are they? They have to be checked-out next to this project. Then, the framework will do a cd ..` like a thing and look for these folders until it either finds them or reaches the root.\ntilt ci is super convenient because it will run to completion or fail if it doesn’t start up for whatever reason. Thus we can be sure that we set up RBAC and controller settings correctly. Something that we can’t test through pure unit testing.\nOnce we have a cluster and tilt the test starts. Here we have steps that are either a Setup an Assess or a Teardown.\nWe can extract a bunch of steps here to make it easy to just plug together tests using common steps.\nLike, setting up a scheme, looking for objects, checking object state, applying test data, etc.\nIn this test we do something like this:\nfunc TestControllerApply(t *testing.T) { t.Log(\"running component version apply\") feature := features.New(\"Custom Controller\"). Setup(setup.AddSchemeAndNamespace(cv1.AddToScheme, namespace)). Setup(setup.AddSchemeAndNamespace(rv1.AddToScheme, namespace)). Setup(setup.ApplyTestData(v1alpha1.AddToScheme, namespace, \"*\")). Assess(\"check if controller was created\", assess.ResourceWasCreated(\"controller-sample\", namespace, \u0026cv1.Controller{})). Assess(\"check if responder was created\", assess.ResourceWasCreated(\"responder-sample\", namespace, \u0026rv1.Responder{})). Assess(\"wait for responder condition to be true\", func(ctx context.Context, t *testing.T, cfg *envconf.Config) context.Context { ... We have then waiters or waiting steps for certain conditions and once everything is tested and done, we remove all objects in a Teardown so the next test doesn’t collide with anything.\nTeardown(func(ctx context.Context, t *testing.T, cfg *envconf.Config) context.Context { t.Helper() t.Log(\"teardown\") // remove test resources before exiting r, err := resources.New(cfg.Client().RESTConfig()) if err != nil { t.Fatal(err) } if err := decoder.DecodeEachFile(ctx, os.DirFS(\"./testdata\"), \"*\", decoder.DeleteHandler(r), // try to DELETE objects after decoding decoder.MutateNamespace(namespace), // inject a namespace into decoded objects, before calling DeleteHandler ); err != nil { t.Fatal(err) } t.Log(\"teardown done\") return ctx }).Feature() This is super convenient because we tested apply, scheme, delete and finalizers, everything in one go.\nAnd the BEST part about all this is that the ONLY thing the user needs to run is just go test ./....\nYou can funk it up if you wish to only run a single suite with go test -v ./test/controller.\nCI To set all this up in a CI that runs it continuously or some kind of trigger just set it up like this:\nname: e2e on: workflow_dispatch: {} schedule: - cron: 0 0 * * 1 # every Monday at 00:00 permissions: contents: read # for actions/checkout to fetch code jobs: kind-linux: runs-on: ubuntu-latest steps: - name: Checkout this repo uses: actions/checkout@v3 with: path: e2e-framework - name: Checkout test-1-framework uses: actions/checkout@v3 with: repository: 'controller-e2e-framework/test-1-controller' path: test-1-controller - name: Checkout test-2-controller uses: actions/checkout@v3 with: repository: 'controller-e2e-framework/test-2-controller' path: test-2-controller - name: Setup Go uses: actions/setup-go@v3 with: go-version-file: '${{ github.workspace }}/e2e-framework/go.mod' - name: Restore Go cache uses: actions/cache@v3 with: path: /home/runner/work/_temp/_github_home/go/pkg/mod key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }} restore-keys: | ${{ runner.os }}-go- - name: Run tests run: cd e2e-framework \u0026\u0026 go test ./... Note that you need to have checkout access to all repositories involved.\nConclusion I find this testing amazingly simple. It lets me focus on the tests and I know that I will run the same thing in CI and my local__ environment. And I know that any modification I’ll do in code will immediately be tested without me having to either run something weird with exported environment properties such as TEST_IMAGE or a dedicated test runner with some weird parameters. CI runs the same thing I’m running on my local environment. And that’s go test ./....\nThank you for reading.\nAnd as always, have a nice day.\nGergely.\n",
  "wordCount" : "1472",
  "inLanguage": "en",
  "datePublished": "2023-03-12T01:01:00+01:00",
  "dateModified": "2023-03-12T01:01:00+01:00",
  "author":{
    "@type": "Person",
    "name": "hannibal"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://skarlso.github.io/2023/03/12/painless-controller-testing-with-e2e-framework-tilt/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Ramblings of a cloud engineer",
    "logo": {
      "@type": "ImageObject",
      "url": "https://skarlso.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://skarlso.github.io/" accesskey="h" title="Ramblings of a cloud engineer (Alt + H)">Ramblings of a cloud engineer</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://skarlso.github.io/archives" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://skarlso.github.io/search/" title="Search">
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://skarlso.github.io/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://skarlso.github.io/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://skarlso.github.io/">Home</a>&nbsp;»&nbsp;<a href="https://skarlso.github.io/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      Painless controller testing with e2e-framework and tilt
    </h1>
    <div class="post-meta"><span title='2023-03-12 01:01:00 +0100 +0100'>March 12, 2023</span>&nbsp;·&nbsp;7 min&nbsp;·&nbsp;hannibal

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#controller-e2e-framework" aria-label="Controller E2E Framework">Controller E2E Framework</a><ul>
                        
                <li>
                    <a href="#test-1-controller" aria-label="Test 1 Controller">Test 1 Controller</a></li>
                <li>
                    <a href="#test-2-controller" aria-label="Test 2 Controller">Test 2 Controller</a></li>
                <li>
                    <a href="#e2e-framework" aria-label="E2E Framework">E2E Framework</a></li>
                <li>
                    <a href="#ci" aria-label="CI">CI</a></li>
                <li>
                    <a href="#conclusion" aria-label="Conclusion">Conclusion</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>Welcome dear reader.</p>
<p>When <a href="https://skarlso.github.io/2023/02/25/rapid-controller-development-with-tilt/">last</a> we met, we talked a lot about setting up Tilt
for rapid controller development.</p>
<p>Now, let&rsquo;s see how powerful Tilt can be once we bring it together with Kubernetes&rsquo; <a href="https://github.com/kubernetes-sigs/e2e-framework">e2e-framework</a>.</p>
<h1 id="controller-e2e-framework">Controller E2E Framework<a hidden class="anchor" aria-hidden="true" href="#controller-e2e-framework">#</a></h1>
<p>I&rsquo;d like to present my <a href="https://github.com/controller-e2e-framework">controller-e2e-framework</a> which brings Tilt and e2e-framework together to easily write and run
tests for controllers that work together.</p>
<p>This framework can be used to integration test or e2e test controllers that work together. They set up some kind of
ref connection between certain objects and perform some operation on said object.</p>
<p>The result should contain the operation of both (or many) controllers.</p>
<p>The linked organization contains three main repositories. Let&rsquo;s walk through them.</p>
<h2 id="test-1-controller">Test 1 Controller<a hidden class="anchor" aria-hidden="true" href="#test-1-controller">#</a></h2>
<p>Test 1 controller is a simple controller that accepts a basic object like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">delivery.controller-e2e-framework/v1alpha1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Controller</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">controller-sample</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ref</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Responder</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">delivery.controller-e2e-framework/v1alpha1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">test-responder</span>
</span></span></code></pre></div><p>The <code>ref</code> is the interface between test-2-controller and test-1-controller. Its simple operation involves fetching this
reference, whatever the kind is, adding a label to it, and patching that object back to Kubernetes.</p>
<p>The label that it adds is <code>controller-e2e-framework.controlled = true</code>.</p>
<p>This repository contains another main ingredient. A simple Tilt file that does the following. It builds the project and
sets up all necessary yaml objects like the CRD definition, RBAC, any patches that might exist and the deployment.</p>
<p>This is important to note for various reasons. First, if we would build a testing image instead of using Tilt, we would
flood the package manager with a bunch of test imagines. Or, always set the <code>latest</code> image, in which case, we would lose
the ability to debug any problems. Further, we would have to have some kind of way to download the manifest files that
correspond to that version. If doing local development, that would be a hassle or we would have to have a checked-out
source of the manifest files anyways.</p>
<p>Thus, we bring together all of this with Tilt which uses a local registry and the files from the checked-out source.</p>
<p>This simple Tiltfile looks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># -*- mode: Python -*-</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl_cmd <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;kubectl&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># verify kubectl command exists</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> str(local(<span style="color:#e6db74">&#34;command -v &#34;</span> <span style="color:#f92672">+</span> kubectl_cmd <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; || true&#34;</span>, quiet <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>)) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span>:
</span></span><span style="display:flex;"><span>    fail(<span style="color:#e6db74">&#34;Required command &#39;&#34;</span> <span style="color:#f92672">+</span> kubectl_cmd <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;&#39; not found in PATH&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Use kustomize to build the install yaml files</span>
</span></span><span style="display:flex;"><span>install <span style="color:#f92672">=</span> kustomize(<span style="color:#e6db74">&#39;config/default&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Update the root security group. Tilt requires root access to update the</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># running process.</span>
</span></span><span style="display:flex;"><span>objects <span style="color:#f92672">=</span> decode_yaml_stream(install)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> o <span style="color:#f92672">in</span> objects:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> o<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;kind&#39;</span>) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;Deployment&#39;</span> <span style="color:#f92672">and</span> o<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;metadata&#39;</span>)<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;name&#39;</span>) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;test-1-controller&#39;</span>:
</span></span><span style="display:flex;"><span>        o[<span style="color:#e6db74">&#39;spec&#39;</span>][<span style="color:#e6db74">&#39;template&#39;</span>][<span style="color:#e6db74">&#39;spec&#39;</span>][<span style="color:#e6db74">&#39;securityContext&#39;</span>][<span style="color:#e6db74">&#39;runAsNonRoot&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>updated_install <span style="color:#f92672">=</span> encode_yaml_stream(objects)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Apply the updated yaml to the cluster.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Allow duplicates so the e2e test can include this tilt file with other tilt files</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># setting up the same namespace.</span>
</span></span><span style="display:flex;"><span>k8s_yaml(updated_install, allow_duplicates <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>load(<span style="color:#e6db74">&#39;ext://restart_process&#39;</span>, <span style="color:#e6db74">&#39;docker_build_with_restart&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># enable hot reloading by doing the following:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - locally build the whole project</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - create a docker imagine using tilt&#39;s hot-swap wrapper</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - push that container to the local tilt registry</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Once done, rebuilding now should be a lot faster since only the relevant</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># binary is rebuilt and the hot swat wrapper takes care of the rest.</span>
</span></span><span style="display:flex;"><span>local_resource(
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;test-1-controller-binary&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o bin/manager ./&#39;</span>,
</span></span><span style="display:flex;"><span>    deps <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;main.go&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;go.mod&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;go.sum&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;api&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;controllers&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;pkg&#34;</span>,
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Build the docker image for our controller. We use a specific Dockerfile</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># since tilt can&#39;t run on a scratch container.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># `only` here is important, otherwise, the container will get updated</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># on _any_ file change. We only want to monitor the binary.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># If debugging is enabled, we switch to a different docker file using</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># the delve port.</span>
</span></span><span style="display:flex;"><span>entrypoint <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;/manager&#39;</span>]
</span></span><span style="display:flex;"><span>dockerfile <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;tilt.dockerfile&#39;</span>
</span></span><span style="display:flex;"><span>docker_build_with_restart(
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;ghcr.io/controller-e2e-framework/test-1-controller&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;.&#39;</span>,
</span></span><span style="display:flex;"><span>    dockerfile <span style="color:#f92672">=</span> dockerfile,
</span></span><span style="display:flex;"><span>    entrypoint <span style="color:#f92672">=</span> entrypoint,
</span></span><span style="display:flex;"><span>    only<span style="color:#f92672">=</span>[
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#39;./bin&#39;</span>,
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>    live_update <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>        sync(<span style="color:#e6db74">&#39;./bin/manager&#39;</span>, <span style="color:#e6db74">&#39;/manager&#39;</span>),
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p>Basic things, plus the modification of the root securityContext so Tilt can hot-swap the binary.</p>
<h2 id="test-2-controller">Test 2 Controller<a hidden class="anchor" aria-hidden="true" href="#test-2-controller">#</a></h2>
<p>Test 2 controller looks at a responder object and once it detects the above label on the object, it will set a status
flag called <code>Acquired</code> to <code>true</code>. Also, a simple operation just to demo how these two controllers work together.</p>
<p>This repository has the same Tiltfile as test-1-controller.</p>
<h2 id="e2e-framework">E2E Framework<a hidden class="anchor" aria-hidden="true" href="#e2e-framework">#</a></h2>
<p>Now comes the main menu. The heart of the thing.</p>
<p>First, we can determine the flow. We would like to apply two files. <code>controller-sample.yaml</code> and <code>responder-sample.yaml</code>.
This will kick-start the whole process of reconciliation of the responder object.</p>
<p>Once these two exists and we verified that they exist, we will wait for the label to be applied and the <code>Acquired</code> flag
to be set to true.</p>
<p>Let&rsquo;s look at the architecture of this whole thing.</p>
<p><img alt="architecture" loading="lazy" src="/img/2023/03/12/architecture.png"></p>
<p>What happens here is as follows&hellip; e2e-framework has a <code>TestMain</code> function defined.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestMain</span>(<span style="color:#a6e22e">m</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">M</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">cfg</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">envconf</span>.<span style="color:#a6e22e">NewFromFlags</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">testEnv</span> = <span style="color:#a6e22e">env</span>.<span style="color:#a6e22e">NewWithConfig</span>(<span style="color:#a6e22e">cfg</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">kindClusterName</span> = <span style="color:#a6e22e">envconf</span>.<span style="color:#a6e22e">RandomName</span>(<span style="color:#e6db74">&#34;test-controller-e2e&#34;</span>, <span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">namespace</span> = <span style="color:#a6e22e">envconf</span>.<span style="color:#a6e22e">RandomName</span>(<span style="color:#e6db74">&#34;namespace&#34;</span>, <span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">testEnv</span>.<span style="color:#a6e22e">Setup</span>(
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">envfuncs</span>.<span style="color:#a6e22e">CreateKindCluster</span>(<span style="color:#a6e22e">kindClusterName</span>),
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">envfuncs</span>.<span style="color:#a6e22e">CreateNamespace</span>(<span style="color:#a6e22e">namespace</span>),
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">shared</span>.<span style="color:#a6e22e">RunTiltForControllers</span>(<span style="color:#e6db74">&#34;test-1-controller&#34;</span>, <span style="color:#e6db74">&#34;test-2-controller&#34;</span>),
</span></span><span style="display:flex;"><span>	)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">testEnv</span>.<span style="color:#a6e22e">Finish</span>(
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">envfuncs</span>.<span style="color:#a6e22e">DeleteNamespace</span>(<span style="color:#a6e22e">namespace</span>),
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">envfuncs</span>.<span style="color:#a6e22e">DestroyKindCluster</span>(<span style="color:#a6e22e">kindClusterName</span>),
</span></span><span style="display:flex;"><span>	)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Exit</span>(<span style="color:#a6e22e">testEnv</span>.<span style="color:#a6e22e">Run</span>(<span style="color:#a6e22e">m</span>))
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This function has a <code>Setup</code> and a <code>Teardown</code> phase. During this phase, a kind cluster is created and <code>tilt ci</code> is
executed to bring up a cluster and run tilt. But what Tiltfile does it run? Well&hellip; it imports all the Tiltfiles of the
defined controllers.</p>
<p>This part:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">shared</span>.<span style="color:#a6e22e">RunTiltForControllers</span>(<span style="color:#e6db74">&#34;test-1-controller&#34;</span>, <span style="color:#e6db74">&#34;test-2-controller&#34;</span>),
</span></span></code></pre></div><p>But where are they? They have to be checked-out next to this project. Then, the framework will do a <code>cd </code>..` like a
thing and look for these folders until it either finds them or reaches the root.</p>
<p><code>tilt ci</code> is super convenient because it will run to completion or fail if it doesn&rsquo;t start up for whatever reason. Thus
we can be sure that we set up RBAC and controller settings correctly. Something that we can&rsquo;t test through pure unit
testing.</p>
<p>Once we have a cluster and tilt the test starts. Here we have steps that are either a <code>Setup</code> an <code>Assess</code> or a
<code>Teardown</code>.</p>
<p>We can extract a bunch of steps here to make it easy to just plug together tests using common steps.</p>
<p>Like, setting up a scheme, looking for objects, checking object state, applying test data, etc.</p>
<p>In this test we do something like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestControllerApply</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Log</span>(<span style="color:#e6db74">&#34;running component version apply&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">feature</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">features</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;Custom Controller&#34;</span>).
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Setup</span>(<span style="color:#a6e22e">setup</span>.<span style="color:#a6e22e">AddSchemeAndNamespace</span>(<span style="color:#a6e22e">cv1</span>.<span style="color:#a6e22e">AddToScheme</span>, <span style="color:#a6e22e">namespace</span>)).
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Setup</span>(<span style="color:#a6e22e">setup</span>.<span style="color:#a6e22e">AddSchemeAndNamespace</span>(<span style="color:#a6e22e">rv1</span>.<span style="color:#a6e22e">AddToScheme</span>, <span style="color:#a6e22e">namespace</span>)).
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Setup</span>(<span style="color:#a6e22e">setup</span>.<span style="color:#a6e22e">ApplyTestData</span>(<span style="color:#a6e22e">v1alpha1</span>.<span style="color:#a6e22e">AddToScheme</span>, <span style="color:#a6e22e">namespace</span>, <span style="color:#e6db74">&#34;*&#34;</span>)).
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Assess</span>(<span style="color:#e6db74">&#34;check if controller was created&#34;</span>, <span style="color:#a6e22e">assess</span>.<span style="color:#a6e22e">ResourceWasCreated</span>(<span style="color:#e6db74">&#34;controller-sample&#34;</span>, <span style="color:#a6e22e">namespace</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">cv1</span>.<span style="color:#a6e22e">Controller</span>{})).
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Assess</span>(<span style="color:#e6db74">&#34;check if responder was created&#34;</span>, <span style="color:#a6e22e">assess</span>.<span style="color:#a6e22e">ResourceWasCreated</span>(<span style="color:#e6db74">&#34;responder-sample&#34;</span>, <span style="color:#a6e22e">namespace</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">rv1</span>.<span style="color:#a6e22e">Responder</span>{})).
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Assess</span>(<span style="color:#e6db74">&#34;wait for responder condition to be true&#34;</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>, <span style="color:#a6e22e">cfg</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">envconf</span>.<span style="color:#a6e22e">Config</span>) <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">...</span>
</span></span></code></pre></div><p>We have then waiters or waiting steps for certain conditions and once everything is tested and done, we remove all
objects in a <code>Teardown</code> so the next test doesn&rsquo;t collide with anything.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>		<span style="color:#a6e22e">Teardown</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>, <span style="color:#a6e22e">cfg</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">envconf</span>.<span style="color:#a6e22e">Config</span>) <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Helper</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Log</span>(<span style="color:#e6db74">&#34;teardown&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// remove test resources before exiting
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#a6e22e">r</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">resources</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">cfg</span>.<span style="color:#a6e22e">Client</span>().<span style="color:#a6e22e">RESTConfig</span>())
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">decoder</span>.<span style="color:#a6e22e">DecodeEachFile</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">DirFS</span>(<span style="color:#e6db74">&#34;./testdata&#34;</span>), <span style="color:#e6db74">&#34;*&#34;</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">decoder</span>.<span style="color:#a6e22e">DeleteHandler</span>(<span style="color:#a6e22e">r</span>),           <span style="color:#75715e">// try to DELETE objects after decoding
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				<span style="color:#a6e22e">decoder</span>.<span style="color:#a6e22e">MutateNamespace</span>(<span style="color:#a6e22e">namespace</span>), <span style="color:#75715e">// inject a namespace into decoded objects, before calling DeleteHandler
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Log</span>(<span style="color:#e6db74">&#34;teardown done&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ctx</span>
</span></span><span style="display:flex;"><span>		}).<span style="color:#a6e22e">Feature</span>()
</span></span></code></pre></div><p>This is super convenient because we tested apply, scheme, delete and finalizers, everything in one go.</p>
<p>And the <strong>BEST</strong> part about all this is that the ONLY thing the user needs to run is <em>just</em> <code>go test ./...</code>.</p>
<p>You can funk it up if you wish to only run a single suite with <code>go test -v ./test/controller</code>.</p>
<h2 id="ci">CI<a hidden class="anchor" aria-hidden="true" href="#ci">#</a></h2>
<p>To set all this up in a CI that runs it continuously or some kind of trigger just set it up like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">name</span>: <span style="color:#ae81ff">e2e</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">on</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">workflow_dispatch</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">schedule</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">cron</span>: <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">0</span> * * <span style="color:#ae81ff">1</span> <span style="color:#75715e"># every Monday at 00:00</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">permissions</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">contents</span>: <span style="color:#ae81ff">read</span> <span style="color:#75715e"># for actions/checkout to fetch code</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">jobs</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">kind-linux</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">runs-on</span>: <span style="color:#ae81ff">ubuntu-latest</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">steps</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Checkout this repo</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">uses</span>: <span style="color:#ae81ff">actions/checkout@v3</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">with</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">path</span>: <span style="color:#ae81ff">e2e-framework</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Checkout test-1-framework</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">uses</span>: <span style="color:#ae81ff">actions/checkout@v3</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">with</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">repository</span>: <span style="color:#e6db74">&#39;controller-e2e-framework/test-1-controller&#39;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">path</span>: <span style="color:#ae81ff">test-1-controller</span>
</span></span><span style="display:flex;"><span>     - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Checkout test-2-controller</span>
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">uses</span>: <span style="color:#ae81ff">actions/checkout@v3</span>
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">with</span>:
</span></span><span style="display:flex;"><span>         <span style="color:#f92672">repository</span>: <span style="color:#e6db74">&#39;controller-e2e-framework/test-2-controller&#39;</span>
</span></span><span style="display:flex;"><span>         <span style="color:#f92672">path</span>: <span style="color:#ae81ff">test-2-controller</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Setup Go</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">uses</span>: <span style="color:#ae81ff">actions/setup-go@v3</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">with</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">go-version-file</span>: <span style="color:#e6db74">&#39;${{ github.workspace }}/e2e-framework/go.mod&#39;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Restore Go cache</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">uses</span>: <span style="color:#ae81ff">actions/cache@v3</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">with</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/home/runner/work/_temp/_github_home/go/pkg/mod</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">key</span>: <span style="color:#ae81ff">${{ runner.os }}-go-${{ hashFiles(&#39;**/go.sum&#39;) }}</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">restore-keys</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            ${{ runner.os }}-go-</span>            
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Run tests</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">run</span>: <span style="color:#ae81ff">cd e2e-framework &amp;&amp; go test ./...</span>
</span></span></code></pre></div><p><em>Note</em> that you need to have checkout access to all repositories involved.</p>
<h2 id="conclusion">Conclusion<a hidden class="anchor" aria-hidden="true" href="#conclusion">#</a></h2>
<p>I find this testing amazingly simple. It lets me focus on the tests and I <strong>know</strong> that I will run the same thing in CI
and my <em>local</em>__ environment. And I know that any modification I&rsquo;ll do in code will immediately be tested without me
having to either run something weird with exported environment properties such as <strong>TEST_IMAGE</strong> or a dedicated test
runner with some weird parameters. CI runs the same thing I&rsquo;m running on my local environment. And that&rsquo;s <code>go test ./...</code>.</p>
<p>Thank you for reading.</p>
<p>And as always, have a nice day.</p>
<p>Gergely.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="https://skarlso.github.io/2023/05/10/dark-mode/">
    <span class="title">« Prev</span>
    <br>
    <span>Dark mode and a new theme</span>
  </a>
  <a class="next" href="https://skarlso.github.io/2023/02/25/rapid-controller-development-with-tilt/">
    <span class="title">Next »</span>
    <br>
    <span>Rapid Kubernetes Controller Development with Tilt</span>
  </a>
</nav>

  </footer><div id="disqus_thread"></div>
<script>
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "hannibalDisqus" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="https://skarlso.github.io/">Ramblings of a cloud engineer</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
