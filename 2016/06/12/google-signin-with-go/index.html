<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <title>
    How to do Google sign-in with Go // Ramblings of a build engineer
  </title>

  <link href="http://gmpg.org/xfn/11" rel="profile">
<meta http-equiv="content-type" content="text/html; charset=utf-8">


<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

<meta name="description" content="">
<meta name="keywords" content="">
<meta name="author" content="hannibal">
<meta name="generator" content="Hugo 0.16" />

  <meta property="og:title" content="How to do Google sign-in with Go" />
<meta property="og:description" content="" />
<meta property="og:type" content="website" />
<meta property="og:locale" content="en_US" />
<meta property="og:url" content="https://skarlso.github.io/2016/06/12/google-signin-with-go" />


  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.5.0/base-min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.5.0/pure-min.css">
  
  
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.5.0/grids-responsive-min.css">
  
  

  <link rel="stylesheet" href="https://skarlso.github.io//css/redlounge.css">
  <link rel="stylesheet" href="https://skarlso.github.io/css/prism.css">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet">
  <link href='//fonts.googleapis.com/css?family=Raleway:400,200,100,700,300,500,600,800' rel='stylesheet' type='text/css'>
  <link href='//fonts.googleapis.com/css?family=Libre+Baskerville:400,700,400italic' rel='stylesheet' type='text/css'>
  <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-69463020-2', 'auto');
        ga('send', 'pageview');
  </script>

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://skarlso.github.io/touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="https://skarlso.github.io/favicon.png">

  
  <link href="" rel="alternate" type="application/rss+xml" title="Ramblings of a build engineer" />

    
  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.7/styles/true.min.css">
  
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.7/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>


  

  

  
</head>

<body>
	

	<div id="layout" class="pure-g">
    <div class="sidebar pure-u-1 pure-u-md-1-4">
  <div class="header">
    

	

    <h1 class="brand-title">Ramblings...</h1>
    <h2 class="brand-tagline">...of a build engineer.</h2>

    <nav class="nav">
      <ul class="nav-list">
        <li class="nav-item"><span class="nav-item-separator">//</span><a href="https://skarlso.github.io/">Home</a></li>
        
      </ul>
    </nav>

    
    <div class="social-buttons">
      
        
        <a href="http://skarlso.com" target="_blank"><i class='fa fa-fort-awesome fa-3x'></i></a>
        
      
      
    </div>
    

  </div>
</div>

	
	

    <div class="content pure-u-1 pure-u-md-3-4">
		<a name="top"></a>
		

		
			
		    <div id="toc" class="pure-u-1 pure-u-md-1-4">
				<small class="toc-label">Contents</small>
		   	 	<nav id="TableOfContents">
<ul>
<li><a href="#setup">Setup</a>
<ul>
<li><a href="#google-oauth-token">Google OAuth token</a></li>
</ul></li>
<li><a href="#the-application">The Application</a>
<ul>
<li><a href="#library">Library</a></li>
<li><a href="#setup-creds">Setup - Creds</a></li>
<li><a href="#setup-oauth-client">Setup - OAuth client</a></li>
</ul></li>
<li><a href="#registration">Registration</a>
<ul>
<li><a href="#getting-the-client">Getting the Client</a></li>
<li><a href="#obtaining-information-from-the-user">Obtaining information from the user</a></li>
</ul></li>
<li><a href="#putting-it-all-together">Putting it all together</a></li>
<li><a href="#google-api-documentation">Google API Documentation</a></li>
</ul>
</nav>
		    </div>
		    
	    
  		<section class="post">
            <h1 class="post-title">
              <a href="https://skarlso.github.io/2016/06/12/google-signin-with-go">How to do Google sign-in with Go</a>
            </h1>
            <h3 class="post-subtitle">
            	
            </h3>
            
            	<span class="post-date">
                	<span class="post-date-day"><sup>12</sup></span><span class="post-date-separator">/</span><span class="post-date-month">Jun</span> <span class="post-date-year">2016</span>
            	</span>
            	
            
            	
            		<span class="post-author-single">By <a class="post-author"  target="">hannibal</a></span>
            		




            	
            

			
			
				<div class="post-categories">
				
					<a class="post-category post-category-go" href="https://skarlso.github.io//categories/go">Go</a>
				
					<a class="post-category post-category-golang" href="https://skarlso.github.io//categories/golang">Golang</a>
				
					<a class="post-category post-category-web" href="https://skarlso.github.io//categories/web">Web</a>
				
				</div>
			

			

			

            

<p>Hi folks.</p>

<p>Today, I would like to write up a step - by - step guid with a sample web app on how to do Google assisted sign-in and user handling.</p>

<p>Let&rsquo;s get started.</p>

<h1 id="setup">Setup</h1>

<h2 id="google-oauth-token">Google OAuth token</h2>

<p>First things first, what you need is, to register your application with Google, so you&rsquo;ll get a Token that you can use for authentication purposes.</p>

<p>You can do there here -&gt; <a href="https://console.developers.google.com/iam-admin/projects">Google Developer Console</a>. You&rsquo;ll have to create a new project. Once it&rsquo;s done, click on <code>Credentials</code> and create an OAuth token. You should see something like this -&gt; &ldquo;To create an OAuth client ID, you must first set a product name on the consent screen.&rdquo;. Go through the questions, like, what type your application is, and then you&rsquo;re done. I&rsquo;m selecting Web App for this tutorial. In the questions there is a section asking for redirect URL, there, write the url you wish to use when authenticating. Do NOT use <code>localhost</code>. If you are running on your own, use <a href="http://127.0.0.1:port/whatever">http://127.0.0.1:port/whatever</a>.</p>

<p>This will get you a <code>client ID</code> and a <code>client secret</code>. I&rsquo;m going to save these into a file which will sit next to my web app. It could be stored more securely, for example, in a database or a mounted secure, encrypted drive, and so and so forth, but that&rsquo;s not the point of this tutorial right now.</p>

<p>Your application can now be identified, so login can happen using one&rsquo;s Google creds.</p>

<h1 id="the-application">The Application</h1>

<h2 id="library">Library</h2>

<p>Google has a nice little library to use with OAuth 2.0 which I shall be using as well. The library is available here =&gt; <a href="https://github.com/golang/oauth2">Google OAth 2.0</a>. It&rsquo;s a bit cryptic at first to setup, but not to worry. After a little bit of fiddling you&rsquo;ll understand fast what it does, and how you can use it.</p>

<h2 id="setup-creds">Setup - Creds</h2>

<p>Let&rsquo;s create a little setup which configures our credentials from the file. This is pretty straightforward.</p>

<pre><code class="language-go">// Credentials which stores google ids.
type Credentials struct {
    Cid string `json:&quot;cid&quot;`
    Csecret string `json:&quot;csecret&quot;`
}

func init() {
    var c Credentials
    file, err := ioutil.ReadFile(&quot;./creds.json&quot;)
    if err != nil {
        fmt.Printf(&quot;File error: %v\n&quot;, err)
        os.Exit(1)
    }
    json.Unmarshal(file, &amp;c)
}
</code></pre>

<p>Once we have the creds loaded, we can now go on to construct our OAuth client.</p>

<h2 id="setup-oauth-client">Setup - OAuth client</h2>

<p>Construct the OAuth config like this:</p>

<pre><code class="language-go">conf := &amp;oauth2.Config{
  ClientID:     c.Cid,
  ClientSecret: c.Csecret,
  RedirectURL:  &quot;http://localhost:9090/auth&quot;, // If the loging is successful, this will be the redirected URL location to with a query param called 'code'
  Scopes: []string{
    &quot;https://www.googleapis.com/auth/userinfo.email&quot;, // You have to select your own scope from here -&gt; https://developers.google.com/identity/protocols/googlescopes#google_sign-in
  },
  Endpoint: google.Endpoint,
}
</code></pre>

<p>It will give you a conf struct which you can then use to Authenticate your user. Next, all we need to do is call <code>AuthCodeURL</code> on this config. It will give us a URL we need to call which redirects to a Google Sign-In form. Once the user fills that out, it will redirect to the given URL with a callback and provide a TOKEN in the form of a query parameter called <code>code</code>. This will look something like this <code>http://127.0.0.1:9090/auth?code=4FLKFskdjflf3343d4f/*</code>. To get the URL let&rsquo;s extract this into a small function:</p>

<pre><code class="language-go">func getLoginURL() string {
    return conf.AuthCodeURL(&quot;&quot;)
}
</code></pre>

<p>We can put this URL as a link to a Button. For example:</p>

<pre><code class="language-go">func loginHandler(c *gin.Context) {
    c.Writer.Write([]byte(&quot;&lt;html&gt;&lt;title&gt;Golang Google&lt;/title&gt; &lt;body&gt; &lt;a href='&quot; + getLoginURL() + &quot;'&gt;&lt;button&gt;Login with Google!&lt;/button&gt; &lt;/a&gt; &lt;/body&gt;&lt;/html&gt;&quot;))
}
</code></pre>

<p>The link provided here, will be the Sign-In form redirection URL.</p>

<h1 id="registration">Registration</h1>

<p>So what now? How do we actually get to the registration / login part of this? How does this all fit together? With Google, after you got the token, you can construct an authenticated Google HTTP Client.</p>

<h2 id="getting-the-client">Getting the Client</h2>

<p>To obtain the client, you need to do this:</p>

<pre><code class="language-go">  // Handle the exchange code to initiate a transport.
tok, err := conf.Exchange(oauth2.NoContext, c.Query(&quot;code&quot;))
if err != nil {
	c.AbortWithError(http.StatusBadRequest, err)
}

client := conf.Client(oauth2.NoContext, tok)
</code></pre>

<p>To get something that you can actually use from this do the following&hellip;</p>

<h2 id="obtaining-information-from-the-user">Obtaining information from the user</h2>

<p>It&rsquo;s their API url that you need to call with the authenticated client. The code for that:</p>

<pre><code class="language-go">resp, err := client.Get(&quot;https://www.googleapis.com/oauth2/v3/userinfo&quot;)
  if err != nil {
  c.AbortWithError(http.StatusBadRequest, err)
}
defer resp.Body.Close()
data, _ := ioutil.ReadAll(resp.Body)
log.Println(&quot;Resp body: &quot;, string(data))
</code></pre>

<p>And this will yield a body like this:</p>

<pre><code class="language-json">{
 &quot;sub&quot;: &quot;1111111111111111111111&quot;,
 &quot;name&quot;: &quot;Your Name&quot;,
 &quot;given_name&quot;: &quot;Your&quot;,
 &quot;family_name&quot;: &quot;Name&quot;,
 &quot;profile&quot;: &quot;https://plus.google.com/1111111111111111111111&quot;,
 &quot;picture&quot;: &quot;https://lh3.googleusercontent.com/asdfadsf/AAAAAAAAAAI/Aasdfads/Xasdfasdfs/photo.jpg&quot;,
 &quot;email&quot;: &quot;your@gmail.com&quot;,
 &quot;email_verified&quot;: true,
 &quot;gender&quot;: &quot;male&quot;
}
</code></pre>

<p>Tadaam. Parse this, and you&rsquo;ve got an email which you can store somewhere for registration purposes.</p>

<h1 id="putting-it-all-together">Putting it all together</h1>

<p>How does this all look together? Something like this. Though, I&rsquo;ve built no front-end.</p>

<pre><code class="language-go">package main

import (
    &quot;fmt&quot;
    &quot;encoding/json&quot;
    &quot;io/ioutil&quot;
    &quot;log&quot;
    &quot;os&quot;
    &quot;net/http&quot;

    &quot;github.com/gin-gonic/gin&quot;
    &quot;golang.org/x/oauth2&quot;
    &quot;golang.org/x/oauth2/google&quot;
)

// Credentials which stores google ids.
type Credentials struct {
    Cid     string `json:&quot;cid&quot;`
    Csecret string `json:&quot;csecret&quot;`
}

// User is a retrieved and authentiacted user.
type User struct {
    Sub string `json:&quot;sub&quot;`
    Name string `json:&quot;name&quot;`
    GivenName string `json:&quot;given_name&quot;`
    FamilyName string `json:&quot;family_name&quot;`
    Profile string `json:&quot;profile&quot;`
    Picture string `json:&quot;picture&quot;`
    Email string `json:&quot;email&quot;`
    EmailVerified string `json:&quot;email_verified&quot;`
    Gender string `json:&quot;gender&quot;`
}

var cred Credentials
var conf *oauth2.Config

func indexHandler(c *gin.Context) {
    c.HTML(http.StatusOK, &quot;index.tmpl&quot;, gin.H{})
}

func init() {
    file, err := ioutil.ReadFile(&quot;./creds.json&quot;)
    if err != nil {
        log.Printf(&quot;File error: %v\n&quot;, err)
        os.Exit(1)
    }
    json.Unmarshal(file, &amp;cred)

    conf = &amp;oauth2.Config{
        ClientID:     cred.Cid,
        ClientSecret: cred.Csecret,
        RedirectURL:  &quot;http://127.0.0.1:9090/auth&quot;,
        Scopes: []string{
        &quot;https://www.googleapis.com/auth/userinfo.email&quot;, // You have to select your own scope from here -&gt; https://developers.google.com/identity/protocols/googlescopes#google_sign-in
        },
        Endpoint: google.Endpoint,
    }
}

func getLoginURL() string {
    return conf.AuthCodeURL(&quot;&quot;)
}

func authHandler(c *gin.Context) {
    // Handle the exchange code to initiate a transport.
	tok, err := conf.Exchange(oauth2.NoContext, c.Query(&quot;code&quot;))
	if err != nil {
		c.AbortWithError(http.StatusBadRequest, err)
	}

	client := conf.Client(oauth2.NoContext, tok)
	email, err := client.Get(&quot;https://www.googleapis.com/oauth2/v3/userinfo&quot;)
    if err != nil {
		c.AbortWithError(http.StatusBadRequest, err)
	}
    defer email.Body.Close()
    data, _ := ioutil.ReadAll(email.Body)
    log.Println(&quot;Email body: &quot;, string(data))
    c.Status(http.StatusOK)
}

func loginHandler(c *gin.Context) {
    c.Writer.Write([]byte(&quot;&lt;html&gt;&lt;title&gt;Golang Google&lt;/title&gt; &lt;body&gt; &lt;a href='&quot; + getLoginURL() + &quot;'&gt;&lt;button&gt;Login with Google!&lt;/button&gt; &lt;/a&gt; &lt;/body&gt;&lt;/html&gt;&quot;))
}

func main() {
    router := gin.Default()
    router.Static(&quot;/css&quot;, &quot;./static/css&quot;)
    router.Static(&quot;/img&quot;, &quot;./static/img&quot;)
    router.LoadHTMLGlob(&quot;templates/*&quot;)

    router.GET(&quot;/&quot;, indexHandler)
    router.GET(&quot;/login&quot;, loginHandler)
    router.GET(&quot;/auth&quot;, authHandler)

    router.Run(&quot;127.0.0.1:9090&quot;)
}
</code></pre>

<p>This is it folks. Notice that there are some more stuff in there. Disregard them, or delete them. Like the index handler and the templates. They are just something that I used.</p>

<p>After you have the email, you should be able to go on and store it and retrieve it later if you want. With Gin, you can even do authenticated end-points.</p>

<pre><code class="language-go">authorized := r.Group(&quot;/&quot;)
// per group middleware! in this case we use the custom created
// AuthRequired() middleware just in the &quot;authorized&quot; group.
authorized.Use(AuthRequired)
{
    authorized.POST(&quot;/login&quot;, loginEndpoint)
    authorized.POST(&quot;/submit&quot;, submitEndpoint)
    authorized.POST(&quot;/read&quot;, readEndpoint)

    // nested group
    testing := authorized.Group(&quot;testing&quot;)
    testing.GET(&quot;/analytics&quot;, analyticsEndpoint)
}
</code></pre>

<p>Once you have your Google Auth, you can access these URLS, or do a c.AbortWithError which will stop the chain and redirect the user back to a Login page.</p>

<p>I hope this helped. Any comments or advice are welcomed.</p>

<h1 id="google-api-documentation">Google API Documentation</h1>

<p>The documentation to this whole process and MUCH more information can be found here =&gt; <a href="https://developers.google.com/identity/protocols/OAuth2">Google API Docs</a>.</p>

<p>Thanks for reading,
Gergely.</p>

	
			

			

			
				<div class="paging">
					<span class="paging-label">More Reading</span>
					

					
					<div class="paging-older">
						<span class="dark-red">Older</span><span class="decorative-marker">//</span>
			            <a class="paging-link" href="https://skarlso.github.io/2016/04/17/minecraft-server-aws-s3-backup-part2">Minecraft world automatic backup to AWS S3 bucket - Part 2 (Custom functions)</a>
		            </div>
		            
	            </div>
            
          </section>
          	<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'hannibalDisqus';
    var disqus_identifier = 'https:\/\/skarlso.github.io\/2016\/06\/12\/google-signin-with-go';
    var disqus_title = 'How to do Google sign-in with Go';
    var disqus_url = 'https:\/\/skarlso.github.io\/2016\/06\/12\/google-signin-with-go';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        
      <div class="footer">
	<hr class="thin" />
	<div class="pure-menu pure-menu-horizontal pure-menu-open">
		<ul class="footer-menu">
		
		</ul>
	</div>

	<p>&copy; 2016. All rights reserved.</p>
</div>
    </div>
  </div>
	

	

  <script src="https://skarlso.github.io/js/prism.js"></script>

</body>
</html>
