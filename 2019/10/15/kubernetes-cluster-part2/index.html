<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Using a Kubernetes based Cluster for Various Services with auto HTTPS - Part 2 | Ramblings of a cloud engineer</title>
<meta name="keywords" content="">
<meta name="description" content="Intro Hi folks.
This is a continuation of the previous post about my Kubernetes infrastructure located here. The two remaining points are to deploy Athens Go proxy and setting up monitoring.
Athens Let&rsquo;s start with Athens.
First of all if you are a helm user, Athens has an awesome set of helm charts which you can use to deploy it in your cluster. Located here.
I prefer to deploy my own config files, but that&rsquo;s me.">
<meta name="author" content="hannibal">
<link rel="canonical" href="https://skarlso.github.io/2019/10/15/kubernetes-cluster-part2/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.3613efbd0b1772781e8f49935e973cae632a7f61471c05b17be155505ccf87b5.css" integrity="sha256-NhPvvQsXcngej0mTXpc8rmMqf2FHHAWxe&#43;FVUFzPh7U=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://skarlso.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://skarlso.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://skarlso.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://skarlso.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://skarlso.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Using a Kubernetes based Cluster for Various Services with auto HTTPS - Part 2" />
<meta property="og:description" content="Intro Hi folks.
This is a continuation of the previous post about my Kubernetes infrastructure located here. The two remaining points are to deploy Athens Go proxy and setting up monitoring.
Athens Let&rsquo;s start with Athens.
First of all if you are a helm user, Athens has an awesome set of helm charts which you can use to deploy it in your cluster. Located here.
I prefer to deploy my own config files, but that&rsquo;s me." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://skarlso.github.io/2019/10/15/kubernetes-cluster-part2/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-10-15T21:01:00+01:00" />
<meta property="article:modified_time" content="2019-10-15T21:01:00+01:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Using a Kubernetes based Cluster for Various Services with auto HTTPS - Part 2"/>
<meta name="twitter:description" content="Intro Hi folks.
This is a continuation of the previous post about my Kubernetes infrastructure located here. The two remaining points are to deploy Athens Go proxy and setting up monitoring.
Athens Let&rsquo;s start with Athens.
First of all if you are a helm user, Athens has an awesome set of helm charts which you can use to deploy it in your cluster. Located here.
I prefer to deploy my own config files, but that&rsquo;s me."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Posts",
      "item": "https://skarlso.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "Using a Kubernetes based Cluster for Various Services with auto HTTPS - Part 2",
      "item": "https://skarlso.github.io/2019/10/15/kubernetes-cluster-part2/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Using a Kubernetes based Cluster for Various Services with auto HTTPS - Part 2",
  "name": "Using a Kubernetes based Cluster for Various Services with auto HTTPS - Part 2",
  "description": "Intro Hi folks.\nThis is a continuation of the previous post about my Kubernetes infrastructure located here. The two remaining points are to deploy Athens Go proxy and setting up monitoring.\nAthens Let\u0026rsquo;s start with Athens.\nFirst of all if you are a helm user, Athens has an awesome set of helm charts which you can use to deploy it in your cluster. Located here.\nI prefer to deploy my own config files, but that\u0026rsquo;s me.",
  "keywords": [
    
  ],
  "articleBody": "Intro Hi folks.\nThis is a continuation of the previous post about my Kubernetes infrastructure located here. The two remaining points are to deploy Athens Go proxy and setting up monitoring.\nAthens Let’s start with Athens.\nFirst of all if you are a helm user, Athens has an awesome set of helm charts which you can use to deploy it in your cluster. Located here.\nI prefer to deploy my own config files, but that’s me. So here is my preferred way of deploying Athens.\nSince this is also a subdomain of the previously created powerhouse namespace we are going to use that.\nPVC We are going to need a PersistentVolumeClaim for Athens so it can store all the things forever.\napiVersion: v1 kind: PersistentVolumeClaim metadata: namespace: powerhouse name: athens-storage spec: accessModes: - ReadWriteOnce resources: requests: storage: 10Gi storageClassName: do-block-storage Claim is very boring. Which means it just works.\nDeployment This is more interesting. Athens provides a lot of possibilities for the deployment. I’m just deploying the barest possible here. Which means, no user auth, no private repository support, ssh key configuration, etc… It’s a plain proxy installation.\napiVersion: apps/v1 kind: Deployment metadata: namespace: powerhouse name: athens-app labels: app: athens-proxy spec: replicas: 1 selector: matchLabels: app: athens-proxy template: metadata: labels: app: athens-proxy app.kubernetes.io/name: athens-proxy app.kubernetes.io/instance: athens-proxy spec: containers: - name: athens-proxy image: gomods/athens:v0.6.0 livenessProbe: httpGet: path: \"/healthz\" port: 3000 readinessProbe: httpGet: path: \"/readyz\" port: 3000 env: - name: ATHENS_GOGET_WORKERS value: \"3\" - name: ATHENS_STORAGE_TYPE value: \"disk\" - name: ATHENS_DISK_STORAGE_ROOT value: /var/lib/athens ports: - containerPort: 3000 name: athens-http volumeMounts: - name: athens-data mountPath: /var/lib/athens subPath: athens volumes: - name: athens-data persistentVolumeClaim: claimName: athens-storage Fun fact. The name of the app must not be just plain athens because that will result in an error: too many colons in address.\nThe issue is here: https://github.com/gomods/athens/issues/1038#issuecomment-457145658 Basically it’s because of the name used for the environment properties inside the container.\nService Now, let’s expose it.\nkind: Service apiVersion: v1 metadata: namespace: powerhouse name: athens-service labels: app: athens-proxy app.kubernetes.io/name: athens-proxy app.kubernetes.io/instance: athens-proxy spec: selector: app: athens-proxy app.kubernetes.io/name: athens-proxy app.kubernetes.io/instance: athens-proxy ports: - port: 80 targetPort: 3000 Ingress I’m using port 80 here because it’s convenient. But if you use any other port, don’t forget to alter your ingress to forward to that port and service.\napiVersion: extensions/v1beta1 kind: Ingress ... spec: tls: ... - hosts: - athens.powerhouse.com secretName: athens-cronohub-tls rules: ... - host: athens.powerhouse.com http: paths: - backend: serviceName: athens-service servicePort: 1234 path: / And that’s it! If you now visit https://athens.powerhouse.com it should say \"Welcome to The Athens Proxy\".\nNow, if you set this proxy with export GOPROXY=https://athens.powerhouse.com it should start to cache modules. It’s a fantastic proxy with a lot of capabilities. I encourage you to check it out and drop by it’s slack channel on Gopher slack called Athens.\nMonitoring Monitoring is a huge topic so I’m not going to talk about how to monitor or what. That is described in great many of posts. I especially recommend reading sysdig’s 6 part post on doing monitoring with Prometheus and Grafana and what to monitor and the four golden signals and whatnot. Starting here and here.\nPrometheus I’m going to deploy Prometheus. Prometheus is a monitoring tool which sits inside your cluster and gathers data about running pods, nodes, services, whatever you expose and wants to send data to it. It can also alert on things and can be integrated with tools like Graphana for nice front-end and metrics. Prometheus itself uses PromQL as its query language to gather data from different sources and do time series analytics and much much more.\nPlease visit the website and documentation for more details. It’s the defacto monitoring tool for Kubernetes. Again, I’m going to do a very basic installation of Prometheus. So basic in fact, that I don’t even have a PVC for it, because I don’t care at this point about retaining data.\nNamespace Let’s create it’s own namespace.\napiVersion: v1 kind: Namespace metadata: name: monitoring labels: name: monitoring Config Prometheus Server config is massive. I don’t expect you to pick up on everything in this thing, but I would encourage you to at least try to find out what these setting do… Our config yaml file contains the configuration file for Prometheus which we’ll later set up via a command line argument. It’s called prometheus.yml.\napiVersion: v1 kind: ConfigMap metadata: name: prometheus-server-conf labels: name: prometheus-server-conf namespace: monitoring data: prometheus.yml: |- global: scrape_interval: 5s evaluation_interval: 5s scrape_configs: - job_name: 'kubernetes-apiservers' kubernetes_sd_configs: - role: endpoints scheme: https tls_config: ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token relabel_configs: - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name] action: keep regex: default;kubernetes;https - job_name: 'kubernetes-nodes' scheme: https tls_config: ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token kubernetes_sd_configs: - role: node relabel_configs: - action: labelmap regex: __meta_kubernetes_node_label_(.+) - target_label: __address__ replacement: kubernetes.default.svc:443 - source_labels: [__meta_kubernetes_node_name] regex: (.+) target_label: __metrics_path__ replacement: /api/v1/nodes/${1}/proxy/metrics - job_name: 'kubernetes-pods' kubernetes_sd_configs: - role: pod relabel_configs: - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape] action: keep regex: true - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path] action: replace target_label: __metrics_path__ regex: (.+) - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port] action: replace regex: ([^:]+)(?::\\d+)?;(\\d+) replacement: $1:$2 target_label: __address__ - action: labelmap regex: __meta_kubernetes_pod_label_(.+) - source_labels: [__meta_kubernetes_namespace] action: replace target_label: kubernetes_namespace - source_labels: [__meta_kubernetes_pod_name] action: replace target_label: kubernetes_pod_name - job_name: 'kubernetes-cadvisor' scheme: https tls_config: ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token kubernetes_sd_configs: - role: node relabel_configs: - action: labelmap regex: __meta_kubernetes_node_label_(.+) - target_label: __address__ replacement: kubernetes.default.svc:443 - source_labels: [__meta_kubernetes_node_name] regex: (.+) target_label: __metrics_path__ replacement: /api/v1/nodes/${1}/proxy/metrics/cadvisor - job_name: 'kubernetes-service-endpoints' kubernetes_sd_configs: - role: endpoints relabel_configs: - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape] action: keep regex: true - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scheme] action: replace target_label: __scheme__ regex: (https?) - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path] action: replace target_label: __metrics_path__ regex: (.+) - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port] action: replace target_label: __address__ regex: ([^:]+)(?::\\d+)?;(\\d+) replacement: $1:$2 - action: labelmap regex: __meta_kubernetes_service_label_(.+) - source_labels: [__meta_kubernetes_namespace] action: replace target_label: kubernetes_namespace - source_labels: [__meta_kubernetes_service_name] action: replace target_label: kubernetes_name Mostly it’s just setting up what Prometheus should monitor and how. The important bits are the labels. How this is going to work is, that we will annotate the resources we want Prometheus to see. Which is pretty cool. Basically we will just alter a pod to include an annotation and it will begin monitoring it. No need to install anything anywhere or restart anything. Just add an annotation and bamm, you’re done.\nRBAC Prometheus needs permissions to access resources in the cluster such as API end-points and gathering data about the cluster itself. We will provide it with this permission through Role Based Access Control.\nWe’ll create a service account which Prometheus can use. We want it to access the whole cluster so we’ll use a ClusterRole.\napiVersion: rbac.authorization.k8s.io/v1beta1 kind: ClusterRole metadata: name: prometheus rules: - apiGroups: [\"\"] resources: - nodes - nodes/proxy - services - endpoints - pods verbs: [\"get\", \"list\", \"watch\"] - apiGroups: - extensions resources: - ingresses verbs: [\"get\", \"list\", \"watch\"] - nonResourceURLs: [\"/metrics\"] verbs: [\"get\"] --- apiVersion: rbac.authorization.k8s.io/v1beta1 kind: ClusterRoleBinding metadata: name: prometheus roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: prometheus subjects: - kind: ServiceAccount name: default namespace: monitoring This will give access to monitor the following resources: nodes, nodes/proxy, services, endpoints and pods. The action are get, list, watch. No modifications.\nWe’ll also allow Prometheus to watch ingresses for data traffic and allow it to do get requests to non-resource endpoint /metrics.\nDeployment Now, the deployment is actually pretty easy.\napiVersion: extensions/v1beta1 kind: Deployment metadata: name: prometheus-deployment namespace: monitoring spec: replicas: 1 template: metadata: labels: app: prometheus-server spec: containers: - name: prometheus image: prom/prometheus:v2.2.1 args: - \"--config.file=/etc/prometheus/prometheus.yml\" - \"--storage.tsdb.path=/prometheus/\" ports: - containerPort: 9090 volumeMounts: - name: prometheus-config-volume mountPath: /etc/prometheus/ - name: prometheus-storage-volume mountPath: /prometheus/ volumes: - name: prometheus-config-volume configMap: defaultMode: 420 name: prometheus-server-conf - name: prometheus-storage-volume emptyDir: {} The two interesting things here are the two arguments. The config file, which we include through the configMap and the storage. Which I’m not bind mounting.\nService Let’s expose Prometheus. Now, this may come as a surprise if you don’t know anything about Prometheus, but this is an in cluster monitoring tool. It’s usually not supposed to be accessed directly, but through tools like Graphana or used by tools like Alerting or traefik as a reverse proxy. As such, Prometheus does not support authentication or authorization or user management of any kind. That is usually taken care of by a reverse proxy or other means written about here and here.\nAs such, we can do a number of things. We can expose it as a NodePort service for example:\napiVersion: v1 kind: Service metadata: name: prometheus-service namespace: monitoring annotations: prometheus.io/scrape: 'true' prometheus.io/port: '9090' spec: selector: app: prometheus-server type: NodePort ports: - port: 8080 targetPort: 9090 nodePort: 30000 Or we just port forward the pod like this:\nk port-forward pods/prometheus-deployment-6bf45557bd-qc6t6 9090:9090 -n monitoring And access it by simply opening the url: http://127.0.0.1:9090.\nPrometheus Once you open it, you should see something like this, after running a small query:\nAdding in Resources to monitor In order to add a resource to monitor simply insert these annotations:\nannotations: prometheus.io/scrape: 'true' prometheus.io/port: '9090' Done.\nBonus Round – Graphana We deployed Athens and Prometheus to monitor our cluster. We don’t have anything before Prometheus that would be fancy, but installing Graphana is actually pretty easy. You can follow the instructions here.\nA very easy way of looking at some nice metrics without worrying about anything like users and such, is running a Graphana instance in docker on your local machine with:\ndocker run -d -p 3000:3000 grafana/grafana … and while you are forwarding the Prometheus end-point you navigate to your Graphana instance by opening 127.0.0.1:3000 and install a Prometheus data-point like this:\nAfter that navigate to a new dashboard and select a simple PromQL metric to see if it’s working. You should see something like this:\nNow you can create a new dashboard add a PVC to our Prometheus instance and enjoy all the metrics you can store!\nConclusion And this is it folks. Everything is installed and we can monitor things now. If you give Prometheus a PVC you can build some pretty awesome time series graphs too and see how your cluster behaves over time.\nThank you for reading! Gergely.\n",
  "wordCount" : "1664",
  "inLanguage": "en",
  "datePublished": "2019-10-15T21:01:00+01:00",
  "dateModified": "2019-10-15T21:01:00+01:00",
  "author":{
    "@type": "Person",
    "name": "hannibal"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://skarlso.github.io/2019/10/15/kubernetes-cluster-part2/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Ramblings of a cloud engineer",
    "logo": {
      "@type": "ImageObject",
      "url": "https://skarlso.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://skarlso.github.io" accesskey="h" title="Ramblings of a cloud engineer (Alt + H)">Ramblings of a cloud engineer</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://skarlso.github.io/archives" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://skarlso.github.io/search/" title="Search">
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://skarlso.github.io/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://skarlso.github.io/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://skarlso.github.io">Home</a>&nbsp;»&nbsp;<a href="https://skarlso.github.io/posts/">Posts</a></div>
    <h1 class="post-title">
      Using a Kubernetes based Cluster for Various Services with auto HTTPS - Part 2
    </h1>
    <div class="post-meta"><span title='2019-10-15 21:01:00 +0100 +0100'>October 15, 2019</span>&nbsp;·&nbsp;8 min&nbsp;·&nbsp;hannibal

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#intro" aria-label="Intro">Intro</a></li>
                <li>
                    <a href="#athens" aria-label="Athens">Athens</a><ul>
                        
                <li>
                    <a href="#pvc" aria-label="PVC">PVC</a></li>
                <li>
                    <a href="#deployment" aria-label="Deployment">Deployment</a></li>
                <li>
                    <a href="#service" aria-label="Service">Service</a></li>
                <li>
                    <a href="#ingress" aria-label="Ingress">Ingress</a></li></ul>
                </li>
                <li>
                    <a href="#monitoring" aria-label="Monitoring">Monitoring</a><ul>
                        
                <li>
                    <a href="#prometheus" aria-label="Prometheus">Prometheus</a><ul>
                        
                <li>
                    <a href="#namespace" aria-label="Namespace">Namespace</a></li>
                <li>
                    <a href="#config" aria-label="Config">Config</a></li></ul>
                </li>
                <li>
                    <a href="#rbac" aria-label="RBAC">RBAC</a></li>
                <li>
                    <a href="#deployment-1" aria-label="Deployment">Deployment</a></li>
                <li>
                    <a href="#service-1" aria-label="Service">Service</a></li>
                <li>
                    <a href="#prometheus-1" aria-label="Prometheus">Prometheus</a></li>
                <li>
                    <a href="#adding-in-resources-to-monitor" aria-label="Adding in Resources to monitor">Adding in Resources to monitor</a></li></ul>
                </li>
                <li>
                    <a href="#bonus-round----graphana" aria-label="Bonus Round &amp;ndash; Graphana">Bonus Round &ndash; Graphana</a></li>
                <li>
                    <a href="#conclusion" aria-label="Conclusion">Conclusion</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="intro">Intro<a hidden class="anchor" aria-hidden="true" href="#intro">#</a></h1>
<p>Hi folks.</p>
<p>This is a continuation of the previous post about my Kubernetes infrastructure located <a href="https://skarlso.github.io/2019/09/21/kubernetes-cluster/">here</a>. The two remaining points are to deploy Athens Go proxy and setting up monitoring.</p>
<h1 id="athens">Athens<a hidden class="anchor" aria-hidden="true" href="#athens">#</a></h1>
<p><img loading="lazy" src="/img/hosting/athens.png" alt="Athens"  />
</p>
<p>Let&rsquo;s start with <a href="https://github.com/gomods/athens">Athens</a>.</p>
<p>First of all if you are a helm user, Athens has an awesome set of helm charts which you can use to deploy it in your cluster.
Located <a href="https://github.com/gomods/athens/tree/master/charts/athens-proxy">here</a>.</p>
<p>I prefer to deploy my own config files, but that&rsquo;s me. So here is my preferred way of deploying Athens.</p>
<p>Since this is also a subdomain of the previously created <code>powerhouse</code> namespace we are going to use that.</p>
<h2 id="pvc">PVC<a hidden class="anchor" aria-hidden="true" href="#pvc">#</a></h2>
<p>We are going to need a PersistentVolumeClaim for Athens so it can store all the things forever.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">PersistentVolumeClaim</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">powerhouse</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">athens-storage</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">accessModes</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">ReadWriteOnce</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">storage</span>: <span style="color:#ae81ff">10Gi</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">storageClassName</span>: <span style="color:#ae81ff">do-block-storage</span>
</span></span></code></pre></div><p>Claim is very boring. Which means it just works.</p>
<h2 id="deployment">Deployment<a hidden class="anchor" aria-hidden="true" href="#deployment">#</a></h2>
<p>This is more interesting. Athens provides a lot of possibilities for the deployment. I&rsquo;m just deploying the barest possible here. Which means, no user auth, no private repository support, ssh key configuration, etc&hellip; It&rsquo;s a plain proxy installation.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">powerhouse</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">athens-app</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">athens-proxy</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">athens-proxy</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">athens-proxy</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app.kubernetes.io/name</span>: <span style="color:#ae81ff">athens-proxy</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app.kubernetes.io/instance</span>: <span style="color:#ae81ff">athens-proxy</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">athens-proxy</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">gomods/athens:v0.6.0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">livenessProbe</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">httpGet</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">path</span>: <span style="color:#e6db74">&#34;/healthz&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">port</span>: <span style="color:#ae81ff">3000</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">readinessProbe</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">httpGet</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">path</span>: <span style="color:#e6db74">&#34;/readyz&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">port</span>: <span style="color:#ae81ff">3000</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">env</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ATHENS_GOGET_WORKERS</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;3&#34;</span>
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ATHENS_STORAGE_TYPE</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;disk&#34;</span>
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ATHENS_DISK_STORAGE_ROOT</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">value</span>: <span style="color:#ae81ff">/var/lib/athens</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">3000</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">name</span>: <span style="color:#ae81ff">athens-http</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">athens-data</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/var/lib/athens</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">subPath</span>: <span style="color:#ae81ff">athens</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">athens-data</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">persistentVolumeClaim</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">claimName</span>: <span style="color:#ae81ff">athens-storage</span>
</span></span></code></pre></div><p>Fun fact. The name of the app must not be just plain <code>athens</code> because that will result in an error: <code>too many colons in address</code>.</p>
<p>The issue is here: <a href="https://github.com/gomods/athens/issues/1038#issuecomment-457145658">https://github.com/gomods/athens/issues/1038#issuecomment-457145658</a> Basically it&rsquo;s because of the name used for the environment properties inside the container.</p>
<h2 id="service">Service<a hidden class="anchor" aria-hidden="true" href="#service">#</a></h2>
<p>Now, let&rsquo;s expose it.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">powerhouse</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">athens-service</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">athens-proxy</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/name</span>: <span style="color:#ae81ff">athens-proxy</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/instance</span>: <span style="color:#ae81ff">athens-proxy</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">athens-proxy</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/name</span>: <span style="color:#ae81ff">athens-proxy</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/instance</span>: <span style="color:#ae81ff">athens-proxy</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">3000</span>
</span></span></code></pre></div><h2 id="ingress">Ingress<a hidden class="anchor" aria-hidden="true" href="#ingress">#</a></h2>
<p>I&rsquo;m using port 80 here because it&rsquo;s convenient. But if you use any other port, don&rsquo;t forget to alter your ingress to forward to that port and service.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">extensions/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Ingress</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tls</span>:
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">athens.powerhouse.com</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">secretName</span>: <span style="color:#ae81ff">athens-cronohub-tls</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">athens.powerhouse.com</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">athens-service</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">servicePort</span>: <span style="color:#ae81ff">1234</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/</span>
</span></span></code></pre></div><p>And that&rsquo;s it! If you now visit <code>https://athens.powerhouse.com</code> it should say <code>&quot;Welcome to The Athens Proxy&quot;</code>.</p>
<p>Now, if you set this proxy with <code>export GOPROXY=https://athens.powerhouse.com</code> it should start to cache modules. It&rsquo;s a fantastic proxy with a lot of capabilities. I encourage you to check it out and drop by it&rsquo;s slack channel on Gopher slack called Athens.</p>
<h1 id="monitoring">Monitoring<a hidden class="anchor" aria-hidden="true" href="#monitoring">#</a></h1>
<p>Monitoring is a huge topic so I&rsquo;m not going to talk about how to monitor or what. That is described in great many of posts. I especially recommend reading sysdig&rsquo;s 6 part post on doing monitoring with Prometheus and Grafana and what to monitor and the four golden signals and whatnot. Starting <a href="https://sysdig.com/blog/kubernetes-monitoring-prometheus/">here</a> and <a href="https://sysdig.com/blog/monitoring-kubernetes-with-sysdig-cloud/">here</a>.</p>
<h2 id="prometheus">Prometheus<a hidden class="anchor" aria-hidden="true" href="#prometheus">#</a></h2>
<p>I&rsquo;m going to deploy <a href="https://prometheus.io">Prometheus</a>. Prometheus is a monitoring tool which sits inside your cluster and gathers data about running pods, nodes, services, whatever you expose and wants to send data to it. It can also alert on things and can be integrated with tools like Graphana for nice front-end and metrics. Prometheus itself uses PromQL as its query language to gather data from different sources and do time series analytics and much much more.</p>
<p>Please visit the website and documentation for more details. It&rsquo;s the defacto monitoring tool for Kubernetes. Again, I&rsquo;m going to do a very basic installation of Prometheus. So basic in fact, that I don&rsquo;t even have a PVC for it, because I don&rsquo;t care at this point about retaining data.</p>
<h3 id="namespace">Namespace<a hidden class="anchor" aria-hidden="true" href="#namespace">#</a></h3>
<p>Let&rsquo;s create it&rsquo;s own namespace.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Namespace</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">monitoring</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">monitoring</span>
</span></span></code></pre></div><h3 id="config">Config<a hidden class="anchor" aria-hidden="true" href="#config">#</a></h3>
<p>Prometheus Server config is massive. I don&rsquo;t expect you to pick up on everything in this thing, but I would encourage you to at least try to find out what these setting do&hellip; Our config yaml file contains the configuration file for Prometheus which we&rsquo;ll later set up via a command line argument. It&rsquo;s called <code>prometheus.yml</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ConfigMap</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">prometheus-server-conf</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">prometheus-server-conf</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">monitoring</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">data</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">prometheus.yml</span>: |-<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    global:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      scrape_interval: 5s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      evaluation_interval: 5s
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    scrape_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - job_name: &#39;kubernetes-apiservers&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        kubernetes_sd_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - role: endpoints
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        scheme: https
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        tls_config:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        relabel_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          action: keep
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          regex: default;kubernetes;https
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - job_name: &#39;kubernetes-nodes&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        scheme: https
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        tls_config:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        kubernetes_sd_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - role: node
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        relabel_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - action: labelmap
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          regex: __meta_kubernetes_node_label_(.+)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - target_label: __address__
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          replacement: kubernetes.default.svc:443
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - source_labels: [__meta_kubernetes_node_name]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          regex: (.+)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          target_label: __metrics_path__
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          replacement: /api/v1/nodes/${1}/proxy/metrics
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - job_name: &#39;kubernetes-pods&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        kubernetes_sd_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - role: pod
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        relabel_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          action: keep
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          regex: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          action: replace
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          target_label: __metrics_path__
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          regex: (.+)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          action: replace
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          regex: ([^:]+)(?::\d+)?;(\d+)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          replacement: $1:$2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          target_label: __address__
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - action: labelmap
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          regex: __meta_kubernetes_pod_label_(.+)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - source_labels: [__meta_kubernetes_namespace]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          action: replace
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          target_label: kubernetes_namespace
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - source_labels: [__meta_kubernetes_pod_name]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          action: replace
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          target_label: kubernetes_pod_name
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - job_name: &#39;kubernetes-cadvisor&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        scheme: https
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        tls_config:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        kubernetes_sd_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - role: node
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        relabel_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - action: labelmap
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          regex: __meta_kubernetes_node_label_(.+)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - target_label: __address__
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          replacement: kubernetes.default.svc:443
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - source_labels: [__meta_kubernetes_node_name]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          regex: (.+)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          target_label: __metrics_path__
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          replacement: /api/v1/nodes/${1}/proxy/metrics/cadvisor
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - job_name: &#39;kubernetes-service-endpoints&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        kubernetes_sd_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - role: endpoints
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        relabel_configs:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          action: keep
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          regex: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scheme]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          action: replace
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          target_label: __scheme__
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          regex: (https?)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          action: replace
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          target_label: __metrics_path__
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          regex: (.+)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          action: replace
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          target_label: __address__
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          regex: ([^:]+)(?::\d+)?;(\d+)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          replacement: $1:$2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - action: labelmap
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          regex: __meta_kubernetes_service_label_(.+)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - source_labels: [__meta_kubernetes_namespace]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          action: replace
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          target_label: kubernetes_namespace
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        - source_labels: [__meta_kubernetes_service_name]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          action: replace
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          target_label: kubernetes_name</span>    
</span></span></code></pre></div><p>Mostly it&rsquo;s just setting up what Prometheus should monitor and how. The important bits are the <code>labels</code>. How this is going to work is, that we will <code>annotate</code> the resources we want Prometheus to see. Which is pretty cool. Basically we will just alter a pod to include an annotation and it will begin monitoring it. No need to install anything anywhere or restart anything. Just add an annotation and bamm, you&rsquo;re done.</p>
<h2 id="rbac">RBAC<a hidden class="anchor" aria-hidden="true" href="#rbac">#</a></h2>
<p>Prometheus needs permissions to access resources in the cluster such as API end-points and gathering data about the cluster itself. We will provide it with this permission through <a href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/">Role Based Access Control</a>.</p>
<p>We&rsquo;ll create a service account which Prometheus can use. We want it to access the whole cluster so we&rsquo;ll use a <code>ClusterRole</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRole</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">prometheus</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">apiGroups</span>: [<span style="color:#e6db74">&#34;&#34;</span>]
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">nodes</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">nodes/proxy</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">services</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">endpoints</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">pods</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">verbs</span>: [<span style="color:#e6db74">&#34;get&#34;</span>, <span style="color:#e6db74">&#34;list&#34;</span>, <span style="color:#e6db74">&#34;watch&#34;</span>]
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">apiGroups</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">extensions</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">ingresses</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">verbs</span>: [<span style="color:#e6db74">&#34;get&#34;</span>, <span style="color:#e6db74">&#34;list&#34;</span>, <span style="color:#e6db74">&#34;watch&#34;</span>]
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">nonResourceURLs</span>: [<span style="color:#e6db74">&#34;/metrics&#34;</span>]
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">verbs</span>: [<span style="color:#e6db74">&#34;get&#34;</span>]
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRoleBinding</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">prometheus</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">roleRef</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRole</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">prometheus</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">subjects</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ServiceAccount</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">monitoring</span>
</span></span></code></pre></div><p>This will give access to monitor the following resources: nodes, nodes/proxy, services, endpoints and pods. The action are get, list, watch. No modifications.</p>
<p>We&rsquo;ll also allow Prometheus to watch ingresses for data traffic and allow it to do get requests to non-resource endpoint <code>/metrics</code>.</p>
<h2 id="deployment-1">Deployment<a hidden class="anchor" aria-hidden="true" href="#deployment-1">#</a></h2>
<p>Now, the deployment is actually pretty easy.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">extensions/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">prometheus-deployment</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">monitoring</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">prometheus-server</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">prometheus</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">image</span>: <span style="color:#ae81ff">prom/prometheus:v2.2.1</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">args</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#e6db74">&#34;--config.file=/etc/prometheus/prometheus.yml&#34;</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#e6db74">&#34;--storage.tsdb.path=/prometheus/&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">9090</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">prometheus-config-volume</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/etc/prometheus/</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">prometheus-storage-volume</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/prometheus/</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">prometheus-config-volume</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">configMap</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">defaultMode</span>: <span style="color:#ae81ff">420</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">name</span>: <span style="color:#ae81ff">prometheus-server-conf</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">prometheus-storage-volume</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">emptyDir</span>: {}
</span></span></code></pre></div><p>The two interesting things here are the two arguments. The config file, which we include through the <code>configMap</code> and the storage. Which I&rsquo;m not bind mounting.</p>
<h2 id="service-1">Service<a hidden class="anchor" aria-hidden="true" href="#service-1">#</a></h2>
<p>Let&rsquo;s expose Prometheus. Now, this may come as a surprise if you don&rsquo;t know anything about Prometheus, but this is an in cluster monitoring tool. It&rsquo;s usually not supposed to be accessed directly, but through tools like Graphana or used by tools like Alerting or traefik as a reverse proxy. As such, Prometheus does not support authentication or authorization or user management of any kind. That is usually taken care of by a reverse proxy or other means written about <a href="https://prometheus.io/docs/operating/security/#authentication-authorization-and-encryption">here</a> and <a href="https://prometheus.io/docs/guides/basic-auth/">here</a>.</p>
<p>As such, we can do a number of things. We can expose it as a NodePort service for example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">prometheus-service</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">monitoring</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">prometheus.io/scrape</span>: <span style="color:#e6db74">&#39;true&#39;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">prometheus.io/port</span>:   <span style="color:#e6db74">&#39;9090&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">prometheus-server</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">NodePort</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">9090</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">nodePort</span>: <span style="color:#ae81ff">30000</span>
</span></span></code></pre></div><p>Or we just port forward the pod like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>k port-forward pods/prometheus-deployment-6bf45557bd-qc6t6 9090:9090 -n monitoring
</span></span></code></pre></div><p>And access it by simply opening the url: http://127.0.0.1:9090.</p>
<h2 id="prometheus-1">Prometheus<a hidden class="anchor" aria-hidden="true" href="#prometheus-1">#</a></h2>
<p>Once you open it, you should see something like this, after running a small query:</p>
<p><img loading="lazy" src="/img/hosting/prometheus.png" alt="prometheus.png"  />
</p>
<h2 id="adding-in-resources-to-monitor">Adding in Resources to monitor<a hidden class="anchor" aria-hidden="true" href="#adding-in-resources-to-monitor">#</a></h2>
<p>In order to add a resource to monitor simply insert these annotations:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>  <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">prometheus.io/scrape</span>: <span style="color:#e6db74">&#39;true&#39;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">prometheus.io/port</span>:   <span style="color:#e6db74">&#39;9090&#39;</span>
</span></span></code></pre></div><p>Done.</p>
<h1 id="bonus-round----graphana">Bonus Round &ndash; Graphana<a hidden class="anchor" aria-hidden="true" href="#bonus-round----graphana">#</a></h1>
<p>We deployed Athens and Prometheus to monitor our cluster. We don&rsquo;t have anything before Prometheus that would be fancy, but installing Graphana is actually pretty easy. You can follow the instructions <a href="https://prometheus.io/docs/visualization/grafana/">here</a>.</p>
<p>A very easy way of looking at some nice metrics without worrying about anything like users and such, is running a Graphana instance in docker on your local machine with:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker run -d -p 3000:3000 grafana/grafana
</span></span></code></pre></div><p>&hellip; and while you are forwarding the Prometheus end-point you navigate to your Graphana instance by opening <code>127.0.0.1:3000</code> and install a Prometheus data-point like this:</p>
<p><img loading="lazy" src="/img/hosting/graphana_config.png" alt="graphana config"  />
</p>
<p>After that navigate to a new dashboard and select a simple PromQL metric to see if it&rsquo;s working. You should see something like this:</p>
<p><img loading="lazy" src="/img/hosting/graphana.png" alt="graphana"  />
</p>
<p>Now you can create a new dashboard add a PVC to our Prometheus instance and enjoy all the metrics you can store!</p>
<h1 id="conclusion">Conclusion<a hidden class="anchor" aria-hidden="true" href="#conclusion">#</a></h1>
<p>And this is it folks. Everything is installed and we can monitor things now. If you give Prometheus a PVC you can build some pretty awesome time series graphs too and see how your cluster behaves over time.</p>
<p>Thank you for reading!
Gergely.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="https://skarlso.github.io/2020/02/17/making-spa-refresh-work-with-go-backend/">
    <span class="title">« Prev</span>
    <br>
    <span>How to Make SPA refresh work with a Go backend</span>
  </a>
  <a class="next" href="https://skarlso.github.io/2019/10/10/practical-go-summary/">
    <span class="title">Next »</span>
    <br>
    <span>Summary of Practical Go workshop from Dave Cheney</span>
  </a>
</nav>

  </footer><div id="disqus_thread"></div>
<script type="application/javascript">
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "hannibalDisqus" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="https://skarlso.github.io">Ramblings of a cloud engineer</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
