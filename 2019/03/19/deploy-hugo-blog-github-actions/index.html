<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Deploy a Hugo Blog Github Actions | Ramblings of a cloud engineer</title>
<meta name="keywords" content="">
<meta name="description" content="Intro Hi folks.
Today I thought I show you how you can use Github Actions to deploy a hugo based blog like this one.
Let&rsquo;s dive in.
Actions What are actions? If you read the above linked document they are basically steps performed in containers based on some events that happened with your repository. Events can be such as pushing, creating a PR or creating/closing an issue etc.
We need an even on a push.">
<meta name="author" content="hannibal">
<link rel="canonical" href="https://skarlso.github.io/2019/03/19/deploy-hugo-blog-github-actions/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.3613efbd0b1772781e8f49935e973cae632a7f61471c05b17be155505ccf87b5.css" integrity="sha256-NhPvvQsXcngej0mTXpc8rmMqf2FHHAWxe&#43;FVUFzPh7U=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://skarlso.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://skarlso.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://skarlso.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://skarlso.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://skarlso.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Deploy a Hugo Blog Github Actions" />
<meta property="og:description" content="Intro Hi folks.
Today I thought I show you how you can use Github Actions to deploy a hugo based blog like this one.
Let&rsquo;s dive in.
Actions What are actions? If you read the above linked document they are basically steps performed in containers based on some events that happened with your repository. Events can be such as pushing, creating a PR or creating/closing an issue etc.
We need an even on a push." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://skarlso.github.io/2019/03/19/deploy-hugo-blog-github-actions/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-03-19T22:01:00+01:00" />
<meta property="article:modified_time" content="2019-03-19T22:01:00+01:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Deploy a Hugo Blog Github Actions"/>
<meta name="twitter:description" content="Intro Hi folks.
Today I thought I show you how you can use Github Actions to deploy a hugo based blog like this one.
Let&rsquo;s dive in.
Actions What are actions? If you read the above linked document they are basically steps performed in containers based on some events that happened with your repository. Events can be such as pushing, creating a PR or creating/closing an issue etc.
We need an even on a push."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Posts",
      "item": "https://skarlso.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "Deploy a Hugo Blog Github Actions",
      "item": "https://skarlso.github.io/2019/03/19/deploy-hugo-blog-github-actions/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Deploy a Hugo Blog Github Actions",
  "name": "Deploy a Hugo Blog Github Actions",
  "description": "Intro Hi folks.\nToday I thought I show you how you can use Github Actions to deploy a hugo based blog like this one.\nLet\u0026rsquo;s dive in.\nActions What are actions? If you read the above linked document they are basically steps performed in containers based on some events that happened with your repository. Events can be such as pushing, creating a PR or creating/closing an issue etc.\nWe need an even on a push.",
  "keywords": [
    
  ],
  "articleBody": "Intro Hi folks.\nToday I thought I show you how you can use Github Actions to deploy a hugo based blog like this one.\nLet’s dive in.\nActions What are actions? If you read the above linked document they are basically steps performed in containers based on some events that happened with your repository. Events can be such as pushing, creating a PR or creating/closing an issue etc.\nWe need an even on a push.\nActions is in beta right now so much of the documentation has some gaps but they are fairly okay. I recommend reading through this one carefully: Developer Guide. This describes for example accessing the environment. That is important because we will need to access the generated content from one action in the next action.\nDockerfile Each action requires a Dockerfile which will be used to create a container to run this particular action in. The Dockerfile uses LABELS to mark a container. It is recommended to create an ENTRYPOINT in the Dockerfile that can work with CMDs passed in from the action.\nFor example my pusher container has the ability to push into any repository thanks to using arguments for the entrypoint.sh script.\nWe’ll see that later on.\nBlog actions Let’s look at the two actions in detail which we’ll be using.\nBuilder First, we need to build the blog. This is accomplished pretty much the same as I wrote earlier in the travis blog part but with a little extra information.\nThis is the Dockerfile:\nFROM golang:latest LABEL \"name\"=\"Hugo Builder\" LABEL \"maintainer\"=\"Gergely Brautigam \" LABEL \"version\"=\"0.1.0\" LABEL \"com.github.actions.name\"=\"Go Builder\" LABEL \"com.github.actions.description\"=\"Build a hugo blog\" LABEL \"com.github.actions.icon\"=\"package\" LABEL \"com.github.actions.color\"=\"#E0EBF5\" RUN \\ apt-get update \u0026\u0026 \\ apt-get install -y ca-certificates openssl git \u0026\u0026 \\ update-ca-certificates \u0026\u0026 \\ rm -rf /var/lib/apt RUN go get github.com/gohugoio/hugo COPY entrypoint.sh /entrypoint.sh ENTRYPOINT [\"/entrypoint.sh\"] Pretty simple. The entrypoint script looks like this:\n#!/bin/bash set -e set -x set -o pipefail if [[ -z \"$GITHUB_WORKSPACE\" ]]; then echo \"Set the GITHUB_WORKSPACE env variable.\" exit 1 fi if [[ -z \"$GITHUB_REPOSITORY\" ]]; then echo \"Set the GITHUB_REPOSITORY env variable.\" exit 1 fi root_path=\"$GITHUB_WORKSPACE\" echo \"Root path is: ${root_path}\" blog_path=\"$GITHUB_WORKSPACE/.blog\" echo \"Blog path is: ${blog_path}\" mkdir -p \"$blog_path\" mkdir -p \"$root_path\" cd \"$root_path\" echo \"Preparing to build blog\" hugo --theme hermit echo \"Building is done. Copying over generated files\" cp -R public/* \"$blog_path\"/ echo \"Copy is done.\" exit 0 The interesting parts here are GITHUB_WORKSPACE and GITHUB_REPOSITORY. The workspace is where the repository is located at.\nThis is the place where we will copy our built blog files. Since this is a mount basically on the local build machine the next action which comes along will see the folder .blog. This is how we pass artifacts between actions.\nThis action can be found here: Hugo Blog Builder Action.\nPublisher Once the building finishes successfully we can push it to the new location.\nDockerfile is similar to the one above in every regard. Except for the name and that it doesn’t need Hugo and the command…\nFROM golang:latest LABEL \"name\"=\"Hugo Pusher\" LABEL \"maintainer\"=\"Gergely Brautigam \" LABEL \"version\"=\"0.1.0\" LABEL \"com.github.actions.name\"=\"Go Pusher\" LABEL \"com.github.actions.description\"=\"Push a hugo blog\" LABEL \"com.github.actions.icon\"=\"package\" LABEL \"com.github.actions.color\"=\"#E0EBF5\" RUN \\ apt-get update \u0026\u0026 \\ apt-get install -y ca-certificates openssl git \u0026\u0026 \\ update-ca-certificates \u0026\u0026 \\ rm -rf /var/lib/apt COPY entrypoint.sh /entrypoint.sh ENTRYPOINT [\"/entrypoint.sh\"] CMD [\"Skarlso/skarlso.github.io.git\"] Why do we require the CMD? Let’s take a look at the script.\n#!/bin/bash set -e set -x if [[ -z \"$GITHUB_WORKSPACE\" ]]; then echo \"Set the GITHUB_WORKSPACE env variable.\" exit 1 fi if [[ -z \"$GITHUB_REPOSITORY\" ]]; then echo \"Set the GITHUB_REPOSITORY env variable.\" exit 1 fi setup_git() { repo=$1 git config --global user.email \"bot@github.com\" git config --global user.name \"Github Actions\" git init echo \"Starting to clone blog repository\" git remote add origin https://\"${PUSH_TOKEN}\"@github.com/\"${repo}\" \u003e /dev/null 2\u003e\u00261 git pull origin master echo \"Cloning is done\" ls -l } commit_website_files() { git add . git commit -am \"Github Action Build ${GITHUB_SHA}\" } upload_files() { git push --quiet --set-upstream origin master } echo \"Beginning publishing workflow\" repo=$1 if [ -z \"${repo}\" ]; then echo \"Repo must be defined.\" exit 1 fi echo \"Using repository ${repo} to push to\" mkdir /opt/publish \u0026\u0026 cd /opt/publish blog_path=\"$GITHUB_WORKSPACE/.blog\" echo \"Blog is located at: ${blog_path}\" ls -l \"${blog_path}\" echo \"Setting up git\" setup_git \"${repo}\" cp -R \"${blog_path}\"/* . echo \"Copied over generated content from blog path. Committing.\" commit_website_files echo \"Committed. Pushing.\" upload_files echo \"All done.\" exit 0 Now this is a lot more involved. I’m leaving as many echos in here as possible for esae of debugging.\nThe interesting part in here is the repo=$1. This is why we need CMD specified. But this is what makes this Action a bit more flexible too. It can push anywhere it has access to.\nThis action can be found here: Hugo Blog Publisher Action.\nThe Workflow file How does this all fit together? You have to create a workflow file which looks something like this:\nworkflow \"Publish Blog\" { on = \"push\" resolves = [\"blog-publisher\"] } action \"blog-builder\" { uses = \"skarlso/blog-builder@master\" secrets = [\"GITHUB_TOKEN\"] } action \"blog-publisher\" { uses = \"skarlso/blog-publisher@master\" needs = [\"blog-builder\"] secrets = [\"GITHUB_TOKEN\", \"PUSH_TOKEN\"] } This is located in your repositroy under .github/main.workdflow. Notice the secrets. GITHUB_TOKEN is created for you by Github. This is a basic token which lets you access the github API. But it can’t be used for pushing code. Thus, we need another token. This can be defined under your repository / settings / secrets. Once you have a token, add a new secret called PUSH_TOKEN and… done.\nEverything should be ready to go.\nLocation of the actions Now, I read the doc and should have been possible to have these actions in the repositroy itself. However, I faced some problems with that setup so I ended up having actions in their respectice repository. That’s why uses is set up to be skarlso/@branch.\nConclusion On a push now the blog is built and published. If a step fails it won’t be published. It’s actually a lot faster than my travis build was.\nThank you for reading,\nGergely.\n",
  "wordCount" : "1009",
  "inLanguage": "en",
  "datePublished": "2019-03-19T22:01:00+01:00",
  "dateModified": "2019-03-19T22:01:00+01:00",
  "author":{
    "@type": "Person",
    "name": "hannibal"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://skarlso.github.io/2019/03/19/deploy-hugo-blog-github-actions/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Ramblings of a cloud engineer",
    "logo": {
      "@type": "ImageObject",
      "url": "https://skarlso.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://skarlso.github.io" accesskey="h" title="Ramblings of a cloud engineer (Alt + H)">Ramblings of a cloud engineer</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://skarlso.github.io/posts/" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://skarlso.github.io/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://skarlso.github.io/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      Deploy a Hugo Blog Github Actions
    </h1>
    <div class="post-meta"><span title='2019-03-19 22:01:00 +0100 +0100'>March 19, 2019</span>&nbsp;·&nbsp;hannibal

</div>
  </header> 
  <div class="post-content"><h1 id="intro">Intro<a hidden class="anchor" aria-hidden="true" href="#intro">#</a></h1>
<p>Hi folks.</p>
<p>Today I thought I show you how you can use <a href="https://github.com/features/actions">Github Actions</a> to deploy a hugo based blog like this one.</p>
<p>Let&rsquo;s dive in.</p>
<h1 id="actions">Actions<a hidden class="anchor" aria-hidden="true" href="#actions">#</a></h1>
<p>What are actions? If you read the above linked document they are basically steps performed in containers based on some events that happened with your repository. Events can be such as pushing, creating a PR or creating/closing an issue etc.</p>
<p>We need an even on a push.</p>
<p>Actions is in beta right now so much of the documentation has some gaps but they are fairly okay. I recommend reading through this one carefully: <a href="https://developer.github.com/actions/">Developer Guide</a>. This describes for example accessing the environment. That is important because we will need to access the generated content from one action in the next action.</p>
<h1 id="dockerfile">Dockerfile<a hidden class="anchor" aria-hidden="true" href="#dockerfile">#</a></h1>
<p>Each action requires a Dockerfile which will be used to create a container to run this particular action in. The Dockerfile uses LABELS to mark a container. It is recommended to create an ENTRYPOINT in the Dockerfile that can work with CMDs passed in from the action.</p>
<p>For example my pusher container has the ability to push into any repository thanks to using arguments for the entrypoint.sh script.</p>
<p>We&rsquo;ll see that later on.</p>
<h1 id="blog-actions">Blog actions<a hidden class="anchor" aria-hidden="true" href="#blog-actions">#</a></h1>
<p>Let&rsquo;s look at the two actions in detail which we&rsquo;ll be using.</p>
<h2 id="builder">Builder<a hidden class="anchor" aria-hidden="true" href="#builder">#</a></h2>
<p>First, we need to build the blog. This is accomplished pretty much the same as I wrote earlier in the travis blog part but with a little extra information.</p>
<p>This is the Dockerfile:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Dockerfile" data-lang="Dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> golang:latest</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">LABEL</span> <span style="color:#e6db74">&#34;name&#34;</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Hugo Builder&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">LABEL</span> <span style="color:#e6db74">&#34;maintainer&#34;</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Gergely Brautigam &lt;gergely@gergelybrautigam.com&gt;&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">LABEL</span> <span style="color:#e6db74">&#34;version&#34;</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;0.1.0&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">LABEL</span> <span style="color:#e6db74">&#34;com.github.actions.name&#34;</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Go Builder&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">LABEL</span> <span style="color:#e6db74">&#34;com.github.actions.description&#34;</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Build a hugo blog&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">LABEL</span> <span style="color:#e6db74">&#34;com.github.actions.icon&#34;</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;package&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">LABEL</span> <span style="color:#e6db74">&#34;com.github.actions.color&#34;</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;#E0EBF5&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  apt-get update <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  apt-get install -y ca-certificates openssl git <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  update-ca-certificates <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  rm -rf /var/lib/apt<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> go get github.com/gohugoio/hugo<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> entrypoint.sh /entrypoint.sh<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENTRYPOINT</span> [<span style="color:#e6db74">&#34;/entrypoint.sh&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>Pretty simple. The entrypoint script looks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>set -e
</span></span><span style="display:flex;"><span>set -x
</span></span><span style="display:flex;"><span>set -o pipefail
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> -z <span style="color:#e6db74">&#34;</span>$GITHUB_WORKSPACE<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>  echo <span style="color:#e6db74">&#34;Set the GITHUB_WORKSPACE env variable.&#34;</span>
</span></span><span style="display:flex;"><span>  exit <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> -z <span style="color:#e6db74">&#34;</span>$GITHUB_REPOSITORY<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>  echo <span style="color:#e6db74">&#34;Set the GITHUB_REPOSITORY env variable.&#34;</span>
</span></span><span style="display:flex;"><span>  exit <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>root_path<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$GITHUB_WORKSPACE<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;Root path is: </span><span style="color:#e6db74">${</span>root_path<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>blog_path<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$GITHUB_WORKSPACE<span style="color:#e6db74">/.blog&#34;</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;Blog path is: </span><span style="color:#e6db74">${</span>blog_path<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>mkdir -p <span style="color:#e6db74">&#34;</span>$blog_path<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>mkdir -p <span style="color:#e6db74">&#34;</span>$root_path<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>cd <span style="color:#e6db74">&#34;</span>$root_path<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;Preparing to build blog&#34;</span>
</span></span><span style="display:flex;"><span>hugo --theme hermit
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;Building is done. Copying over generated files&#34;</span>
</span></span><span style="display:flex;"><span>cp -R public/* <span style="color:#e6db74">&#34;</span>$blog_path<span style="color:#e6db74">&#34;</span>/
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;Copy is done.&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>exit <span style="color:#ae81ff">0</span>
</span></span></code></pre></div><p>The interesting parts here are <code>GITHUB_WORKSPACE</code> and <code>GITHUB_REPOSITORY</code>. The workspace is where the repository is located at.</p>
<p>This is the place where we will copy our built blog files. Since this is a mount basically on the local build machine the next action which comes along will see the folder <code>.blog</code>. This is how we pass artifacts between actions.</p>
<p>This action can be found here: <a href="https://github.com/Skarlso/blog-builder">Hugo Blog Builder Action</a>.</p>
<h2 id="publisher">Publisher<a hidden class="anchor" aria-hidden="true" href="#publisher">#</a></h2>
<p>Once the building finishes successfully we can push it to the new location.</p>
<p>Dockerfile is similar to the one above in every regard. Except for the name and that it doesn&rsquo;t need Hugo and the command&hellip;</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Dockerfile" data-lang="Dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> golang:latest</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">LABEL</span> <span style="color:#e6db74">&#34;name&#34;</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Hugo Pusher&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">LABEL</span> <span style="color:#e6db74">&#34;maintainer&#34;</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Gergely Brautigam &lt;gergely@gergelybrautigam.com&gt;&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">LABEL</span> <span style="color:#e6db74">&#34;version&#34;</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;0.1.0&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">LABEL</span> <span style="color:#e6db74">&#34;com.github.actions.name&#34;</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Go Pusher&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">LABEL</span> <span style="color:#e6db74">&#34;com.github.actions.description&#34;</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Push a hugo blog&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">LABEL</span> <span style="color:#e6db74">&#34;com.github.actions.icon&#34;</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;package&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">LABEL</span> <span style="color:#e6db74">&#34;com.github.actions.color&#34;</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;#E0EBF5&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  apt-get update <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  apt-get install -y ca-certificates openssl git <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  update-ca-certificates <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  rm -rf /var/lib/apt<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> entrypoint.sh /entrypoint.sh<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENTRYPOINT</span> [<span style="color:#e6db74">&#34;/entrypoint.sh&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">CMD</span> [<span style="color:#e6db74">&#34;Skarlso/skarlso.github.io.git&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>Why do we require the CMD? Let&rsquo;s take a look at the script.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>set -e
</span></span><span style="display:flex;"><span>set -x
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> -z <span style="color:#e6db74">&#34;</span>$GITHUB_WORKSPACE<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>  echo <span style="color:#e6db74">&#34;Set the GITHUB_WORKSPACE env variable.&#34;</span>
</span></span><span style="display:flex;"><span>  exit <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> -z <span style="color:#e6db74">&#34;</span>$GITHUB_REPOSITORY<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>  echo <span style="color:#e6db74">&#34;Set the GITHUB_REPOSITORY env variable.&#34;</span>
</span></span><span style="display:flex;"><span>  exit <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>setup_git<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  repo<span style="color:#f92672">=</span>$1
</span></span><span style="display:flex;"><span>  git config --global user.email <span style="color:#e6db74">&#34;bot@github.com&#34;</span>
</span></span><span style="display:flex;"><span>  git config --global user.name <span style="color:#e6db74">&#34;Github Actions&#34;</span>
</span></span><span style="display:flex;"><span>  git init
</span></span><span style="display:flex;"><span>  echo <span style="color:#e6db74">&#34;Starting to clone blog repository&#34;</span>
</span></span><span style="display:flex;"><span>  git remote add origin https://<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>PUSH_TOKEN<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>@github.com/<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>repo<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> &gt; /dev/null 2&gt;&amp;<span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  git pull origin master
</span></span><span style="display:flex;"><span>  echo <span style="color:#e6db74">&#34;Cloning is done&#34;</span>
</span></span><span style="display:flex;"><span>  ls -l
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>commit_website_files<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  git add .
</span></span><span style="display:flex;"><span>  git commit -am <span style="color:#e6db74">&#34;Github Action Build </span><span style="color:#e6db74">${</span>GITHUB_SHA<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>upload_files<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  git push --quiet --set-upstream origin master
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;Beginning publishing workflow&#34;</span>
</span></span><span style="display:flex;"><span>repo<span style="color:#f92672">=</span>$1
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -z <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>repo<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>    echo <span style="color:#e6db74">&#34;Repo must be defined.&#34;</span>
</span></span><span style="display:flex;"><span>    exit <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;Using repository </span><span style="color:#e6db74">${</span>repo<span style="color:#e6db74">}</span><span style="color:#e6db74"> to push to&#34;</span>
</span></span><span style="display:flex;"><span>mkdir /opt/publish <span style="color:#f92672">&amp;&amp;</span> cd /opt/publish
</span></span><span style="display:flex;"><span>blog_path<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$GITHUB_WORKSPACE<span style="color:#e6db74">/.blog&#34;</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;Blog is located at: </span><span style="color:#e6db74">${</span>blog_path<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>ls -l <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>blog_path<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;Setting up git&#34;</span>
</span></span><span style="display:flex;"><span>setup_git <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>repo<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>cp -R <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>blog_path<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>/* .
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;Copied over generated content from blog path. Committing.&#34;</span>
</span></span><span style="display:flex;"><span>commit_website_files
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;Committed. Pushing.&#34;</span>
</span></span><span style="display:flex;"><span>upload_files
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;All done.&#34;</span>
</span></span><span style="display:flex;"><span>exit <span style="color:#ae81ff">0</span>
</span></span></code></pre></div><p>Now this is a lot more involved. I&rsquo;m leaving as many echos in here as possible for esae of debugging.</p>
<p>The interesting part in here is the <code>repo=$1</code>. This is why we need CMD specified. But this is what makes this Action a bit more flexible too. It can push anywhere it has access to.</p>
<p>This action can be found here: <a href="https://github.com/Skarlso/blog-publisher">Hugo Blog Publisher Action</a>.</p>
<h2 id="the-workflow-file">The Workflow file<a hidden class="anchor" aria-hidden="true" href="#the-workflow-file">#</a></h2>
<p>How does this all fit together? You have to create a workflow file which looks something like this:</p>
<pre tabindex="0"><code>workflow &#34;Publish Blog&#34; {
  on = &#34;push&#34;
  resolves = [&#34;blog-publisher&#34;]
}

action &#34;blog-builder&#34; {
  uses = &#34;skarlso/blog-builder@master&#34;
  secrets = [&#34;GITHUB_TOKEN&#34;]
}

action &#34;blog-publisher&#34; {
  uses = &#34;skarlso/blog-publisher@master&#34;
  needs = [&#34;blog-builder&#34;]
  secrets = [&#34;GITHUB_TOKEN&#34;, &#34;PUSH_TOKEN&#34;]
}
</code></pre><p>This is located in your repositroy under <code>.github/main.workdflow</code>. Notice the secrets. GITHUB_TOKEN is created for you by Github. This is a basic token which lets you access the github API. But it can&rsquo;t be used for pushing code. Thus, we need another token. This can be defined under your repository / settings / secrets. Once you have a token, add a new secret called PUSH_TOKEN and&hellip; done.</p>
<p>Everything should be ready to go.</p>
<h2 id="location-of-the-actions">Location of the actions<a hidden class="anchor" aria-hidden="true" href="#location-of-the-actions">#</a></h2>
<p>Now, I read the doc and should have been possible to have these actions in the repositroy itself. However, I faced some problems with that setup so I ended up having actions in their respectice repository. That&rsquo;s why <code>uses</code> is set up to be <code>skarlso/&lt;action-name&gt;@branch</code>.</p>
<h1 id="conclusion">Conclusion<a hidden class="anchor" aria-hidden="true" href="#conclusion">#</a></h1>
<p>On a push now the blog is built and published. If a step fails it won&rsquo;t be published. It&rsquo;s actually a lot faster than my travis build was.</p>
<p>Thank you for reading,</p>
<p>Gergely.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer><div id="disqus_thread"></div>
<script type="application/javascript">
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "hannibalDisqus" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="https://skarlso.github.io">Ramblings of a cloud engineer</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
