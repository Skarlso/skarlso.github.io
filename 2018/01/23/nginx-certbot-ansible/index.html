<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Ansible &#43; Nginx &#43; LetsEncrypt &#43; Wiki &#43; Nagios | Ramblings of a cloud engineer</title>
<meta name="keywords" content="">
<meta name="description" content="Intro Hi folks.
Today, I would like demonstrate how to use Ansible in order to construct a server hosting multiple HTTPS domains with Nginx and LetsEncrypt. Are you ready? Let&rsquo;s dive in.
TL;DR What you will need There is really only one thing you need in order for this to work and that is Ansible. If you would like to run local tests without a remote server, than you will need Vagrant and VirtualBox.">
<meta name="author" content="hannibal">
<link rel="canonical" href="https://skarlso.github.io/2018/01/23/nginx-certbot-ansible/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.3613efbd0b1772781e8f49935e973cae632a7f61471c05b17be155505ccf87b5.css" integrity="sha256-NhPvvQsXcngej0mTXpc8rmMqf2FHHAWxe&#43;FVUFzPh7U=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://skarlso.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://skarlso.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://skarlso.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://skarlso.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://skarlso.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Ansible &#43; Nginx &#43; LetsEncrypt &#43; Wiki &#43; Nagios" />
<meta property="og:description" content="Intro Hi folks.
Today, I would like demonstrate how to use Ansible in order to construct a server hosting multiple HTTPS domains with Nginx and LetsEncrypt. Are you ready? Let&rsquo;s dive in.
TL;DR What you will need There is really only one thing you need in order for this to work and that is Ansible. If you would like to run local tests without a remote server, than you will need Vagrant and VirtualBox." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://skarlso.github.io/2018/01/23/nginx-certbot-ansible/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-01-23T22:34:00+01:00" />
<meta property="article:modified_time" content="2018-01-23T22:34:00+01:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Ansible &#43; Nginx &#43; LetsEncrypt &#43; Wiki &#43; Nagios"/>
<meta name="twitter:description" content="Intro Hi folks.
Today, I would like demonstrate how to use Ansible in order to construct a server hosting multiple HTTPS domains with Nginx and LetsEncrypt. Are you ready? Let&rsquo;s dive in.
TL;DR What you will need There is really only one thing you need in order for this to work and that is Ansible. If you would like to run local tests without a remote server, than you will need Vagrant and VirtualBox."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Posts",
      "item": "https://skarlso.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "Ansible + Nginx + LetsEncrypt + Wiki + Nagios",
      "item": "https://skarlso.github.io/2018/01/23/nginx-certbot-ansible/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Ansible + Nginx + LetsEncrypt + Wiki + Nagios",
  "name": "Ansible \u002b Nginx \u002b LetsEncrypt \u002b Wiki \u002b Nagios",
  "description": "Intro Hi folks.\nToday, I would like demonstrate how to use Ansible in order to construct a server hosting multiple HTTPS domains with Nginx and LetsEncrypt. Are you ready? Let\u0026rsquo;s dive in.\nTL;DR What you will need There is really only one thing you need in order for this to work and that is Ansible. If you would like to run local tests without a remote server, than you will need Vagrant and VirtualBox.",
  "keywords": [
    
  ],
  "articleBody": "Intro Hi folks.\nToday, I would like demonstrate how to use Ansible in order to construct a server hosting multiple HTTPS domains with Nginx and LetsEncrypt. Are you ready? Let’s dive in.\nTL;DR What you will need There is really only one thing you need in order for this to work and that is Ansible. If you would like to run local tests without a remote server, than you will need Vagrant and VirtualBox. But those two are optional.\nWhat We Are Going To Set Up The setup is as follows:\nNagios We are going to have a Nagios with a custom check for pending security updates. That will run under nagios.example.com.\nHugo Website The main web site is going to be a basic Hugo site. Hugo is a static Go based web site generator. This Blog is run by it.\nWe are also going to setup NoIP which will provide the DNS for the sites.\nWiki The wiki is a plain, basic DokuWiki.\nHTTPS + Nginx And all the above will be hosted by Nginx with HTTPS provided by letsencrypt. We are going to set all these up with Ansible on top so it will be idempotent.\nRepository All of the playbooks and the whole thing together can be viewed here: Github Ansible Server Setup.\nAnsible I won’t be writing everything down to the basics about Ansible. For that you will need to go and read its documentation. But I will provide ample of clarification for using what I’ll be using.\nSome Basics Ansible is a configuration management tool which, unlike chef or puppet, isn’t master - slave based. It’s using SSH to run a set of instructions on a target machine. The instructions are written in yaml files and look something like this:\n--- # tasks file for ssh - name: Copy sshd_config copy: content=\"{{sshd_config}}\" dest=/etc/ssh/sshd_config notify: - SSHD Restart This is a basic Task which copies over an sshd_config file overwriting the one already being there. It can execute in priviliged mode if root password is provided or the user has sudo rights.\nIt works from so called hosts files where the server details are described. This is how a basic host file would look like:\n[local] 127.0.0.1 [webserver1] 1.23.4.5 Ansible will use these settings to try and access the server. To test if the connection is working, you can send a ping task like this:\nansible all -m ping Ansible uses variables for things that change. They are defined under each task’s subfolder called vars. Please feel free to change the varialbes there to your liking.\nSSH Access You can either define SSH information per host or per group or globally. In this example I have it under the groups wars called webserver1 like this (vars.yaml):\n--- # SSH sudo keys and pass ansible_become_pass: '{{vault_ansible_become_pass}}' ansible_ssh_port: '{{vault_ansible_ssh_port}}' ansible_ssh_user: '{{vault_ansible_ssh_user}}' ansible_ssh_private_key_file: '{{vault_ansible_ssh_private_key_file}}' home_dir: /root Further reading Further readings are:\nServers For Hackers Ansible docs Vault The vault is the place where we can keep secure information. This file is called vault and usually lives under either group_vars or host_vars. The preference is up to you.\nThis file is encrypted using a password you specify. You can have the vault password stored in the following ways:\nStore it on a secure drive which is encrypted and only mounted when the playbook is executed Store it on Keybase Store it on an encrypted S3 bucket Store it in a file next to the playbook which is never commited into source control Either way, in the end, ansible will look for a file called .vault_password for when it’s trying to decrypt the file. You can define a different file in the ansible.cfg file using the vault_password_file option.\nYou can create a vault like this:\nansible-vault create vault If you are following along, you are going to need these variables in the vault:\nvault_ansible_become_pass: # if applicable vault_ansible_ssh_user: vault_ansible_ssh_private_key_file: /Users/user/.ssh/ida_rsa vault_nagios_password: supersecurenagiosadminpassword vault_nagios_username: nagiosadmin vault_noip_username: youruser@gmail.com vault_noip_password: \"SuperSecureNoIPPassword\" vault_nginx_user: You can always edit the vault later on with:\nansible-vault edit group_vars/webserver1/vault --vault-password-file=.vault_pass Tasks The following are a collection of tasks which execute in order. The end task, which is letsencrypt, relies on all the hosts being present and configured under Nginx. Otherwise it will throw an error that the host you are trying to configure HTTPS for, isn’t defined.\nNo-IP I’m choosing No-ip as a DNS provider because it’s cheap and the sync tool is easy to automate. To automate the CLI of No-IP, I’m using a package called expect. This looks something like this:\ncd {{home_dir}} wget http://www.no-ip.com/client/linux/noip-duc-linux.tar.gz mkdir -p noip tar zxf noip-duc-linux.tar.gz -C noip cd noip/* make /usr/bin/expect \u003c",
  "wordCount" : "2160",
  "inLanguage": "en",
  "datePublished": "2018-01-23T22:34:00+01:00",
  "dateModified": "2018-01-23T22:34:00+01:00",
  "author":{
    "@type": "Person",
    "name": "hannibal"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://skarlso.github.io/2018/01/23/nginx-certbot-ansible/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Ramblings of a cloud engineer",
    "logo": {
      "@type": "ImageObject",
      "url": "https://skarlso.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://skarlso.github.io" accesskey="h" title="Ramblings of a cloud engineer (Alt + H)">Ramblings of a cloud engineer</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://skarlso.github.io/archives" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://skarlso.github.io/search/" title="Search">
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://skarlso.github.io/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://skarlso.github.io/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://skarlso.github.io">Home</a>&nbsp;»&nbsp;<a href="https://skarlso.github.io/posts/">Posts</a></div>
    <h1 class="post-title">
      Ansible &#43; Nginx &#43; LetsEncrypt &#43; Wiki &#43; Nagios
    </h1>
    <div class="post-meta"><span title='2018-01-23 22:34:00 +0100 +0100'>January 23, 2018</span>&nbsp;·&nbsp;11 min&nbsp;·&nbsp;hannibal

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#intro" aria-label="Intro">Intro</a><ul>
                        
                <li>
                    <a href="#tldr" aria-label="TL;DR">TL;DR</a></li>
                <li>
                    <a href="#what-you-will-need" aria-label="What you will need">What you will need</a></li>
                <li>
                    <a href="#what-we-are-going-to-set-up" aria-label="What We Are Going To Set Up">What We Are Going To Set Up</a><ul>
                        
                <li>
                    <a href="#nagios" aria-label="Nagios">Nagios</a></li>
                <li>
                    <a href="#hugo-website" aria-label="Hugo Website">Hugo Website</a></li>
                <li>
                    <a href="#wiki" aria-label="Wiki">Wiki</a></li>
                <li>
                    <a href="#https--nginx" aria-label="HTTPS &#43; Nginx">HTTPS + Nginx</a></li>
                <li>
                    <a href="#repository" aria-label="Repository">Repository</a></li></ul>
                </li>
                <li>
                    <a href="#ansible" aria-label="Ansible">Ansible</a><ul>
                        
                <li>
                    <a href="#some-basics" aria-label="Some Basics">Some Basics</a></li>
                <li>
                    <a href="#ssh-access" aria-label="SSH Access">SSH Access</a></li>
                <li>
                    <a href="#further-reading" aria-label="Further reading">Further reading</a></li>
                <li>
                    <a href="#vault" aria-label="Vault">Vault</a></li>
                <li>
                    <a href="#tasks" aria-label="Tasks">Tasks</a><ul>
                        
                <li>
                    <a href="#no-ip" aria-label="No-IP">No-IP</a></li>
                <li>
                    <a href="#to-util-or-not-to-util" aria-label="To Util or Not To Util">To Util or Not To Util</a></li>
                <li>
                    <a href="#nagios-1" aria-label="Nagios">Nagios</a></li>
                <li>
                    <a href="#hugo" aria-label="Hugo">Hugo</a></li>
                <li>
                    <a href="#wiki-1" aria-label="Wiki">Wiki</a></li>
                <li>
                    <a href="#nginx" aria-label="Nginx">Nginx</a></li>
                <li>
                    <a href="#letsencrypt" aria-label="LetsEncrypt">LetsEncrypt</a></li></ul>
                </li>
                <li>
                    <a href="#test-run-using-vagrant" aria-label="Test Run using Vagrant">Test Run using Vagrant</a></li></ul>
                </li>
                <li>
                    <a href="#room-for-improvement" aria-label="Room for improvement">Room for improvement</a><ul>
                        
                <li>
                    <a href="#tests-and-checks" aria-label="Tests and Checks">Tests and Checks</a></li>
                <li>
                    <a href="#multiple-domains" aria-label="Multiple Domains">Multiple Domains</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#conclusion" aria-label="Conclusion">Conclusion</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="intro">Intro<a hidden class="anchor" aria-hidden="true" href="#intro">#</a></h1>
<p>Hi folks.</p>
<p>Today, I would like demonstrate how to use <a href="https://www.ansible.com/">Ansible</a> in order to construct a server hosting multiple HTTPS domains with <a href="https://www.nginx.com/">Nginx</a> and <a href="https://letsencrypt.org/">LetsEncrypt</a>. Are you ready? Let&rsquo;s dive in.</p>
<h2 id="tldr">TL;DR<a hidden class="anchor" aria-hidden="true" href="#tldr">#</a></h2>
<p><img loading="lazy" src="/img/ansible.svg" alt="playbook"  />
</p>
<h2 id="what-you-will-need">What you will need<a hidden class="anchor" aria-hidden="true" href="#what-you-will-need">#</a></h2>
<p>There is really only one thing you need in order for this to work and that is Ansible. If you would like to run local tests without a remote server, than you will need <a href="https://www.vagrantup.com/">Vagrant</a> and <a href="https://www.virtualbox.org/wiki/Downloads">VirtualBox</a>. But those two are optional.</p>
<h2 id="what-we-are-going-to-set-up">What We Are Going To Set Up<a hidden class="anchor" aria-hidden="true" href="#what-we-are-going-to-set-up">#</a></h2>
<p>The setup is as follows:</p>
<h3 id="nagios">Nagios<a hidden class="anchor" aria-hidden="true" href="#nagios">#</a></h3>
<p>We are going to have a Nagios with a custom check for pending security updates. That will run under nagios.example.com.</p>
<h3 id="hugo-website">Hugo Website<a hidden class="anchor" aria-hidden="true" href="#hugo-website">#</a></h3>
<p>The main web site is going to be a basic <a href="https://gohugo.io/">Hugo</a> site. Hugo is a static Go based web site generator. This Blog is run by it.</p>
<p>We are also going to setup <a href="https://www.noip.com/">NoIP</a> which will provide the DNS for the sites.</p>
<h3 id="wiki">Wiki<a hidden class="anchor" aria-hidden="true" href="#wiki">#</a></h3>
<p>The wiki is a plain, basic <a href="https://www.dokuwiki.org/dokuwiki#">DokuWiki</a>.</p>
<h3 id="https--nginx">HTTPS + Nginx<a hidden class="anchor" aria-hidden="true" href="#https--nginx">#</a></h3>
<p>And all the above will be hosted by Nginx with HTTPS provided by letsencrypt. We are going to set all these up with Ansible on top so it will be idempotent.</p>
<h3 id="repository">Repository<a hidden class="anchor" aria-hidden="true" href="#repository">#</a></h3>
<p>All of the playbooks and the whole thing together can be viewed here: <a href="https://github.com/Skarlso/ansible-server-setup">Github Ansible Server Setup</a>.</p>
<h2 id="ansible">Ansible<a hidden class="anchor" aria-hidden="true" href="#ansible">#</a></h2>
<p>I won&rsquo;t be writing everything down to the basics about Ansible. For that you will need to go and read its documentation. But I will provide ample of clarification for using what I&rsquo;ll be using.</p>
<h3 id="some-basics">Some Basics<a hidden class="anchor" aria-hidden="true" href="#some-basics">#</a></h3>
<p>Ansible is a configuration management tool which, unlike chef or puppet, isn&rsquo;t master - slave based. It&rsquo;s using SSH to run a set of instructions on a target machine. The instructions are written in yaml files and look something like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#75715e"># tasks file for ssh</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Copy sshd_config</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">copy</span>: <span style="color:#ae81ff">content=&#34;{{sshd_config}}&#34; dest=/etc/ssh/sshd_config</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">notify</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">SSHD Restart</span>
</span></span></code></pre></div><p>This is a basic Task which copies over an <code>sshd_config</code> file overwriting the one already being there. It can execute in priviliged mode if root password is provided or the user has sudo rights.</p>
<p>It works from so called <code>hosts</code> files where the server details are described. This is how a basic host file would look like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>local<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>127.0.0.1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>webserver1<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>1.23.4.5
</span></span></code></pre></div><p>Ansible will use these settings to try and access the server. To test if the connection is working, you can send a <code>ping</code> task like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ansible all -m ping
</span></span></code></pre></div><p>Ansible uses <code>variables</code> for things that change. They are defined under each task&rsquo;s subfolder called <code>vars</code>. Please feel free to change the varialbes there to your liking.</p>
<h3 id="ssh-access">SSH Access<a hidden class="anchor" aria-hidden="true" href="#ssh-access">#</a></h3>
<p>You can either define SSH information per host or per group or globally. In this example I have it under the groups wars called
<code>webserver1</code> like this (vars.yaml):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#75715e"># SSH sudo keys and pass</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">ansible_become_pass</span>: <span style="color:#e6db74">&#39;{{vault_ansible_become_pass}}&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">ansible_ssh_port</span>: <span style="color:#e6db74">&#39;{{vault_ansible_ssh_port}}&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">ansible_ssh_user</span>: <span style="color:#e6db74">&#39;{{vault_ansible_ssh_user}}&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">ansible_ssh_private_key_file</span>: <span style="color:#e6db74">&#39;{{vault_ansible_ssh_private_key_file}}&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">home_dir</span>: <span style="color:#ae81ff">/root</span>
</span></span></code></pre></div><h3 id="further-reading">Further reading<a hidden class="anchor" aria-hidden="true" href="#further-reading">#</a></h3>
<p>Further readings are:</p>
<ul>
<li><a href="https://serversforhackers.com/c/an-ansible-tutorial">Servers For Hackers</a></li>
<li><a href="http://docs.ansible.com/ansible/latest/intro_getting_started.html">Ansible docs</a></li>
</ul>
<h3 id="vault">Vault<a hidden class="anchor" aria-hidden="true" href="#vault">#</a></h3>
<p>The vault is the place where we can keep secure information. This file is called <code>vault</code> and usually lives under either <code>group_vars</code> or <code>host_vars</code>. The preference is up to you.</p>
<p>This file is encrypted using a password you specify. You can have the vault password stored in the following ways:</p>
<ul>
<li>Store it on a secure drive which is encrypted and only mounted when the playbook is executed</li>
<li>Store it on <a href="https://keybase.io">Keybase</a></li>
<li>Store it on an encrypted S3 bucket</li>
<li>Store it in a file next to the playbook which is never commited into source control</li>
</ul>
<p>Either way, in the end, ansible will look for a file called <code>.vault_password</code> for when it&rsquo;s trying to decrypt the file. You can
define a different file in the <code>ansible.cfg</code> file using the <code>vault_password_file</code> option.</p>
<p>You can create a vault like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ansible-vault create vault
</span></span></code></pre></div><p>If you are following along, you are going to need these variables in the vault:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">vault_ansible_become_pass</span>: <span style="color:#ae81ff">&lt;your_sudo_password&gt;</span> <span style="color:#75715e"># if applicable</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">vault_ansible_ssh_user</span>: <span style="color:#ae81ff">&lt;ssh_user&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">vault_ansible_ssh_private_key_file</span>: <span style="color:#ae81ff">/Users/user/.ssh/ida_rsa</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">vault_nagios_password</span>: <span style="color:#ae81ff">supersecurenagiosadminpassword</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">vault_nagios_username</span>: <span style="color:#ae81ff">nagiosadmin</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">vault_noip_username</span>: <span style="color:#ae81ff">youruser@gmail.com</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">vault_noip_password</span>: <span style="color:#e6db74">&#34;SuperSecureNoIPPassword&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">vault_nginx_user</span>: <span style="color:#ae81ff">&lt;localuser&gt;</span>
</span></span></code></pre></div><p>You can always edit the vault later on with:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ansible-vault edit group_vars/webserver1/vault --vault-password-file<span style="color:#f92672">=</span>.vault_pass
</span></span></code></pre></div><h3 id="tasks">Tasks<a hidden class="anchor" aria-hidden="true" href="#tasks">#</a></h3>
<p>The following are a collection of tasks which execute in order. The end task, which is letsencrypt, relies on all the hosts being present and configured under Nginx. Otherwise it will throw an error that the host you are trying to configure HTTPS for, isn&rsquo;t defined.</p>
<h4 id="no-ip">No-IP<a hidden class="anchor" aria-hidden="true" href="#no-ip">#</a></h4>
<p>I&rsquo;m choosing No-ip as a DNS provider because it&rsquo;s cheap and the sync tool is easy to automate. To automate the CLI of No-IP, I&rsquo;m using a package called <code>expect</code>. This looks something like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cd <span style="color:#f92672">{{</span>home_dir<span style="color:#f92672">}}</span>
</span></span><span style="display:flex;"><span>wget http://www.no-ip.com/client/linux/noip-duc-linux.tar.gz
</span></span><span style="display:flex;"><span>mkdir -p noip
</span></span><span style="display:flex;"><span>tar zxf noip-duc-linux.tar.gz -C noip
</span></span><span style="display:flex;"><span>cd noip/*
</span></span><span style="display:flex;"><span>make
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/usr/bin/expect <span style="color:#e6db74">&lt;&lt;END_SCRIPT
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spawn make install
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">expect &#34;Please enter the login/email*&#34; { send &#34;{{noip_username}}\r&#34; }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">expect &#34;Please enter the password for user*&#34; { send &#34;{{noip_password}}\r&#34; }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">expect {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;Do you wish to have them all updated*&#34; {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        send &#34;y&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        exp_continue
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">expect &#34;Please enter an update interval*&#34; { send &#34;30\r&#34; }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">expect &#34;Do you wish to run something at successful update*&#34; {send &#34;N&#34; }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">END_SCRIPT</span>
</span></span></code></pre></div><p>The interesting part is the command running expect. Basically, it&rsquo;s expecting some kind of output which is outlined there. And has canned answers for those which it <code>send</code>s to the waiting command.</p>
<h4 id="to-util-or-not-to-util">To Util or Not To Util<a hidden class="anchor" aria-hidden="true" href="#to-util-or-not-to-util">#</a></h4>
<p>So, there are small tasks, like installing vim and wget and such which could warrant the existance of a <code>utils</code> task. Utils task would install the packages that are used as convinience and don&rsquo;t really relate to a singe task.</p>
<p>Yet I settled for the following. Each of my tasks has a dependency part. The given tasks takes care of all the packages it needs so they can be executed on their own as well as in unison.</p>
<p>This looks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># Install dependencies</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Install dependencies</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">apt</span>: <span style="color:#ae81ff">pkg=&#34;{{item}}&#34; state=installed</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">with_items</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#34;{{deps}}&#34;</span>
</span></span></code></pre></div><p>For which the <code>deps</code> variable is defined as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># Defined dependencies for letsencrypt task.</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">deps</span>: [<span style="color:#e6db74">&#39;git&#39;</span>, <span style="color:#e6db74">&#39;python-dev&#39;</span>, <span style="color:#e6db74">&#39;build-essential&#39;</span>, <span style="color:#e6db74">&#39;libpython-dev&#39;</span>, <span style="color:#e6db74">&#39;libpython2.7&#39;</span>, <span style="color:#e6db74">&#39;augeas-lenses&#39;</span>, <span style="color:#e6db74">&#39;libaugeas0&#39;</span>, <span style="color:#e6db74">&#39;libffi-dev&#39;</span>, <span style="color:#e6db74">&#39;libssl-dev&#39;</span>, <span style="color:#e6db74">&#39;python-virtualenv&#39;</span>, <span style="color:#e6db74">&#39;python3-virtualenv&#39;</span>, <span style="color:#e6db74">&#39;virtualenv&#39;</span>]
</span></span></code></pre></div><p>This is much cleaner. And if a task is no longer needed, it&rsquo;s dependencies will no longer be needed either in most of the cases.</p>
<h4 id="nagios-1">Nagios<a hidden class="anchor" aria-hidden="true" href="#nagios-1">#</a></h4>
<p>I&rsquo;m using Nagios 4 which is a real pain in the butt to install. Luckily, thanks to Ansiblei, I only ever had to figure it out once. Now I have a script for that. Installing Nagios demands several, smaller components to be installed. Thus our task uses import from outside tasks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Install Nagios</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">block</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">include</span>: <span style="color:#ae81ff">create_users.yml</span> <span style="color:#75715e"># creates the Nagios user</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">include</span>: <span style="color:#ae81ff">install_dependencies.yml</span> <span style="color:#75715e"># installs Nagios dependencies</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">include</span>: <span style="color:#ae81ff">core_install.yml</span> <span style="color:#75715e"># Installs Nagios Core</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">include</span>: <span style="color:#ae81ff">plugin_install.yml</span> <span style="color:#75715e"># Installs Nagios Plugins</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">include</span>: <span style="color:#ae81ff">create_htpasswd.yml</span> <span style="color:#75715e"># Creates a password for Nagios&#39; admin user</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">include</span>: <span style="color:#ae81ff">setup_custom_check.yml</span> <span style="color:#75715e"># Adds a custom check which is to check how many security updates are pending</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">when</span>: <span style="color:#ae81ff">st.stat.exists == False</span>
</span></span></code></pre></div><p>The <code>when</code> is a check for a variable created by a file check.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#f92672">stat</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/usr/local/nagios/bin/nagios</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">register</span>: <span style="color:#ae81ff">st</span>
</span></span></code></pre></div><p>It checks if Nagios is installed or not. If yes, skip.</p>
<p>I&rsquo;m not going to paste in here all the subtasks because that would be huge. You can check those out in the repository under Nagios.</p>
<h4 id="hugo">Hugo<a hidden class="anchor" aria-hidden="true" href="#hugo">#</a></h4>
<p>Hugo is easy to install. Its sole requirement is Go. To install hugo you simply run <code>apt-get install hugo</code>. Setting up the
site for me was just checking out the git repo and than execute hugo from the root folder like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>hugo server --bind<span style="color:#f92672">=</span>127.0.0.1 --port<span style="color:#f92672">=</span><span style="color:#ae81ff">8080</span> --baseUrl<span style="color:#f92672">=</span>https://example.com --appendPort<span style="color:#f92672">=</span>false --logFile hugo.log --verboseLog --verbose -v &amp;
</span></span></code></pre></div><h4 id="wiki-1">Wiki<a hidden class="anchor" aria-hidden="true" href="#wiki-1">#</a></h4>
<p>I used DokuWiki because it&rsquo;s a file based wiki so installation is basically just downloading the archive, extracting it and done. The only thing that&rsquo;s needed for it, is php-fpm to run it and a few php modules which I&rsquo;ll outline in the ansible playbook.</p>
<p>The VHOST file for DokuWiki is provided by them and looks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>server <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    server_name   <span style="color:#f92672">{{</span> wiki_server_name <span style="color:#f92672">}}</span>;
</span></span><span style="display:flex;"><span>    root <span style="color:#f92672">{{</span> wiki_root <span style="color:#f92672">}}</span>;
</span></span><span style="display:flex;"><span>    index index.php index.html index.htm;
</span></span><span style="display:flex;"><span>    client_max_body_size 2M;
</span></span><span style="display:flex;"><span>    client_body_buffer_size 128k;
</span></span><span style="display:flex;"><span>    location / <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        index doku.php;
</span></span><span style="display:flex;"><span>        try_files $uri $uri/ @dokuwiki;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    location @dokuwiki <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        rewrite ^/_media/<span style="color:#f92672">(</span>.*<span style="color:#f92672">)</span> /lib/exe/fetch.php?media<span style="color:#f92672">=</span>$1 last;
</span></span><span style="display:flex;"><span>        rewrite ^/_detail/<span style="color:#f92672">(</span>.*<span style="color:#f92672">)</span> /lib/exe/detail.php?media<span style="color:#f92672">=</span>$1 last;
</span></span><span style="display:flex;"><span>        rewrite ^/_export/<span style="color:#f92672">([</span>^/<span style="color:#f92672">]</span>+<span style="color:#f92672">)</span>/<span style="color:#f92672">(</span>.*<span style="color:#f92672">)</span> /doku.php?do<span style="color:#f92672">=</span>export_$1&amp;id<span style="color:#f92672">=</span>$2 last;
</span></span><span style="display:flex;"><span>        rewrite ^/<span style="color:#f92672">(</span>.*<span style="color:#f92672">)</span> /doku.php?id<span style="color:#f92672">=</span>$1 last;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    location ~ <span style="color:#ae81ff">\.</span>php$ <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        try_files $uri <span style="color:#f92672">=</span>404;
</span></span><span style="display:flex;"><span>        fastcgi_pass unix:/var/run/php5-fpm.sock;
</span></span><span style="display:flex;"><span>        fastcgi_index index.php;
</span></span><span style="display:flex;"><span>        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
</span></span><span style="display:flex;"><span>        include fastcgi_params;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    location ~ /<span style="color:#ae81ff">\.</span>ht <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        deny all;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    location ~ /<span style="color:#f92672">(</span>data|conf|bin|inc<span style="color:#f92672">)</span>/ <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        deny all;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h4 id="nginx">Nginx<a hidden class="anchor" aria-hidden="true" href="#nginx">#</a></h4>
<p>Nginx install is through apt as well. Here, however, there is a bit of magic going on with templates. The templates provide the
vhost files for the three hosts we will be running. This looks as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Install vhosts</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">block</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">template</span>: <span style="color:#ae81ff">src=01_example.com.j2 dest=/etc/nginx/vhosts/01_example.com</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">notify</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">Restart Nginx</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">template</span>: <span style="color:#ae81ff">src=02_wiki.example.com.j2 dest=/etc/nginx/vhosts/02_wiki_example.com</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">notify</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">Restart Nginx</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">template</span>: <span style="color:#ae81ff">src=03_nagios.example.com.j2 dest=/etc/nginx/vhosts/03_nagios.example.com</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">notify</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">Restart Nginx</span>
</span></span></code></pre></div><p>Now, you might be wondering what <code>notify</code> is? It&rsquo;s basically a handler that gets notified to restart nginx. The great part about
it is that it does this only once, even if it was called multiple times. The handler looks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Restart Nginx</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">service</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">state</span>: <span style="color:#ae81ff">restarted</span>
</span></span></code></pre></div><p>And lives under <code>handlers</code> sub-folder.</p>
<p>With this, Nginx is done and should be providing our sites under plain HTTP.</p>
<h4 id="letsencrypt">LetsEncrypt<a hidden class="anchor" aria-hidden="true" href="#letsencrypt">#</a></h4>
<p>Now comes the part where we enable HTTPS for all these three domains. Which is as follows:</p>
<ul>
<li>example.com</li>
<li>wiki.example.com</li>
<li>nagios.example.com</li>
</ul>
<p>This is actually quiet simple now-a-days with <code>certbot-auto</code>. In fact, it will insert the configurations we need all by itself.
The only thing for us to do is to specify what domains we have and what our challenge would be. Also, we have to pass in some
variables for <code>certbot-auto</code> to run in a non-interactive mode. This looks as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Generate Certificate for Domains</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">shell</span>: <span style="color:#ae81ff">./certbot-auto --authenticator standalone --installer nginx -d &#39;{{ domain_example }}&#39; -d &#39;{{ domain_wiki }}&#39; -d &#39;{{ domain_nagios }}&#39; --email example@gmail.com --agree-tos -n --no-verify-ssl --pre-hook &#34;sudo systemctl stop nginx&#34; --post-hook &#34;sudo systemctl start nginx&#34; --redirect</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">args</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">chdir</span>: <span style="color:#ae81ff">/opt/letsencrypt</span>
</span></span></code></pre></div><p>And that&rsquo;s that. The interesting and required part here is the <code>pre-hook</code> and <code>post-hook</code>. Without those it wouldn&rsquo;t work because
the ports that certbot is performing the challenge on would be taken already. This stops nginx, performs the challenge and
generates the certs, and starts nginx again. Also note <code>--redirect</code>. This will force HTTPS on the sites and disables plain HTTP.</p>
<p>If all went well our sites should contain information like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>    listen <span style="color:#ae81ff">443</span> ssl; <span style="color:#75715e"># managed by Certbot</span>
</span></span><span style="display:flex;"><span>    ssl_certificate /etc/letsencrypt/live/example.com-0001/fullchain.pem; <span style="color:#75715e"># managed by Certbot</span>
</span></span><span style="display:flex;"><span>    ssl_certificate_key /etc/letsencrypt/live/example.com-0001/privkey.pem; <span style="color:#75715e"># managed by Certbot</span>
</span></span><span style="display:flex;"><span>    include /etc/letsencrypt/options-ssl-nginx.conf; <span style="color:#75715e"># managed by Certbot</span>
</span></span><span style="display:flex;"><span>    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; <span style="color:#75715e"># managed by Certbot</span>
</span></span></code></pre></div><h3 id="test-run-using-vagrant">Test Run using Vagrant<a hidden class="anchor" aria-hidden="true" href="#test-run-using-vagrant">#</a></h3>
<p>If you don&rsquo;t want to run all this on a live server to test out, you can do either of these two things:</p>
<ul>
<li>Use a remote dedicated test server</li>
<li>Use a local virtual machine with Vagrant</li>
</ul>
<p>Here, I&rsquo;m giving you an option for the later.</p>
<p>It&rsquo;s possible for most of the things to be tested on a local Vagrant machine. Most of the time a Vagrant box is enough to test out installing things. A sample Vagrant file looks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span><span style="color:#75715e"># encoding: utf-8</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -*- mode: ruby -*-</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># vi: set ft=ruby :</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Box / OS</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">VAGRANT_BOX</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;ubuntu/xenial64&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">VM_NAME</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;ansible-practice&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">Vagrant</span><span style="color:#f92672">.</span>configure(<span style="color:#ae81ff">2</span>) <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>config<span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Vagrant box from Hashicorp</span>
</span></span><span style="display:flex;"><span>  config<span style="color:#f92672">.</span>vm<span style="color:#f92672">.</span>box <span style="color:#f92672">=</span> <span style="color:#66d9ef">VAGRANT_BOX</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Actual machine name</span>
</span></span><span style="display:flex;"><span>  config<span style="color:#f92672">.</span>vm<span style="color:#f92672">.</span>hostname <span style="color:#f92672">=</span> <span style="color:#66d9ef">VM_NAME</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Set VM name in Virtualbox</span>
</span></span><span style="display:flex;"><span>  config<span style="color:#f92672">.</span>vm<span style="color:#f92672">.</span>provider <span style="color:#e6db74">&#39;virtualbox&#39;</span> <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>v<span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>    v<span style="color:#f92672">.</span>name <span style="color:#f92672">=</span> <span style="color:#66d9ef">VM_NAME</span>
</span></span><span style="display:flex;"><span>    v<span style="color:#f92672">.</span>memory <span style="color:#f92672">=</span> <span style="color:#ae81ff">2048</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Ansible provision</span>
</span></span><span style="display:flex;"><span>  config<span style="color:#f92672">.</span>vm<span style="color:#f92672">.</span>provision <span style="color:#e6db74">&#39;ansible_local&#39;</span> <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>ansible<span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>    ansible<span style="color:#f92672">.</span>limit <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;all&#39;</span>
</span></span><span style="display:flex;"><span>    ansible<span style="color:#f92672">.</span>inventory_path <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;hosts&#39;</span>
</span></span><span style="display:flex;"><span>    ansible<span style="color:#f92672">.</span>playbook <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;local.yml&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>This interesting part here is the ansible provision section. It&rsquo;s running a version of Ansible that is called <code>ansible_local</code>. It&rsquo;s local, becuase it will be only on the VirtualBox. Meaning, you don&rsquo;t have to have Ansible installed to test it on a vagrant box. Neat, huh?</p>
<p>To test your playbook, simply run <code>vagrant up</code> and you should see the provisioning happening.</p>
<h2 id="room-for-improvement">Room for improvement<a hidden class="anchor" aria-hidden="true" href="#room-for-improvement">#</a></h2>
<p>And that should be all. Note that this setup isn&rsquo;t quiet enterprise ready. I would add the following things:</p>
<h3 id="tests-and-checks">Tests and Checks<a hidden class="anchor" aria-hidden="true" href="#tests-and-checks">#</a></h3>
<p>A ton of tests and checks if the commands that we are using are actually successful or not. If they aren&rsquo;t make them report the failure.</p>
<h3 id="multiple-domains">Multiple Domains<a hidden class="anchor" aria-hidden="true" href="#multiple-domains">#</a></h3>
<p>If you happen to have a ton of domain names to set up, this will not be the most effective way. Right now letsencrypt creates a
single certificate file for those three domains with <code>-d</code> and that&rsquo;s not what you want with potentially hundreds of domains.</p>
<p>In that case, have a list to go through with <code>with_items</code>. Note that you&rsquo;ll have to restart nginx on each line, because you don&rsquo;t
want one of them fail and stop the process entirely. Rather have a few fail but the rest still work.</p>
<h1 id="conclusion">Conclusion<a hidden class="anchor" aria-hidden="true" href="#conclusion">#</a></h1>
<p>That&rsquo;s it folks. Have fun setting up servers all over the place and enjoy the power of nginx and letsencrypt and not having to
worry about adding another server into the bunch.</p>
<p>Thank you for reading,
Gergely.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="https://skarlso.github.io/2018/02/06/go-budapest-meetup/">
    <span class="title">« Prev</span>
    <br>
    <span>Go Budapest Meetup</span>
  </a>
  <a class="next" href="https://skarlso.github.io/2018/01/13/furnace-massive-update/">
    <span class="title">Next »</span>
    <br>
    <span>Huge Furnace Update</span>
  </a>
</nav>

  </footer><div id="disqus_thread"></div>
<script type="application/javascript">
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "hannibalDisqus" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="https://skarlso.github.io">Ramblings of a cloud engineer</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
