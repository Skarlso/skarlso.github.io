<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Huge Furnace Update | Ramblings of a cloud engineer</title>
<meta name="keywords" content="">
<meta name="description" content="Intro
Hi folks.
In the past couple of months I&rsquo;ve been slowly updating Furnace.
There are three major changes that happened. Let&rsquo;s take a look at them, shall we?
Google Cloud Platform
Furnace now supports Google Cloud Platform (GCP). It provides the same API to handle GCP resource as with AWS. Namely, create, delete, status, update. I opted to leave out push because Google mostly works with git based repositories, meaning a push is literary just a push, than Google handles distributing the new code by itself.">
<meta name="author" content="hannibal">
<link rel="canonical" href="https://skarlso.github.io/2018/01/13/furnace-massive-update/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css" integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://skarlso.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://skarlso.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://skarlso.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://skarlso.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://skarlso.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://skarlso.github.io/2018/01/13/furnace-massive-update/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Huge Furnace Update">
<meta property="og:description" content="Intro
Hi folks.
In the past couple of months I&rsquo;ve been slowly updating Furnace.
There are three major changes that happened. Let&rsquo;s take a look at them, shall we?
Google Cloud Platform
Furnace now supports Google Cloud Platform (GCP). It provides the same API to handle GCP resource as with AWS. Namely, create, delete, status, update. I opted to leave out push because Google mostly works with git based repositories, meaning a push is literary just a push, than Google handles distributing the new code by itself.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://skarlso.github.io/2018/01/13/furnace-massive-update/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2018-01-13T22:34:00+01:00">
<meta property="article:modified_time" content="2018-01-13T22:34:00+01:00">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Huge Furnace Update">
<meta name="twitter:description" content="Intro
Hi folks.
In the past couple of months I&rsquo;ve been slowly updating Furnace.
There are three major changes that happened. Let&rsquo;s take a look at them, shall we?
Google Cloud Platform
Furnace now supports Google Cloud Platform (GCP). It provides the same API to handle GCP resource as with AWS. Namely, create, delete, status, update. I opted to leave out push because Google mostly works with git based repositories, meaning a push is literary just a push, than Google handles distributing the new code by itself.">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://skarlso.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Huge Furnace Update",
      "item": "https://skarlso.github.io/2018/01/13/furnace-massive-update/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Huge Furnace Update",
  "name": "Huge Furnace Update",
  "description": "Intro Hi folks.\nIn the past couple of months I\u0026rsquo;ve been slowly updating Furnace.\nThere are three major changes that happened. Let\u0026rsquo;s take a look at them, shall we?\nGoogle Cloud Platform Furnace now supports Google Cloud Platform (GCP). It provides the same API to handle GCP resource as with AWS. Namely, create, delete, status, update. I opted to leave out push because Google mostly works with git based repositories, meaning a push is literary just a push, than Google handles distributing the new code by itself.\n",
  "keywords": [
    
  ],
  "articleBody": "Intro Hi folks.\nIn the past couple of months I’ve been slowly updating Furnace.\nThere are three major changes that happened. Let’s take a look at them, shall we?\nGoogle Cloud Platform Furnace now supports Google Cloud Platform (GCP). It provides the same API to handle GCP resource as with AWS. Namely, create, delete, status, update. I opted to leave out push because Google mostly works with git based repositories, meaning a push is literary just a push, than Google handles distributing the new code by itself.\nAll the rest of the commands should work the same way as AWS.\nDeployment Manager GCP has a similar service to AWS CloudFormations called Deployment Manager. The documentation is fairly detailed with a Bookshelf example app to deploy. Code and Templates can be found in their Git repositroy here: Deployment Manager Git Repository.\nSetting up GCP As the README of Furnace outlines…\nPlease carefully read and follow the instruction outlined in this document: Google Cloud Getting Started. It will describe how to download and install the SDK and initialize cloud to a Project ID.\nTake special attention to these documents:\nInitializing GCloud Tools Authorizing Tools\nFurnace uses a Google Key-File to authenticate with your Google Cloud Account and Project. In the future, Furnace assumes these things are properly set up and in working order.\nTo initialize the client, it uses the following code:\nctx := context.Background() client, err := google.DefaultClient(ctx, dm.NdevCloudmanScope) The DefaultClient in turn, does the following:\n// FindDefaultCredentials searches for \"Application Default Credentials\". // // It looks for credentials in the following places, // preferring the first location found: // // 1. A JSON file whose path is specified by the // GOOGLE_APPLICATION_CREDENTIALS environment variable. // 2. A JSON file in a location known to the gcloud command-line tool. // On Windows, this is %APPDATA%/gcloud/application_default_credentials.json. // On other systems, $HOME/.config/gcloud/application_default_credentials.json. // 3. On Google App Engine it uses the appengine.AccessToken function. // 4. On Google Compute Engine and Google App Engine Managed VMs, it fetches // credentials from the metadata server. // (In this final case any provided scopes are ignored.) func FindDefaultCredentials(ctx context.Context, scope ...string) (*DefaultCredentials, error) { Take note on the order. This is how Google will authenticate your requests.\nRunning GCP Running gcp is largely similar to AWS. First, you create the necessary templates to your infrastructure. This is done via the Deployment Manager and it’s templating engine. The GCP templates are Python JINJA files. Examples are provided in the template directory. It’s a bit more complicated than the CloudFormation templates in that it uses outside templates plus schema files to configure dynamic details.\nIt’s all explained in these documents: Creating a Template Step-by-step and Creating a Basic Template.\nIt’s not trivial however. And using the API can also be confusing. The Google Code is just a generated Go code file using gRPC. But studying it may provide valuable insigth into how the API is structured. I’m also providing some basic samples that I gathered together and the readme does a bit more explaining on how to use them.\nYour First Stack Once you have everything set-up you’ll need a configuration file for Furnace. The usage is outlined more here YAML Configuration. The configuration file for GCP looks like this:\nmain: project_name: testplatform-1234 spinner: 1 gcp: template_name: google_template.yaml stack_name: test-stack Where project_name is the name you generate for your first billable Google Cloud Platform project. Template lives next to this yaml file and stack name must be DNS complient.\nOnce you have a project and a template setup, it’s as simple as calling ./furnace-gcp create or ./furnace-gcp create mycustomstack.\nDeleting Deleting happens with ./furnace-gcp delete or ./furnace-gcp delete mycustomstack. Luckily, as with AWS, this means that every resource created with the DeploymentManager will be deleted leaving no need for search and cleanup.\nProject Name vs. Project ID Unlike with AWS Google requires your stack name and project id to be DNS complient. This is most likely because all API calls and such contain that information.\nSeparate Binaries In order to mitigate some of Furnace’s size, I’m providing separate binaries for each service it supports.\nThe AWS binaries can be found in aws folder, and respectively, the Google Cloud Platform is located in gcp. Both are build-able by running make.\nIf you would like to run both with a single command, a top level make file is provided for your convinience. Just run make from the root. That will build all binaries. Later on, Digital Oceans will join the ranks.\nYAML Configuration Last but not least, Furnace now employs YAML files for configuration. However, it isn’t JUST using YAML files. It also employs a smart configuration pattern which works as follows.\nSince Furnace is a distributed binary file which could be running from any given location at any time. Because of that, at first I opted for a global configuration directory.\nNow, however, furnace uses a furnace configuration file named with the following pattern: .stackalias.furnace. Where stackname, or stack is the name of a custom stack you would like to create for a project. The content of this file is a single entry, which is the location, relative to this file, of the YAML configuration files for the given stack. For example:\nstacks/mydatabasestack.yaml This means, that in the directory called stacks there will a yaml configuration file for your database stack. The AWS config file looks like this:\nmain: stackname: FurnaceStack spinner: 1 aws: code_deploy_role: CodeDeployServiceRole region: us-east-1 enable_plugin_system: false template_name: cloud_formation.template app_name: furnace_app code_deploy: # Only needed in case S3 is used for code deployment code_deploy_s3_bucket: furnace_code_bucket # The name of the zip file in case it's on a bucket code_deploy_s3_key: furnace_deploy_app # In case a Git Repository is used for the application, define these two settings git_account: Skarlso/furnace-codedeploy-app git_revision: b89451234... The important part is the template_name. The template has to be next to this yaml file. To use this file, you simply call any of the AWS or GCP commands with an extra, optional parameter like this:\n./furnace-aws create mydatabase Note that mydatabase will translate to .mydatabase.furnace.\nThe intelligent part is, that this file could be placed anywhere in the project folder structure; because furnace, when looking for a config file, traverses backwards from the current execution directory up until /. Where root is not included in the search.\nConsider the following directory tree:\n├── docs │ ├── furnace-aws status mydatabase ├── stacks │ ├── mystack.template │ └── mystack.yaml └── .mydatabase.furnace\nYou are currently in your docs directory and would like to ask for the status of your database. You don’t have to move to the location of the setting file, just simply run the command from where you are. This only works if you are above the location of the file. If you would be below, furnace would say it can’t find the file. Because it only traverses upwards.\n.mydatabase.furnace here contains only a single entry stacks/mystack.yaml. And that’s it. This way, you could have multiple furnace files, for example a .database.furnace, .front-end.furnace and a .backend.furnace. All three would work in unison, and if want needs updating, simply run ./furnace-aws update backend. And done!\nClosing words As always, contributions are welcomed in the form of issues or pull requests. Questions anything, I tend to answer as soon as I can.\nAlways run the tests before submitting.\nThank you for reading. Gergely.\n",
  "wordCount" : "1225",
  "inLanguage": "en",
  "datePublished": "2018-01-13T22:34:00+01:00",
  "dateModified": "2018-01-13T22:34:00+01:00",
  "author":{
    "@type": "Person",
    "name": "hannibal"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://skarlso.github.io/2018/01/13/furnace-massive-update/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Ramblings of a cloud engineer",
    "logo": {
      "@type": "ImageObject",
      "url": "https://skarlso.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://skarlso.github.io/" accesskey="h" title="Ramblings of a cloud engineer (Alt + H)">Ramblings of a cloud engineer</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://skarlso.github.io/archives" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://skarlso.github.io/search/" title="Search">
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://skarlso.github.io/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://skarlso.github.io/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://skarlso.github.io/">Home</a>&nbsp;»&nbsp;<a href="https://skarlso.github.io/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      Huge Furnace Update
    </h1>
    <div class="post-meta"><span title='2018-01-13 22:34:00 +0100 +0100'>January 13, 2018</span>&nbsp;·&nbsp;6 min&nbsp;·&nbsp;hannibal

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#intro" aria-label="Intro">Intro</a><ul>
                        
                <li>
                    <a href="#google-cloud-platform" aria-label="Google Cloud Platform">Google Cloud Platform</a><ul>
                        
                <li>
                    <a href="#deployment-manager" aria-label="Deployment Manager">Deployment Manager</a></li>
                <li>
                    <a href="#setting-up-gcp" aria-label="Setting up GCP">Setting up GCP</a></li>
                <li>
                    <a href="#running-gcp" aria-label="Running GCP">Running GCP</a></li>
                <li>
                    <a href="#your-first-stack" aria-label="Your First Stack">Your First Stack</a></li>
                <li>
                    <a href="#deleting" aria-label="Deleting">Deleting</a></li>
                <li>
                    <a href="#project-name-vs-project-id" aria-label="Project Name vs. Project ID">Project Name vs. Project ID</a></li></ul>
                </li>
                <li>
                    <a href="#separate-binaries" aria-label="Separate Binaries">Separate Binaries</a></li>
                <li>
                    <a href="#yaml-configuration" aria-label="YAML Configuration">YAML Configuration</a></li></ul>
                </li>
                <li>
                    <a href="#closing-words" aria-label="Closing words">Closing words</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="intro">Intro<a hidden class="anchor" aria-hidden="true" href="#intro">#</a></h1>
<p>Hi folks.</p>
<p>In the past couple of months I&rsquo;ve been slowly updating <a href="https://github.com/Skarlso/go-furnace">Furnace</a>.</p>
<p>There are three major changes that happened. Let&rsquo;s take a look at them, shall we?</p>
<h2 id="google-cloud-platform">Google Cloud Platform<a hidden class="anchor" aria-hidden="true" href="#google-cloud-platform">#</a></h2>
<p>Furnace now supports <a href="https://cloud.google.com">Google Cloud Platform (GCP)</a>. It provides the same API to handle GCP resource as with AWS. Namely, <code>create</code>, <code>delete</code>, <code>status</code>, <code>update</code>. I opted to leave out <code>push</code> because Google mostly works with git based repositories, meaning a push is literary just a push, than Google handles distributing the new code by itself.</p>
<p>All the rest of the commands should work the same way as AWS.</p>
<h3 id="deployment-manager">Deployment Manager<a hidden class="anchor" aria-hidden="true" href="#deployment-manager">#</a></h3>
<p>GCP has a similar service to AWS CloudFormations called <a href="https://cloud.google.com/deployment-manager/docs/">Deployment Manager</a>. The documentation is fairly detailed with a Bookshelf example app to deploy. Code and Templates can be found in their Git repositroy here: <a href="https://github.com/GoogleCloudPlatform/deploymentmanager-samples">Deployment Manager Git Repository</a>.</p>
<h3 id="setting-up-gcp">Setting up GCP<a hidden class="anchor" aria-hidden="true" href="#setting-up-gcp">#</a></h3>
<p>As the README of Furnace outlines&hellip;</p>
<blockquote>
<p>Please carefully read and follow the instruction outlined in this document: <a href="https://cloud.google.com/sdk/#Quick_Start">Google Cloud Getting Started</a>. It will describe how to download and install the SDK and initialize cloud to a Project ID.</p>
</blockquote>
<blockquote>
<p>Take special attention to these documents:</p>
</blockquote>
<blockquote>
<p><a href="https://cloud.google.com/sdk/docs/initializing">Initializing GCloud Tools</a>
<a href="https://cloud.google.com/sdk/docs/authorizing">Authorizing Tools</a></p>
</blockquote>
<blockquote>
<p>Furnace uses a Google Key-File to authenticate with your Google Cloud Account and Project.
In the future, Furnace assumes these things are properly set up and in working order.</p>
</blockquote>
<p>To initialize the client, it uses the following code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#a6e22e">ctx</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>()
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">client</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">google</span>.<span style="color:#a6e22e">DefaultClient</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">dm</span>.<span style="color:#a6e22e">NdevCloudmanScope</span>)
</span></span></code></pre></div><p>The DefaultClient in turn, does the following:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// FindDefaultCredentials searches for &#34;Application Default Credentials&#34;.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// It looks for credentials in the following places,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// preferring the first location found:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   1. A JSON file whose path is specified by the
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//      GOOGLE_APPLICATION_CREDENTIALS environment variable.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   2. A JSON file in a location known to the gcloud command-line tool.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//      On Windows, this is %APPDATA%/gcloud/application_default_credentials.json.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//      On other systems, $HOME/.config/gcloud/application_default_credentials.json.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   3. On Google App Engine it uses the appengine.AccessToken function.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   4. On Google Compute Engine and Google App Engine Managed VMs, it fetches
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//      credentials from the metadata server.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//      (In this final case any provided scopes are ignored.)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">FindDefaultCredentials</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">scope</span> <span style="color:#f92672">...</span><span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">DefaultCredentials</span>, <span style="color:#66d9ef">error</span>) {
</span></span></code></pre></div><p>Take note on the order. This is how Google will authenticate your requests.</p>
<h3 id="running-gcp">Running GCP<a hidden class="anchor" aria-hidden="true" href="#running-gcp">#</a></h3>
<p>Running gcp is largely similar to AWS. First, you create the necessary templates to your infrastructure. This is done via the Deployment Manager and it&rsquo;s templating engine. The GCP templates are Python <a href="http://jinja.pocoo.org/">JINJA</a> files. Examples are provided in the <code>template</code> directory. It&rsquo;s a bit more complicated than the CloudFormation templates in that it uses outside templates plus schema files to configure dynamic details.</p>
<p>It&rsquo;s all explained in these documents: <a href="https://cloud.google.com/deployment-manager/docs/step-by-step-guide/create-a-template">Creating a Template Step-by-step</a> and <a href="https://cloud.google.com/deployment-manager/docs/configuration/templates/create-basic-template">Creating a Basic Template</a>.</p>
<p>It&rsquo;s not trivial however. And using the API can also be confusing. The Google Code is just a generated Go code file using gRPC. But studying it may provide valuable insigth into how the API is structured. I&rsquo;m also providing some basic samples that I gathered together and the readme does a bit more explaining on how to use them.</p>
<h3 id="your-first-stack">Your First Stack<a hidden class="anchor" aria-hidden="true" href="#your-first-stack">#</a></h3>
<p>Once you have everything set-up you&rsquo;ll need a configuration file for Furnace. The usage is outlined more here <a href="/2018/01/13/furnace-massive-update/#YAML-Configuration">YAML Configuration</a>. The configuration file for GCP looks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">main</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">project_name</span>: <span style="color:#ae81ff">testplatform-1234</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">spinner</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">gcp</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template_name</span>: <span style="color:#ae81ff">google_template.yaml</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">stack_name</span>: <span style="color:#ae81ff">test-stack</span>
</span></span></code></pre></div><p>Where <code>project_name</code> is the name you generate for your first billable Google Cloud Platform project. Template lives next to this yaml file and stack name must be DNS complient.</p>
<p>Once you have a project and a template setup, it&rsquo;s as simple as calling <code>./furnace-gcp create</code> or <code>./furnace-gcp create mycustomstack</code>.</p>
<h3 id="deleting">Deleting<a hidden class="anchor" aria-hidden="true" href="#deleting">#</a></h3>
<p>Deleting happens with <code>./furnace-gcp delete</code> or <code>./furnace-gcp delete mycustomstack</code>. Luckily, as with AWS, this means that every resource created with the DeploymentManager will be deleted leaving no need for search and cleanup.</p>
<h3 id="project-name-vs-project-id">Project Name vs. Project ID<a hidden class="anchor" aria-hidden="true" href="#project-name-vs-project-id">#</a></h3>
<p>Unlike with AWS Google requires your stack name and project id to be DNS complient. This is most likely because all API calls and such contain that information.</p>
<h2 id="separate-binaries">Separate Binaries<a hidden class="anchor" aria-hidden="true" href="#separate-binaries">#</a></h2>
<p>In order to mitigate some of Furnace&rsquo;s size, I&rsquo;m providing separate binaries for each service it supports.</p>
<p>The AWS binaries can be found in <code>aws</code> folder, and respectively, the Google Cloud Platform is located in <code>gcp</code>. Both are build-able by running <code>make</code>.</p>
<p>If you would like to run both with a single command, a top level make file is provided for your convinience. Just run <code>make</code> from the root. That will build all binaries. Later on, Digital Oceans will join the ranks.</p>
<h2 id="yaml-configuration">YAML Configuration<a hidden class="anchor" aria-hidden="true" href="#yaml-configuration">#</a></h2>
<p>Last but not least, Furnace now employs YAML files for configuration. However, it isn&rsquo;t JUST using YAML files. It also employs a smart configuration pattern which works as follows.</p>
<p>Since Furnace is a distributed binary file which could be running from any given location at any time. Because of that, at first I opted for a global configuration directory.</p>
<p>Now, however, furnace uses a furnace configuration file named with the following pattern: <code>.stackalias.furnace</code>. Where stackname, or stack is the name of a custom stack you would like to create for a project. The content of this file is a single entry, which is the location, relative to this file, of the YAML configuration files for the given stack. For example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>stacks/mydatabasestack.yaml
</span></span></code></pre></div><p>This means, that in the directory called <code>stacks</code> there will a yaml configuration file for your database stack. The AWS config file looks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-YAML" data-lang="YAML"><span style="display:flex;"><span><span style="color:#f92672">main</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">stackname</span>: <span style="color:#ae81ff">FurnaceStack</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">spinner</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">aws</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">code_deploy_role</span>: <span style="color:#ae81ff">CodeDeployServiceRole</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">region</span>: <span style="color:#ae81ff">us-east-1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">enable_plugin_system</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template_name</span>: <span style="color:#ae81ff">cloud_formation.template</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">app_name</span>: <span style="color:#ae81ff">furnace_app</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">code_deploy</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Only needed in case S3 is used for code deployment</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">code_deploy_s3_bucket</span>: <span style="color:#ae81ff">furnace_code_bucket</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># The name of the zip file in case it&#39;s on a bucket</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">code_deploy_s3_key</span>: <span style="color:#ae81ff">furnace_deploy_app</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># In case a Git Repository is used for the application, define these two settings</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">git_account</span>: <span style="color:#ae81ff">Skarlso/furnace-codedeploy-app</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">git_revision</span>: <span style="color:#ae81ff">b89451234...</span>
</span></span></code></pre></div><p>The important part is the <code>template_name</code>. The template has to be next to this yaml file. To use this file, you simply call any of the AWS or GCP commands with an extra, optional parameter like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./furnace-aws create mydatabase
</span></span></code></pre></div><p>Note that mydatabase will translate to <code>.mydatabase.furnace</code>.</p>
<p>The intelligent part is, that this file could be placed anywhere in the project folder structure; because furnace, when looking for a config file, traverses backwards from the current execution directory up until <code>/</code>. Where root is not included in the search.</p>
<p>Consider the following directory tree:</p>
<p>├── docs
│   ├── <code>furnace-aws status mydatabase</code>
├── stacks
│   ├── mystack.template
│   └── mystack.yaml
└── .mydatabase.furnace</p>
<p>You are currently in your <code>docs</code> directory and would like to ask for the status of your database. You don&rsquo;t have to move to the location of the setting file, just simply run the command from where you are. This only works if you are above the location of the file. If you would be below, furnace would say it can&rsquo;t find the file. Because it only traverses upwards.</p>
<p><code>.mydatabase.furnace</code> here contains only a single entry <code>stacks/mystack.yaml</code>. And that&rsquo;s it. This way, you could have multiple furnace files, for example a <code>.database.furnace</code>, <code>.front-end.furnace</code> and a <code>.backend.furnace</code>. All three would work in unison, and if want needs updating, simply run <code>./furnace-aws update backend</code>. And done!</p>
<h1 id="closing-words">Closing words<a hidden class="anchor" aria-hidden="true" href="#closing-words">#</a></h1>
<p>As always, contributions are welcomed in the form of issues or pull requests. Questions anything, I tend to answer as soon as I can.</p>
<p>Always run the tests before submitting.</p>
<p>Thank you for reading.
Gergely.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="https://skarlso.github.io/2018/01/23/nginx-certbot-ansible/">
    <span class="title">« Prev</span>
    <br>
    <span>Ansible &#43; Nginx &#43; LetsEncrypt &#43; Wiki &#43; Nagios</span>
  </a>
  <a class="next" href="https://skarlso.github.io/2017/12/04/commit-build-deploy/">
    <span class="title">Next »</span>
    <br>
    <span>Commit-Build-Deploy With AWS CodeBuild and Lambda</span>
  </a>
</nav>

  </footer><div id="disqus_thread"></div>
<script>
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "hannibalDisqus" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="https://skarlso.github.io/">Ramblings of a cloud engineer</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
