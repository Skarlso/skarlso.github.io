<!DOCTYPE html>
<html lang="">
    <head>
    <meta charset="UTF-8" />

    <meta name="generator" content="Hugo 0.83.1" /><meta name="theme-color" content="" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <meta name="format-detection" content="telephone=no, date=no, address=no, email=no" />
    
    <meta http-equiv="Cache-Control" content="no-transform" />
    
    <meta http-equiv="Cache-Control" content="no-siteapp" />

    <title>Huge Furnace Update | Ramblings of a cloud engineer</title>

    <link rel="stylesheet" href="/css/meme.min.css" />

    
    
        <script src="/js/meme.min.js"></script>

    

    

    <meta name="author" content="hannibal" /><meta name="description" content="Intro Hi folks.
In the past couple of months I’ve been slowly updating Furnace.
There are three major changes that happened. Let’s take a look at them, shall we?
Google Cloud Platform Furnace now supports Google Cloud Platform (GCP). It provides the same API to handle GCP resource as with AWS. Namely, create, delete, status, update. I opted to leave out push because Google mostly works with git based repositories, meaning a push is literary just a push, than Google handles distributing the new code by itself." />

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="" />
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-title" content="Ramblings of a cloud engineer" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="application-name" content="Ramblings of a cloud engineer" />
    <meta name="msapplication-starturl" content="../../../../" />
    <meta name="msapplication-TileColor" content="" />
    <meta name="msapplication-TileImage" content="../../../../icons/mstile-150x150.png" />
    <link rel="manifest" href="/manifest.json" />

    
    

    
    <link rel="canonical" href="https://skarlso.github.io/2018/01/13/furnace-massive-update/" />
    

    
    
        <link rel="preconnect" href="https://www.google-analytics.com" crossorigin />

        


    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-69463020-2"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-69463020-2');
    </script>




    
    

    
</head>

    <body>
        <div class="container">
            



            
                
                
                
            
            
    <main class="main single" id="main">
    <div class="main-inner">

        

        <article class="content post h-entry" data-align="default" data-type="posts" data-layout="post">

            <h1 class="post-title p-name">Huge Furnace Update</h1>

            

            

            

            <div class="post-body e-content">
                <h1 id="intro">Intro</h1>
<p>Hi folks.</p>
<p>In the past couple of months I&rsquo;ve been slowly updating <a href="https://github.com/Skarlso/go-furnace">Furnace</a>.</p>
<p>There are three major changes that happened. Let&rsquo;s take a look at them, shall we?</p>
<h2 id="google-cloud-platform">Google Cloud Platform</h2>
<p>Furnace now supports <a href="https://cloud.google.com">Google Cloud Platform (GCP)</a>. It provides the same API to handle GCP resource as with AWS. Namely, <code>create</code>, <code>delete</code>, <code>status</code>, <code>update</code>. I opted to leave out <code>push</code> because Google mostly works with git based repositories, meaning a push is literary just a push, than Google handles distributing the new code by itself.</p>
<p>All the rest of the commands should work the same way as AWS.</p>
<h3 id="deployment-manager">Deployment Manager</h3>
<p>GCP has a similar service to AWS CloudFormations called <a href="https://cloud.google.com/deployment-manager/docs/">Deployment Manager</a>. The documentation is fairly detailed with a Bookshelf example app to deploy. Code and Templates can be found in their Git repositroy here: <a href="https://github.com/GoogleCloudPlatform/deploymentmanager-samples">Deployment Manager Git Repository</a>.</p>
<h3 id="setting-up-gcp">Setting up GCP</h3>
<p>As the README of Furnace outlines&hellip;</p>
<blockquote>
<p>Please carefully read and follow the instruction outlined in this document: <a href="https://cloud.google.com/sdk/#Quick_Start">Google Cloud Getting Started</a>. It will describe how to download and install the SDK and initialize cloud to a Project ID.</p>
</blockquote>
<blockquote>
<p>Take special attention to these documents:</p>
</blockquote>
<blockquote>
<p><a href="https://cloud.google.com/sdk/docs/initializing">Initializing GCloud Tools</a>
<a href="https://cloud.google.com/sdk/docs/authorizing">Authorizing Tools</a></p>
</blockquote>
<blockquote>
<p>Furnace uses a Google Key-File to authenticate with your Google Cloud Account and Project.
In the future, Furnace assumes these things are properly set up and in working order.</p>
</blockquote>
<p>To initialize the client, it uses the following code:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">  <span style="color:#a6e22e">ctx</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>()
  <span style="color:#a6e22e">client</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">google</span>.<span style="color:#a6e22e">DefaultClient</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">dm</span>.<span style="color:#a6e22e">NdevCloudmanScope</span>)
</code></pre></div><p>The DefaultClient in turn, does the following:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// FindDefaultCredentials searches for &#34;Application Default Credentials&#34;.
</span><span style="color:#75715e">//
</span><span style="color:#75715e">// It looks for credentials in the following places,
</span><span style="color:#75715e">// preferring the first location found:
</span><span style="color:#75715e">//
</span><span style="color:#75715e">//   1. A JSON file whose path is specified by the
</span><span style="color:#75715e">//      GOOGLE_APPLICATION_CREDENTIALS environment variable.
</span><span style="color:#75715e">//   2. A JSON file in a location known to the gcloud command-line tool.
</span><span style="color:#75715e">//      On Windows, this is %APPDATA%/gcloud/application_default_credentials.json.
</span><span style="color:#75715e">//      On other systems, $HOME/.config/gcloud/application_default_credentials.json.
</span><span style="color:#75715e">//   3. On Google App Engine it uses the appengine.AccessToken function.
</span><span style="color:#75715e">//   4. On Google Compute Engine and Google App Engine Managed VMs, it fetches
</span><span style="color:#75715e">//      credentials from the metadata server.
</span><span style="color:#75715e">//      (In this final case any provided scopes are ignored.)
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">FindDefaultCredentials</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">scope</span> <span style="color:#f92672">...</span><span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">DefaultCredentials</span>, <span style="color:#66d9ef">error</span>) {
</code></pre></div><p>Take note on the order. This is how Google will authenticate your requests.</p>
<h3 id="running-gcp">Running GCP</h3>
<p>Running gcp is largely similar to AWS. First, you create the necessary templates to your infrastructure. This is done via the Deployment Manager and it&rsquo;s templating engine. The GCP templates are Python <a href="http://jinja.pocoo.org/">JINJA</a> files. Examples are provided in the <code>template</code> directory. It&rsquo;s a bit more complicated than the CloudFormation templates in that it uses outside templates plus schema files to configure dynamic details.</p>
<p>It&rsquo;s all explained in these documents: <a href="https://cloud.google.com/deployment-manager/docs/step-by-step-guide/create-a-template">Creating a Template Step-by-step</a> and <a href="https://cloud.google.com/deployment-manager/docs/configuration/templates/create-basic-template">Creating a Basic Template</a>.</p>
<p>It&rsquo;s not trivial however. And using the API can also be confusing. The Google Code is just a generated Go code file using gRPC. But studying it may provide valuable insigth into how the API is structured. I&rsquo;m also providing some basic samples that I gathered together and the readme does a bit more explaining on how to use them.</p>
<h3 id="your-first-stack">Your First Stack</h3>
<p>Once you have everything set-up you&rsquo;ll need a configuration file for Furnace. The usage is outlined more here <a href="#YAML-Configuration">YAML Configuration</a>. The configuration file for GCP looks like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">main</span>:
  <span style="color:#f92672">project_name</span>: <span style="color:#ae81ff">testplatform-1234</span>
  <span style="color:#f92672">spinner</span>: <span style="color:#ae81ff">1</span>
<span style="color:#f92672">gcp</span>:
  <span style="color:#f92672">template_name</span>: <span style="color:#ae81ff">google_template.yaml</span>
  <span style="color:#f92672">stack_name</span>: <span style="color:#ae81ff">test-stack</span>

</code></pre></div><p>Where <code>project_name</code> is the name you generate for your first billable Google Cloud Platform project. Template lives next to this yaml file and stack name must be DNS complient.</p>
<p>Once you have a project and a template setup, it&rsquo;s as simple as calling <code>./furnace-gcp create</code> or <code>./furnace-gcp create mycustomstack</code>.</p>
<h3 id="deleting">Deleting</h3>
<p>Deleting happens with <code>./furnace-gcp delete</code> or <code>./furnace-gcp delete mycustomstack</code>. Luckily, as with AWS, this means that every resource created with the DeploymentManager will be deleted leaving no need for search and cleanup.</p>
<h3 id="project-name-vs-project-id">Project Name vs. Project ID</h3>
<p>Unlike with AWS Google requires your stack name and project id to be DNS complient. This is most likely because all API calls and such contain that information.</p>
<h2 id="separate-binaries">Separate Binaries</h2>
<p>In order to mitigate some of Furnace&rsquo;s size, I&rsquo;m providing separate binaries for each service it supports.</p>
<p>The AWS binaries can be found in <code>aws</code> folder, and respectively, the Google Cloud Platform is located in <code>gcp</code>. Both are build-able by running <code>make</code>.</p>
<p>If you would like to run both with a single command, a top level make file is provided for your convinience. Just run <code>make</code> from the root. That will build all binaries. Later on, Digital Oceans will join the ranks.</p>
<h2 id="yaml-configuration">YAML Configuration</h2>
<p>Last but not least, Furnace now employs YAML files for configuration. However, it isn&rsquo;t JUST using YAML files. It also employs a smart configuration pattern which works as follows.</p>
<p>Since Furnace is a distributed binary file which could be running from any given location at any time. Because of that, at first I opted for a global configuration directory.</p>
<p>Now, however, furnace uses a furnace configuration file named with the following pattern: <code>.stackalias.furnace</code>. Where stackname, or stack is the name of a custom stack you would like to create for a project. The content of this file is a single entry, which is the location, relative to this file, of the YAML configuration files for the given stack. For example:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">stacks/mydatabasestack.yaml
</code></pre></div><p>This means, that in the directory called <code>stacks</code> there will a yaml configuration file for your database stack. The AWS config file looks like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-YAML" data-lang="YAML"><span style="color:#f92672">main</span>:
  <span style="color:#f92672">stackname</span>: <span style="color:#ae81ff">FurnaceStack</span>
  <span style="color:#f92672">spinner</span>: <span style="color:#ae81ff">1</span>
<span style="color:#f92672">aws</span>:
  <span style="color:#f92672">code_deploy_role</span>: <span style="color:#ae81ff">CodeDeployServiceRole</span>
  <span style="color:#f92672">region</span>: <span style="color:#ae81ff">us-east-1</span>
  <span style="color:#f92672">enable_plugin_system</span>: <span style="color:#66d9ef">false</span>
  <span style="color:#f92672">template_name</span>: <span style="color:#ae81ff">cloud_formation.template</span>
  <span style="color:#f92672">app_name</span>: <span style="color:#ae81ff">furnace_app</span>
  <span style="color:#f92672">code_deploy</span>:
    <span style="color:#75715e"># Only needed in case S3 is used for code deployment</span>
    <span style="color:#f92672">code_deploy_s3_bucket</span>: <span style="color:#ae81ff">furnace_code_bucket</span>
    <span style="color:#75715e"># The name of the zip file in case it&#39;s on a bucket</span>
    <span style="color:#f92672">code_deploy_s3_key</span>: <span style="color:#ae81ff">furnace_deploy_app</span>
    <span style="color:#75715e"># In case a Git Repository is used for the application, define these two settings</span>
    <span style="color:#f92672">git_account</span>: <span style="color:#ae81ff">Skarlso/furnace-codedeploy-app</span>
    <span style="color:#f92672">git_revision</span>: <span style="color:#ae81ff">b89451234...</span>

</code></pre></div><p>The important part is the <code>template_name</code>. The template has to be next to this yaml file. To use this file, you simply call any of the AWS or GCP commands with an extra, optional parameter like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">./furnace-aws create mydatabase
</code></pre></div><p>Note that mydatabase will translate to <code>.mydatabase.furnace</code>.</p>
<p>The intelligent part is, that this file could be placed anywhere in the project folder structure; because furnace, when looking for a config file, traverses backwards from the current execution directory up until <code>/</code>. Where root is not included in the search.</p>
<p>Consider the following directory tree:</p>
<p>├── docs<br>
│   ├── <code>furnace-aws status mydatabase</code><br>
├── stacks<br>
│   ├── mystack.template<br>
│   └── mystack.yaml<br>
└── .mydatabase.furnace</p>
<p>You are currently in your <code>docs</code> directory and would like to ask for the status of your database. You don&rsquo;t have to move to the location of the setting file, just simply run the command from where you are. This only works if you are above the location of the file. If you would be below, furnace would say it can&rsquo;t find the file. Because it only traverses upwards.</p>
<p><code>.mydatabase.furnace</code> here contains only a single entry <code>stacks/mystack.yaml</code>. And that&rsquo;s it. This way, you could have multiple furnace files, for example a <code>.database.furnace</code>, <code>.front-end.furnace</code> and a <code>.backend.furnace</code>. All three would work in unison, and if want needs updating, simply run <code>./furnace-aws update backend</code>. And done!</p>
<h1 id="closing-words">Closing words</h1>
<p>As always, contributions are welcomed in the form of issues or pull requests. Questions anything, I tend to answer as soon as I can.</p>
<p>Always run the tests before submitting.</p>
<p>Thank you for reading.
Gergely.</p>

            </div>

            


        </article>

        

        


        


        


        


        


        


        


        


        


    </div>
</main>


            

            

        </div>
        

        















    </body>
</html>
